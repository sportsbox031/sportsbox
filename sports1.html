<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스포츠박스 - 경기도체육회</title>
    
    <link rel="icon" href="https://static.readdy.ai/image/416007a89256a2717806f7776e859886/110ce5261818cd69133e46ef8c6b097a.png" type="image/png">

    <!-- 스타일시트 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Tailwind 설정 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0066CC',
                        secondary: '#FF6B00'
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': '4px',
                        DEFAULT: '8px',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px',
                        '3xl': '32px',
                        'full': '9999px',
                        'button': '8px'
                    }
                }
            }
        }
    </script>

<style>
    /* 홈화면 스타일 */
    :where([class^="ri-"])::before { content: "\f3c2"; }
    body { font-family: 'Noto Sans KR', sans-serif; }
    .search-input:focus { outline: none; }
    .program-card:hover .program-detail {
        opacity: 1;
        transform: translateY(0);
    }

    /* 캘린더 기본 스타일 */
    .calendar-day:hover {
        background-color: rgba(59, 130, 246, 0.1);
        transition: all 0.3s;
    }

    .selected {
        background-color: #3B82F6 !important;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
    }

    /* 모달 스타일 */
    .modal {
    display: none; /* !important 제거 */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    overflow-y: auto;
    padding: 2rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex; /* !important 제거 */
    opacity: 1;
    visibility: visible;
}

/* 모달 내용 컨테이너 (모든 모달에 적용) */
.modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 1rem;
    width: 100%;
    max-width: 32rem;
    margin: 2rem auto;
    position: relative;
    z-index: 10001; /* 높은 z-index로 통일 */
    max-height: 80vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

/* 공지사항 모달 특별 스타일 (공지사항 모달에만 적용) */
#noticeDetailModal {
    z-index: 10000 ; /* 모달 중에서 가장 높게 설정 */
    background-color: rgba(0, 0, 0, 0.7) ; /* 더 진한 배경색 */
    padding: 0 ;
}

/* 이 부분 추가: 공지사항 모달이 show 클래스를 가질 때 */
#noticeDetailModal.show {
    display: flex ;
    opacity: 1 ;
    visibility: visible ;
}

#noticeDetailModal:not(.hidden) {
    display: flex ;
}

/* 공지사항 모달 내부 레이아웃 */
#noticeDetailModal > div {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* 공지사항 모달 내용물 */
#noticeDetailModal .bg-white {
    max-width: 32rem;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    border-radius: 1rem;
    padding: 2rem;
    width: 100%;
    margin: 2rem;
}

    /* 캘린더 스타일 */
    .calendar-day {
        border-radius: 0.75rem;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }

    .calendar-day.booked {
        background-color: #FEF3C7;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(251, 191, 36, 0.1);
    }

    .calendar-day.full {
        background-color: #FEE2E2 !important;
        cursor: not-allowed !important;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.1) !important;
    }

    .calendar-day.past {
        background-color: #F3F4F6;
        cursor: not-allowed;
        color: #9CA3AF;
    }

    .calendar-day.blocked {
        background-color: #4B5563 !important;
        color: white !important;
        cursor: not-allowed !important;
        box-shadow: 0 2px 4px rgba(75, 85, 99, 0.2) !important;
    }

    .calendar-day.partially-blocked {
        background-color: #F97316 !important;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(249, 115, 22, 0.2);
    }

    /* 관리자 캘린더 특수 스타일 */
    #adminCalendar .calendar-day.blocked,
    #adminCalendar .calendar-day.partially-blocked {
        cursor: pointer;
    }

/* 공지사항 디자인 개선 */
.notice-item {
  transition: all 0.3s ease;
  border-radius: 8px;
  padding: 16px;
}
.notice-item.important {
  background-color: #fff3e0;
  border-left: 4px solid #ff5722;
}

.notice-item:hover {
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  transform: translateY(-2px);
  background-color: rgba(240, 240, 250, 0.7);
}

.line-clamp-1 {
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.line-clamp-3 {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.notice-tabs h3 {
  position: relative;
  transition: all 0.3s ease;
}

.notice-tabs h3:hover {
  color: #3B82F6;
}

.notice-item h4 {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

    /* 로딩 인디케이터 */
    .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(4px);
    }

    .loading.show {
        display: flex;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3B82F6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        box-shadow: 0 4px 6px rgba(59, 130, 246, 0.1);
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* 기존 로딩 스타일 하단에 추가 */
    .upload-progress-text {
        font-size: 16px;
        margin-top: 15px;
        color: white;
        text-align: center;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* 스크롤바 스타일 */
    .overflow-y-auto {
    scrollbar-width: thin;
    scrollbar-color: #CBD5E0 #EDF2F7;
}

.overflow-y-auto::-webkit-scrollbar {
    width: 6px;
}

.overflow-y-auto::-webkit-scrollbar-track {
    background: #EDF2F7;
    border-radius: 3px;
}

.overflow-y-auto::-webkit-scrollbar-thumb {
    background-color: #CBD5E0;
    border-radius: 3px;
    border: 2px solid #EDF2F7;
}

.overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background-color: #A0AEC0;
}

    /* 폼 입력 필드 포커스 스타일 */
    .focus\:ring-2:focus {
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }

    /* 지역 정보 뱃지 스타일 */
    .region-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .region-badge.south {
        background-color: #EBF5FF;
        color: #1E40AF;
    }

    .region-badge.north {
        background-color: #F0FDF4;
        color: #166534;
    }

    /* 폼 입력 필드 공통 스타일 */
    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #E5E7EB;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        border-color: #3B82F6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
        outline: none;
    }

    .form-input.error {
        border-color: #EF4444;
    }

    /* 폼 레이블 스타일 */
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #374151;
    }

    /* 필수 입력 필드 표시 */
    .required::after {
        content: "*";
        color: #EF4444;
        margin-left: 0.25rem;
    }

    /* 유효성 검사 메시지 스타일 */
    .validation-message {
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .validation-message.error {
        color: #EF4444;
    }

    .validation-message.success {
        color: #10B981;
    }
</style>
</head>

<body class="bg-white">

    <!-- 로딩 인디케이터 -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- 알림 메시지 -->
    <div id="alert" class="fixed top-4 right-4 max-w-sm bg-white rounded-lg shadow-lg p-4 hidden z-50">
        <div class="flex items-center">
            <div id="alertIcon" class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-500"></i>
            </div>
            <div class="ml-3">
                <p id="alertMessage" class="text-sm text-gray-700"></p>
            </div>
            <button onclick="hideAlert()" class="ml-4">
                <i class="fas fa-times text-gray-400 hover:text-gray-500"></i>
            </button>
        </div>
    </div>

    <!-- 메인 컨테이너 -->
    <div id="mainContainer">
        <!-- 홈화면 -->
        <div id="homeScreen">
            <header class="fixed w-full bg-white shadow-sm z-50">
                <div class="container mx-auto px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <img src="https://static.readdy.ai/image/416007a89256a2717806f7776e859886/110ce5261818cd69133e46ef8c6b097a.png" 
                                 alt="경기도체육회 로고" class="h-10">
                            <div class="text-2xl font-bold text-primary">스포츠박스</div>
                        </div>
                        <nav class="hidden md:flex items-center space-x-8">
                            <a href="#intro" class="text-gray-700 hover:text-primary py-2">사업소개</a>
                            <a href="#programs" class="text-gray-700 hover:text-primary py-2">운영프로그램</a>
                            <a href="#process" class="text-gray-700 hover:text-primary py-2">신청절차</a>
                            <a href="#notices" class="text-gray-700 hover:text-primary py-2">공지사항</a>
                            <a href="javascript:showInquiryPage()" class="text-gray-700 hover:text-primary py-2">문의사항</a>
                            <button onclick="showLoginScreen()" 
                                class="bg-primary text-white px-4 py-2 !rounded-button hover:bg-primary/90">
                                회원가입/로그인
                            </button>
                        </nav>
                    </div>
                </div>
            </header>

            <main class="pt-20">
                <!-- 메인 비주얼 섹션 -->
                <section class="relative h-[600px] bg-cover bg-no-repeat" 
    style="background-image: url('https://raw.githubusercontent.com/sportsbox031/sports/main/메인사진2.png'); 
           background-position: center 20%;
           background-size: cover;">
    <div class="absolute inset-0 bg-black/30"></div>
    <div class="container mx-auto px-6 relative h-full flex items-center">
        <div class="max-w-2xl">
            <h1 class="text-6xl font-bold mb-6 text-white drop-shadow-lg">SPORTS BOX</h1>
            <h2 class="text-4xl font-bold mb-6 text-primary drop-shadow">모두를 위한 스포츠</h2>
            <p class="text-xl mb-8 text-white drop-shadow-lg">경기도체육회 스포츠박스가 여러분의 건강한 생활을 지원합니다</p>
            <button onclick="showLoginScreen()" 
                class="!rounded-button bg-primary text-white px-8 py-3 text-lg hover:bg-primary/90 inline-block">
                예약하기
            </button>
        </div>
    </div>
</section>

                <!-- 사업소개 및 공지사항 섹션 -->
<section id="intro" class="py-20 bg-gray-50">
    <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            <!-- 왼쪽: 사업소개 -->
            <div>
                <h2 class="text-3xl font-bold mb-8">사업소개</h2>
                <div class="mb-6">
                    <img src="https://static.readdy.ai/image/416007a89256a2717806f7776e859886/37e4760851bd5a23c2838ccd027fd4f3.png"
                        class="w-full h-auto rounded-lg shadow-lg" alt="스포츠박스 활동">
                </div>
                <div>
                    <h3 class="text-2xl font-bold mb-4">찾아가는 스포츠 프로그램</h3>
                    <p class="text-gray-600 leading-relaxed mb-6">
                        스포츠박스는 경기도민의 건강한 생활을 위해 찾아가는 스포츠 프로그램을 운영합니다.
                        스포츠 취약계층을 위한 맞춤형 프로그램과 다양한 체험 기회를 제공하여
                        모든 도민이 스포츠를 즐길 수 있도록 지원합니다.
                    </p>
                    <div class="flex space-x-4">
                        <div class="flex items-center space-x-2">
                            <i class="ri-user-heart-line text-primary text-xl"></i>
                            <span>취약계층 지원</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="ri-community-line text-primary text-xl"></i>
                            <span>생활체육 활성화</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 오른쪽: 공지사항 -->
            <div id="notices">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">공지사항</h2>
                    <div id="noticeActions" class="hidden"> <!-- 관리자 로그인 시 보임 -->
                        <button onclick="showNoticeWriteModal()" 
                            class="bg-primary text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                            <i class="fas fa-pen"></i>
                            <span>글쓰기</span>
                        </button>
                    </div>
                </div>
                <div id="homeNoticesList" class="bg-white rounded-lg shadow-lg p-6 max-h-[500px] overflow-y-auto">
                    <!-- 공지사항이 여기에 동적으로 추가됨 -->
                </div>
            </div>
        </div>
    </div>
</section>
            

<!-- 공지사항 작성 모달 -->
<div id="noticeWriteModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-2xl m-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">공지사항 작성</h2>
            <button onclick="closeNoticeWriteModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="noticeWriteForm" class="space-y-4" enctype="multipart/form-data">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">제목</label>
                <input type="text" id="noticeTitle" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">내용</label>
                <textarea id="noticeContent" required rows="6"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
            </div>
            <!-- 첨부파일 필드 수정 -->
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">첨부파일</label>
                <div class="flex items-center space-x-2">
                    <input type="file" id="noticeFile" name="attachment" 
                        class="hidden" 
                        accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.hwp,.jpg,.jpeg,.png,.gif">
                    <button type="button" onclick="document.getElementById('noticeFile').click()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
                        파일 선택
                    </button>
                    <span id="selectedFileName" class="text-sm text-gray-600">선택된 파일 없음</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">최대 파일 크기: 10MB (PDF, 워드, 엑셀, 파워포인트, 한글, 이미지 파일)</p>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">공개 범위</label>
                <select id="noticeRegion" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="">선택해주세요</option>
                    <option value="all">전체 공개</option>
                    <option value="south">남부 지역만</option>
                    <option value="north">북부 지역만</option>
                </select>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="noticeImportant" class="w-4 h-4 text-blue-600 rounded">
                <label for="noticeImportant" class="ml-2 text-gray-700 text-sm font-bold">중요 공지</label>
            </div>
            <button type="submit" 
                class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition duration-200">
                등록하기
            </button>
        </form>
    </div>
</div>

                <!-- 운영프로그램 섹션 -->
                <section id="programs" class="py-20">
                    <div class="container mx-auto px-6">
                        <h2 class="text-3xl font-bold text-center mb-16">운영프로그램</h2>
                        <div class="grid md:grid-cols-3 gap-8">
                            <div class="program-card relative rounded-lg overflow-hidden shadow-lg">
                                <img src="https://static.readdy.ai/image/416007a89256a2717806f7776e859886/32c46d527cf6d2a7c9d564083dfe5195.png"
                                    class="w-full h-[300px] object-cover" alt="스포츠교실">
                                <div class="p-6 bg-white">
                                    <h3 class="text-xl font-bold mb-3">스포츠교실</h3>
                                    <p class="text-gray-600 mb-4">전문 강사진이 직접 찾아가는 뉴스포츠 프로그램</p>
                                    <a href="https://www.youtube.com/watch?v=ui3qOANOOTI" target="_blank" 
                                        class="inline-block bg-primary text-white px-4 py-2 !rounded-button hover:bg-primary/90">
                                        자세히보기
                                    </a>
                                </div>
                            </div>
                            <div class="program-card relative rounded-lg overflow-hidden shadow-lg">
                                <img src="https://static.readdy.ai/image/416007a89256a2717806f7776e859886/44959af536d5400000e12357a5586b8f.png"
                                    class="w-full h-[300px] object-cover" alt="스포츠체험존">
                                <div class="p-6 bg-white">
                                    <h3 class="text-xl font-bold mb-3">스포츠체험존</h3>
                                    <p class="text-gray-600 mb-4">경기도 내 스포츠대회 및 지자체 축제 연계 체험존 운영</p>
                                    <a href="https://www.youtube.com/watch?v=cdOh5nLmQ-o" target="_blank" 
                                        class="inline-block bg-primary text-white px-4 py-2 !rounded-button hover:bg-primary/90">
                                        자세히보기
                                    </a>
                                </div>
                            </div>
                            <div class="program-card relative rounded-lg overflow-hidden shadow-lg">
                                <img src="https://static.readdy.ai/image/416007a89256a2717806f7776e859886/ca135fc96b572c92d6c08bfcc5782da7.png"
                                    class="w-full h-[300px] object-cover" alt="스포츠이벤트">
                                <div class="p-6 bg-white">
                                    <h3 class="text-xl font-bold mb-3">스포츠이벤트</h3>
                                    <p class="text-gray-600 mb-4">수상레저스포츠, 스키교실 등 특별 프로그램 운영</p>
                                    <a href="https://www.youtube.com/watch?v=4nyB-iATP5k" target="_blank" 
                                        class="inline-block bg-primary text-white px-4 py-2 !rounded-button hover:bg-primary/90">
                                        자세히보기
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 신청절차 섹션 -->
                <section id="process" class="py-20 bg-gray-50">
                    <div class="container mx-auto px-6">
                        <h2 class="text-3xl font-bold text-center mb-16">신청절차</h2>
                        <div class="relative">
                            <div class="absolute left-0 top-1/2 w-full h-1 bg-gray-200 -translate-y-1/2"></div>
                            <div class="relative grid md:grid-cols-3 gap-8">
                                <div class="bg-white rounded-xl p-8 shadow-lg relative z-10">
                                    <div class="w-12 h-12 bg-primary text-white rounded-full flex items-center justify-center text-xl font-bold mb-6 mx-auto">1</div>
                                    <h3 class="text-xl font-bold text-center mb-4">수요처등록 신청</h3>
                                    <p class="text-gray-600 text-center mb-6">신청서를 다운로드하여 작성 후 제출해주세요</p>
                                    <div class="flex justify-center">
                                        <div class="flex justify-center">
                                            <button onclick="downloadApplication()" 
                                                class="flex items-center justify-center space-x-2 bg-primary text-white px-6 py-3 !rounded-button hover:bg-primary/90">
                                                <i class="ri-download-line"></i>
                                                <span>신청서 다운로드</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-white rounded-xl p-8 shadow-lg relative z-10">
                                    <div class="w-12 h-12 bg-primary text-white rounded-full flex items-center justify-center text-xl font-bold mb-6 mx-auto">2</div>
                                    <h3 class="text-xl font-bold text-center mb-4">홈페이지 회원가입</h3>
                                    <p class="text-gray-600 text-center mb-6">홈페이지에서 회원가입을 진행해주세요</p>
                                    <div class="flex justify-center">
                                        <button onclick="showLoginScreen()" 
    class="flex items-center justify-center space-x-2 bg-primary text-white px-6 py-3 !rounded-button hover:bg-primary/90">
    <i class="ri-user-add-line"></i>
    <span>회원가입하기</span>
</button>
                                    </div>
                                </div>
                                <div class="bg-white rounded-xl p-8 shadow-lg relative z-10">
                                    <div class="w-12 h-12 bg-primary text-white rounded-full flex items-center justify-center text-xl font-bold mb-6 mx-auto">3</div>
                                    <h3 class="text-xl font-bold text-center mb-4">스포츠교실 예약</h3>
                                    <p class="text-gray-600 text-center mb-6">원하시는 날짜를 선택하여 예약해주세요</p>
                                    <div class="flex justify-center">
                                        <button onclick="showLoginScreen()" 
    class="flex items-center justify-center space-x-2 bg-primary text-white px-6 py-3 !rounded-button hover:bg-primary/90">
    <i class="ri-calendar-check-line"></i>
    <span>예약하기</span>
</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 푸터 -->
                <footer class="bg-gray-900 text-white py-12">
                    <div class="container mx-auto px-6">
                        <div class="grid md:grid-cols-4 gap-8">
                            <div>
                                <h3 class="text-lg font-bold mb-4">스포츠박스</h3>
                                <p class="text-gray-400">경기도체육회</p>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold mb-4">연락처</h3>
                                <p class="text-gray-400">전화: 031-250-0474~7</p>
                                <p class="text-gray-400">이메일: <a href="mailto:hoseok0119@ggsc.or.kr" class="hover:text-white">hoseok0119@ggsc.or.kr</a></p>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold mb-4">운영시간</h3>
                                <p class="text-gray-400">평일: 09:00 - 18:00</p>
                                <p class="text-gray-400">주말 및 공휴일 휴무</p>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold mb-4">SNS</h3>
                                <div class="flex space-x-4">
                                    <a href="https://www.youtube.com/@%EC%8A%A4%ED%8F%AC%EC%B8%A0%EB%B0%95%EC%8A%A4-l7e" 
                                        target="_blank" class="text-gray-400 hover:text-white">
                                        <i class="ri-youtube-fill text-xl"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                            <p>&copy; 2025 경기도체육회 스포츠박스. All rights reserved.</p>
                        </div>
                    </div>
                </footer>
            </main>
        </div>
        
        <!-- 로그인/예약시스템 컨테이너 -->
        <div id="loginAndReservationSystem" class="hidden">
            <!-- 로그인 화면 -->
            <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 flex items-center justify-center p-4">
                <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                    <!-- 홈으로 돌아가기 버튼 -->
                    <div class="text-right mb-4">
                        <button onclick="showHomeScreen()" 
                            class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-center mb-8">
                        <i class="fas fa-running text-4xl text-indigo-600 mb-4"></i>
                        <h1 class="text-2xl font-bold text-gray-800">스포츠박스 로그인</h1>
                        <p class="text-gray-500 mt-2">스포츠박스 예약 시스템에 오신 것을 환영합니다</p>
                    </div>
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">아이디</label>
                            <div class="relative">
                                <i class="fas fa-user absolute left-3 top-3.5 text-gray-400"></i>
                                <input type="text" id="username" required
                                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">비밀번호</label>
                            <div class="relative">
                                <i class="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
                                <input type="password" id="password" required
                                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                            </div>
                        </div>
                        <button type="submit" 
                            class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition duration-200 font-medium shadow-lg">
                            로그인
                        </button>
                    </form>
                    <button id="showSignup" 
                        class="w-full mt-4 bg-gray-50 text-gray-700 py-3 rounded-lg hover:bg-gray-100 transition duration-200 font-medium border border-gray-200">
                        회원가입
                    </button>
                </div>
            </div>
            
<!-- 공지사항 상세보기 모달 -->
<div id="noticeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 relative">
            <button onclick="closeNoticeDetail()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
            <h2 id="noticeDetailTitle" class="text-2xl font-bold mb-4"></h2>
            <div class="flex justify-between text-sm text-gray-500 mb-4">
                <span id="noticeDetailAuthor"></span>
                <span id="noticeDetailDate"></span>
            </div>
            <div class="border-t pt-4">
                <p id="noticeDetailContent" class="text-gray-700 whitespace-pre-line"></p>
            </div>
            <div id="noticeDetailActions" class="flex justify-end space-x-2 mt-6 pt-4 border-t hidden">
                <button onclick="editNotice()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    수정
                </button>
                <button onclick="deleteNotice()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    삭제
                </button>
            </div>
        </div>
    </div>
</div>

            <!-- 회원가입 모달 -->
<div id="signupModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-md w-96 m-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">회원가입</h2>
            <button id="closeSignup" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="signupForm" class="space-y-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">단체명</label>
                <input type="text" id="groupName" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                <input type="password" id="signupPassword" required minlength="6"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                <p class="text-sm text-gray-500 mt-1">6자 이상 입력해주세요</p>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">담당자</label>
                <input type="text" id="manager" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">시/군</label>
                <select id="city" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="">시/군을 선택하세요</option>
                </select>
                <p id="regionInfo" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">연락처</label>
                <input type="text" id="contact" required
                    placeholder="예: 010-1234-5678"
                    pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                <p class="text-sm text-gray-500 mt-1">형식: 010-0000-0000</p>
            </div>
            <button type="submit" 
                class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                가입하기
            </button>
        </form>
    </div>
</div>

            <!-- 사용자 대시보드 -->
            <div id="userDashboard" class="hidden">
                <!-- 네비게이션 바 -->
                <nav class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
                    <div class="container mx-auto px-4 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-running text-2xl"></i>
                                <span class="dashboard-title text-2xl font-bold">스포츠박스</span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span id="regionBadge" class="px-3 py-1 rounded-full text-sm font-medium bg-white/20"></span>
                                <span id="userGroupName" class="text-sm bg-white/20 px-4 py-2 rounded-full"></span>
                                <button onclick="showUserProfileModal()" 
                                    class="flex items-center space-x-2 hover:bg-white/20 px-4 py-2 rounded-full transition-all duration-200">
                                    <i class="fas fa-user"></i>
                                    <span>계정관리</span>
                                </button>
                                <button onclick="showHomeScreen()" 
                                    class="flex items-center space-x-2 hover:bg-white/20 px-4 py-2 rounded-full transition-all duration-200">
                                    <i class="fas fa-home"></i>
                                    <span>홈으로</span>
                                </button>
                                <button id="logoutBtn" 
                                    class="flex items-center space-x-2 hover:bg-white/20 px-4 py-2 rounded-full transition-all duration-200">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>로그아웃</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>

                <main class="container mx-auto px-4 py-8">
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- 캘린더 섹션 -->
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <div class="flex justify-between items-center mb-8">
                                <h2 class="text-xl font-bold text-gray-800">예약 현황</h2>
                                <div class="flex items-center space-x-4 bg-gray-50 p-2 rounded-xl">
                                    <button id="prevMonth" 
                                        class="w-10 h-10 flex items-center justify-center hover:bg-white rounded-lg transition-colors duration-200">
                                        <i class="fas fa-chevron-left text-indigo-600"></i>
                                    </button>
                                    <span id="currentMonth" class="text-lg font-medium text-gray-700 min-w-[120px] text-center"></span>
                                    <button id="nextMonth" 
                                        class="w-10 h-10 flex items-center justify-center hover:bg-white rounded-lg transition-colors duration-200">
                                        <i class="fas fa-chevron-right text-indigo-600"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-7 gap-2 mb-2">
                                <div class="text-center font-medium text-gray-600">일</div>
                                <div class="text-center font-medium text-gray-600">월</div>
                                <div class="text-center font-medium text-gray-600">화</div>
                                <div class="text-center font-medium text-gray-600">수</div>
                                <div class="text-center font-medium text-gray-600">목</div>
                                <div class="text-center font-medium text-gray-600">금</div>
                                <div class="text-center font-medium text-gray-600">토</div>
                            </div>
                            <div id="calendar" class="grid grid-cols-7 gap-2"></div>
                            <div class="mt-4 flex justify-end space-x-4">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-yellow-100 rounded mr-2"></div>
                                    <span class="text-sm text-gray-600">1개마감</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-red-100 rounded mr-2"></div>
                                    <span class="text-sm text-gray-600">예약마감</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-gray-600 rounded mr-2"></div>
                                    <span class="text-sm text-gray-600">관리자마감</span>
                                </div>
                            </div>
                        </div>

                        <!-- 예약 정보 섹션 -->
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <div class="flex justify-between items-center mb-8">
                                <h2 class="text-xl font-bold text-gray-800">예약하기</h2>
                                <div id="remainingBookings" 
                                    class="px-4 py-2 bg-green-50 text-green-700 rounded-full text-sm font-medium">
                                    이번 달 남은 예약 가능 횟수: 4회
                                </div>
                            </div>
                            <form id="bookingForm" class="space-y-8">
                                <div class="bg-gray-50 p-6 rounded-xl">
                                    <label class="block text-gray-700 font-medium mb-2">선택된 날짜</label>
                                    <input type="text" id="selectedDate" readonly required
                                        class="w-full p-4 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">시작 시간</label>
                                        <select id="startTime" required
                                            class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">종료 시간</label>
                                        <select id="endTime" required
                                            class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">인원</label>
                                        <input type="number" id="people" required min="1"
                                            class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent">
                                        <p class="text-sm text-gray-500 mt-2">수업 인원을 입력하세요</p>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">장소</label>
                                        <input type="text" id="place" required
                                            class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent"
                                            placeholder="수업 장소를 입력하세요">
                                    </div>
                                </div>
                                
                                <button type="submit" 
                                    class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition duration-200 font-medium shadow-lg">
                                    예약하기
                                </button>
                            </form>
                        </div>

                        <!-- 내 예약 목록 -->
                        <div class="mt-8 bg-white rounded-lg shadow-lg p-6 col-span-2">
                            <h2 class="text-xl font-bold text-gray-700 mb-6">내 예약 목록</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead>
                                        <tr>
                                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">날짜</th>
                                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">시간</th>
                                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">장소</th>
                                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">인원</th>
                                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bookingsList" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>

<!-- 여기에 공지사항 섹션 추가 -->
<div class="mt-8 bg-white rounded-2xl shadow-xl p-8 col-span-2">
    <h2 class="text-xl font-bold text-gray-800 mb-6">공지사항</h2>
    <div id="noticesListSection" class="grid gap-6">
        <!-- 공지사항이 여기에 동적으로 추가됨 -->
    </div>
</div>
</div>

<!-- 사용자 대시보드 내에 문의사항 섹션 추가 -->
<div class="mt-8 bg-white rounded-2xl shadow-xl p-8 col-span-2">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800">내 문의사항</h2>
        <button onclick="showInquiryWriteModal()" 
            class="bg-primary text-white px-4 py-2 rounded-lg flex items-center space-x-2">
            <i class="fas fa-pen"></i>
            <span>문의하기</span>
        </button>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead>
                <tr>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">카테고리</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">제목</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작성일</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                </tr>
            </thead>
            <tbody id="userInquiriesList" class="bg-white divide-y divide-gray-200">
                <!-- 사용자 문의사항 목록이 동적으로 추가됩니다 -->
            </tbody>
        </table>
    </div>
</div>
</main>
</div>

    <!-- 사용자 프로필 관리 모달 -->
    <div id="userProfileModal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-md w-[500px] m-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">계정 정보 관리</h2>
                <button id="closeUserProfile" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="userProfileForm" class="space-y-6">
                <!-- 기본 정보 섹션 -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700">기본 정보</h3>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">단체명</label>
                        <input type="text" id="userGroupName" disabled
                            class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">담당자</label>
                        <input type="text" id="userManager" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">연락처</label>
                        <input type="text" id="userContact" required
                            pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}"
                            placeholder="예: 010-1234-5678"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                </div>

                <!-- 비밀번호 변경 섹션 -->
                <div class="space-y-4 pt-4 border-t">
                    <h3 class="text-lg font-semibold text-gray-700">비밀번호 변경</h3>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">현재 비밀번호</label>
                        <input type="password" id="userCurrentPassword"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">새 비밀번호</label>
                        <input type="password" id="userNewPassword"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">새 비밀번호 확인</label>
                        <input type="password" id="userConfirmPassword"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <p class="text-sm text-gray-500">* 비밀번호를 변경하지 않으려면 비워두세요</p>
                </div>

                <button type="submit" 
                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200">
                    정보 수정
                </button>
            </form>
        </div>
    </div>

            <!-- 관리자 대시보드 -->
            <div id="adminDashboard" class="hidden">
                <!-- 관리자 네비게이션 바 -->
                <nav class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
                    <div class="container mx-auto px-4 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-running text-2xl"></i>
                                <span class="dashboard-title text-2xl font-bold">스포츠박스 관리자</span>
                            </div>
                            <div class="flex items-center space-x-6">
                                <!-- 지역 선택 필터 -->
                                <div id="regionFilterContainer" class="flex items-center space-x-2 bg-white/20 rounded-lg px-4 py-2">
                                    <span class="text-sm font-medium">지역 선택:</span>
                                    <select id="regionFilter" class="bg-transparent border-none text-white focus:ring-0 cursor-pointer font-medium">
                                        <option value="all" class="bg-white text-gray-700">전체 지역</option>
                                        <option value="south" class="bg-white text-gray-700">남부</option>
                                        <option value="north" class="bg-white text-gray-700">북부</option>
                                    </select>
                                </div>
                                <!-- 관리자 정보 -->
                                <span id="adminRegionBadge" class="px-3 py-1 rounded-full text-sm font-medium bg-white/20"></span>
                                <span id="adminName" class="text-sm bg-white/20 px-4 py-2 rounded-full"></span>
                                <!-- 네비게이션 버튼 -->
                                <button onclick="showHomeScreen()" 
                                    class="flex items-center space-x-2 hover:bg-white/20 px-4 py-2 rounded-full transition-all duration-200">
                                    <i class="fas fa-home"></i>
                                    <span>홈으로</span>
                                </button>
                                <!-- 비밀번호 변경 버튼 추가 -->
    <button onclick="showChangePasswordModal()" 
    class="flex items-center space-x-2 hover:bg-white/20 px-4 py-2 rounded-full transition-all duration-200">
    <i class="fas fa-key"></i>
    <span>비밀번호 변경</span>
</button>

<!-- 로그아웃 버튼 -->
                                <button id="adminLogoutBtn" 
                                    class="flex items-center space-x-2 hover:bg-white/20 px-4 py-2 rounded-full transition-all duration-200">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>로그아웃</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
            
                <!-- 관리자 통계 섹션 -->
                <div class="container mx-auto px-4 py-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <!-- 남부 통계 -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">남부 지역 현황</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-600">금일 예약</p>
                                    <p id="southTodayBookings" class="text-2xl font-bold text-blue-600">0건</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-600">이번 달 총 예약</p>
                                    <p id="southMonthBookings" class="text-2xl font-bold text-green-600">0건</p>
                                </div>
                            </div>
                        </div>
                        <!-- 북부 통계 -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">북부 지역 현황</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-600">금일 예약</p>
                                    <p id="northTodayBookings" class="text-2xl font-bold text-blue-600">0건</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-600">이번 달 총 예약</p>
                                    <p id="northMonthBookings" class="text-2xl font-bold text-green-600">0건</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 관리자 메인 컨텐츠 -->
                <div class="container mx-auto px-4 py-8">
                    <!-- 예약 시스템 설정 섹션 -->
                    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-6">예약 시스템 관리</h2>
                        <div class="flex items-center justify-between p-6 bg-gray-50 rounded-xl">
                            <div class="flex flex-col">
                                <span class="text-lg font-semibold text-gray-700">예약 상태</span>
                                <span id="bookingStatusText" class="text-sm text-gray-500">
                                    현재 예약을 받고 있지 않습니다
                                </span>
                            </div>
                            <button type="button" id="toggleBookingStatus" 
                                class="px-6 py-3 rounded-xl font-medium transition-all duration-200">
                                예약 시작하기
                            </button>
                        </div>
                    </div>

                    <!-- 캘린더 섹션 -->
                    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-800">예약 현황</h2>
                            <div class="flex items-center space-x-6">
                                <button id="downloadExcel" 
                                    class="bg-green-500 text-white px-6 py-3 rounded-xl hover:bg-green-600 flex items-center space-x-2 transition-colors duration-200 shadow-lg">
                                    <i class="fas fa-file-excel"></i>
                                    <span>월간 일정표 다운로드</span>
                                </button>
                                <div class="flex items-center space-x-4 bg-gray-50 p-2 rounded-xl">
                                    <button id="adminPrevMonth" class="w-10 h-10 flex items-center justify-center hover:bg-white rounded-lg transition-colors duration-200">
                                        <i class="fas fa-chevron-left text-indigo-600"></i>
                                    </button>
                                    <span id="adminCurrentMonth" class="text-lg font-medium text-gray-700 min-w-[120px] text-center"></span>
                                    <button id="adminNextMonth" class="w-10 h-10 flex items-center justify-center hover:bg-white rounded-lg transition-colors duration-200">
                                        <i class="fas fa-chevron-right text-indigo-600"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 관리자 캘린더 -->
                        <div class="mb-4">
                            <div class="grid grid-cols-7 gap-4 mb-4">
                                <div class="text-center font-semibold text-gray-600 py-2">일</div>
                                <div class="text-center font-semibold text-gray-600 py-2">월</div>
                                <div class="text-center font-semibold text-gray-600 py-2">화</div>
                                <div class="text-center font-semibold text-gray-600 py-2">수</div>
                                <div class="text-center font-semibold text-gray-600 py-2">목</div>
                                <div class="text-center font-semibold text-gray-600 py-2">금</div>
                                <div class="text-center font-semibold text-gray-600 py-2">토</div>
                            </div>
                            <div id="adminCalendar" class="grid grid-cols-7 gap-4"></div>
                        </div>

                        <!-- 캘린더 범례 -->
                        <div class="flex justify-end space-x-6 pt-6 border-t">
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-yellow-100 rounded-full mr-2 shadow-sm"></div>
                                <span class="text-sm text-gray-600 font-medium">예약가능</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full mr-2 shadow-sm" style="background-color: #F97316;"></div>
                                <span class="text-sm text-gray-600 font-medium">부분마감</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-red-100 rounded-full mr-2 shadow-sm"></div>
                                <span class="text-sm text-gray-600 font-medium">예약마감</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-gray-600 rounded-full mr-2 shadow-sm"></div>
                                <span class="text-sm text-gray-600 font-medium">전체마감</span>
                            </div>
                        </div>
                    </div>

                    <!-- 승인 관리 섹션 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- 회원가입 승인 대기 목록 -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-user-plus text-indigo-600 mr-2"></i>
                회원가입 승인 대기
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">단체명</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">담당자</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">연락처</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                        </tr>
                    </thead>
                    <tbody id="pendingUsersList" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- 예약 승인 목록 -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-calendar-check text-indigo-600 mr-2"></i>
                예약 승인 대기
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">단체명</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">날짜</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">시간</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                        </tr>
                    </thead>
                    <tbody id="pendingBookingsList" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 전체 회원 관리 섹션 -->
    <div class="mt-8 bg-white rounded-2xl shadow-xl p-8">
        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-users text-indigo-600 mr-2"></i>
            전체 회원 관리
        </h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">단체명</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">담당자</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">연락처</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">지역</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                    </tr>
                </thead>
                <tbody id="allUsersList" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- 관리자 대시보드에 문의사항 관리 섹션 추가 -->
<div class="mt-8 bg-white rounded-2xl shadow-xl p-8">
    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-question-circle text-indigo-600 mr-2"></i>
        문의사항 관리
    </h2>
    <div class="mb-4 flex justify-between items-center">
        <div class="flex space-x-4">
            <select id="adminInquiryStatusFilter" class="pl-4 pr-8 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="all">전체 상태</option>
                <option value="waiting">답변 대기</option>
                <option value="answered">답변 완료</option>
            </select>
            <select id="adminInquiryCategoryFilter" class="pl-4 pr-8 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="all">전체 카테고리</option>
                <option value="program">프로그램 문의</option>
                <option value="reservation">예약 문의</option>
                <option value="other">기타 문의</option>
            </select>
        </div>
        <div class="relative w-64">
            <input type="text" id="adminInquirySearch" placeholder="검색어를 입력하세요" 
                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead>
                <tr>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">번호</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">카테고리</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">제목</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작성자</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작성일</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                </tr>
            </thead>
            <tbody id="adminInquiriesList" class="bg-white divide-y divide-gray-200">
                <!-- 관리자용 문의사항 목록이 동적으로 추가됩니다 -->
            </tbody>
        </table>
    </div>
    <!-- 페이지네이션 -->
    <div class="mt-6 flex justify-center">
        <nav class="flex items-center space-x-2">
            <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 hover:bg-gray-50">
                <i class="fas fa-chevron-left text-gray-500"></i>
            </button>
            <button class="w-10 h-10 flex items-center justify-center rounded-lg bg-primary text-white">1</button>
            <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 hover:bg-gray-50">2</button>
            <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 hover:bg-gray-50">3</button>
            <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 hover:bg-gray-50">
                <i class="fas fa-chevron-right text-gray-500"></i>
            </button>
        </nav>
    </div>
</div>

<!-- 문의사항 페이지 -->
<div id="inquiryPage" class="hidden">
    <header class="fixed w-full bg-white shadow-sm z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <img src="https://static.readdy.ai/image/416007a89256a2717806f7776e859886/110ce5261818cd69133e46ef8c6b097a.png" 
                         alt="경기도체육회 로고" class="h-10">
                    <div class="text-2xl font-bold text-primary">스포츠박스</div>
                </div>
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="javascript:showHomeScreen()" class="text-gray-700 hover:text-primary py-2">홈</a>
                    <a href="javascript:showInquiryPage()" class="text-primary font-semibold py-2 border-b-2 border-primary">문의사항</a>
                    <button id="inquiryLoginButton" onclick="showLoginScreen()" 
                        class="bg-primary text-white px-4 py-2 !rounded-button hover:bg-primary/90">
                        회원가입/로그인
                    </button>
                    <div id="inquiryLoggedInNav" class="hidden space-x-4"></div>
                </nav>
            </div>
        </div>
    </header>

    <main class="pt-24 pb-16 container mx-auto px-6">
        <div class="mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">문의사항</h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-red-500 rounded-full inline-block mr-1"></span>
                    <span class="text-sm text-gray-600">비밀글</span>
                </div>
                <div id="inquiryWriteButtonContainer" class="hidden">
                    <button onclick="showInquiryWriteModal()" 
                        class="bg-primary text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                        <i class="fas fa-pen"></i>
                        <span>문의하기</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 검색 및 필터 -->
        <div class="mb-6 flex justify-between">
            <div class="relative w-64">
                <input type="text" id="inquirySearch" placeholder="검색어를 입력하세요" 
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            <select id="inquiryCategory" class="pl-4 pr-8 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="all">전체 카테고리</option>
                <option value="program">프로그램 문의</option>
                <option value="reservation">예약 문의</option>
                <option value="other">기타 문의</option>
            </select>
        </div>

        <!-- 문의사항 목록 테이블 -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">번호</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">카테고리</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">제목</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작성자</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작성일</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                    </tr>
                </thead>
                <tbody id="inquiryList" class="bg-white divide-y divide-gray-200">
                    <!-- 문의사항 목록이 동적으로 삽입됩니다 -->
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        <div class="mt-6 flex justify-center">
            <nav class="flex items-center space-x-2">
                <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 hover:bg-gray-50">
                    <i class="fas fa-chevron-left text-gray-500"></i>
                </button>
                <button class="w-10 h-10 flex items-center justify-center rounded-lg bg-primary text-white">1</button>
                <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 hover:bg-gray-50">2</button>
                <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 hover:bg-gray-50">3</button>
                <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 hover:bg-gray-50">
                    <i class="fas fa-chevron-right text-gray-500"></i>
                </button>
            </nav>
        </div>
    </main>

    <!-- 푸터 -->
    <footer class="bg-gray-900 text-white py-12">
        <div class="container mx-auto px-6">
            <div class="grid md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-lg font-bold mb-4">스포츠박스</h3>
                    <p class="text-gray-400">경기도체육회</p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">연락처</h3>
                    <p class="text-gray-400">전화: 031-250-0474~7</p>
                    <p class="text-gray-400">이메일: <a href="mailto:hoseok0119@ggsc.or.kr" class="hover:text-white">hoseok0119@ggsc.or.kr</a></p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">운영시간</h3>
                    <p class="text-gray-400">평일: 09:00 - 18:00</p>
                    <p class="text-gray-400">주말 및 공휴일 휴무</p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">SNS</h3>
                    <div class="flex space-x-4">
                        <a href="https://www.youtube.com/@%EC%8A%A4%ED%8F%AC%EC%B8%A0%EB%B0%95%EC%8A%A4-l7e" 
                            target="_blank" class="text-gray-400 hover:text-white">
                            <i class="ri-youtube-fill text-xl"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2025 경기도체육회 스포츠박스. All rights reserved.</p>
            </div>
        </div>
    </footer>
</div>

<!-- 날짜별 예약 내역 모달 -->
<div id="dateBookingsModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-2xl m-auto max-h-[80vh] flex flex-col overflow-hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 id="modalDate" class="text-xl font-bold text-gray-700"></h2>
            <button id="closeDateBookingsModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4 flex justify-end space-x-2">
            <button id="partialBlockDateBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                부분 마감
            </button>
            <button id="fullBlockDateBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                전체 마감
            </button>
            <button id="unblockDateBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 hidden">
                마감 해제
            </button>
        </div>
        <div class="flex-1 overflow-y-auto min-h-0">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-white sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                단체명
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                시간
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                장소
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                인원
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                상태
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                관리
                            </th>
                        </tr>
                    </thead>
                    <tbody id="dateBookingsList" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

    <!-- 관리자 비밀번호 변경 모달 -->
    <div id="changePasswordModal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-md w-96 m-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">비밀번호 변경</h2>
                <button id="closeChangePassword" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">현재 비밀번호</label>
                    <input type="password" id="currentPassword" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">새 비밀번호</label>
                    <input type="password" id="newPassword" required minlength="6"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">새 비밀번호 확인</label>
                    <input type="password" id="confirmPassword" required minlength="6"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <button type="submit" 
                    class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    비밀번호 변경
                </button>
            </form>
        </div>
    </div>
</div>

<!-- 연락처 모달 -->
<div id="contactModal" class="modal">
    <div class="bg-white p-8 rounded-lg max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">담당자 연락처</h3>
            <button onclick="hideContactInfo()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-600">전화: 031-250-0474~7</p>
            <p class="text-gray-600">이메일: hoseok0119@ggsc.or.kr</p>
            <p class="text-gray-600">운영시간: 평일 09:00 - 18:00</p>
        </div>
    </div>
</div>

<!-- 문의사항 작성 모달 -->
<div id="inquiryWriteModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-2xl m-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">문의하기</h2>
            <button onclick="closeInquiryWriteModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="inquiryWriteForm" class="space-y-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">카테고리</label>
                <select id="writeInquiryCategory" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="">카테고리 선택</option>
                    <option value="program">프로그램 문의</option>
                    <option value="reservation">예약 문의</option>
                    <option value="other">기타 문의</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">제목</label>
                <input type="text" id="inquiryTitle" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">내용</label>
                <textarea id="inquiryContent" required rows="6"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">첨부파일</label>
                <div class="flex items-center space-x-2">
                    <input type="file" id="inquiryFile" class="hidden" 
                        accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.hwp,.jpg,.jpeg,.png,.gif">
                    <button type="button" onclick="document.getElementById('inquiryFile').click()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
                        파일 선택
                    </button>
                    <span id="inquirySelectedFileName" class="text-sm text-gray-600">선택된 파일 없음</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">최대 파일 크기: 10MB</p>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="inquiryIsPrivate" class="w-4 h-4 text-blue-600 rounded">
                <label for="inquiryIsPrivate" class="ml-2 text-gray-700 text-sm font-bold">비밀글로 작성</label>
            </div>
            <button type="submit" 
                class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition duration-200">
                문의하기
            </button>
        </form>
    </div>
</div>

<!-- 문의사항 상세 보기 모달 -->
<div id="inquiryDetailModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-2xl m-auto max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="detailInquiryTitle" class="text-2xl font-bold">문의사항 제목</h2>
            <button onclick="closeInquiryDetailModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="flex justify-between text-sm text-gray-500 mb-4">
            <div class="flex space-x-4">
                <span id="detailInquiryCategory" class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full"></span>
                <span id="detailInquiryAuthor"></span>
            </div>
            <span id="detailInquiryDate"></span>
        </div>
        <div class="border-t border-b py-6">
            <p id="detailInquiryContent" class="text-gray-700 whitespace-pre-line"></p>
            
            <!-- 첨부파일 영역 -->
            <div id="detailInquiryAttachment" class="mt-4 hidden">
                <p class="text-sm font-medium text-gray-600 mb-2">첨부파일</p>
                <a id="detailInquiryFileLink" href="#" target="_blank" download
                   class="flex items-center space-x-2 text-blue-600 hover:text-blue-800">
                    <i class="fas fa-paperclip"></i>
                    <span id="detailInquiryFileName"></span>
                </a>
            </div>
        </div>
        
        <!-- 답변 영역 -->
        <div id="inquiryAnswerSection" class="mt-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">답변</h3>
            <div id="inquiryNoAnswer" class="p-4 bg-gray-100 rounded-lg">
                <p class="text-gray-500">아직 답변이 등록되지 않았습니다.</p>
            </div>
            <div id="inquiryAnswerContent" class="hidden">
                <div class="flex justify-between text-sm text-gray-500 mb-2">
                    <span id="answerAuthor">관리자</span>
                    <span id="answerDate"></span>
                </div>
                <div class="p-4 bg-gray-100 rounded-lg">
                    <p id="answerContent" class="text-gray-700 whitespace-pre-line"></p>
                </div>
            </div>
        </div>
        
        <!-- 관리자용 답변 입력 영역 -->
        <div id="adminAnswerSection" class="mt-6 hidden">
            <h3 class="text-lg font-bold text-gray-800 mb-4">답변 작성</h3>
            <form id="inquiryAnswerForm" class="space-y-4">
                <textarea id="adminAnswerContent" rows="4" placeholder="답변을 작성해주세요"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                <div class="flex justify-end">
                    <button type="submit" 
                        class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition duration-200">
                        답변 등록
                    </button>
                </div>
            </form>
        </div>
        
        <!-- 작성자용 문의 수정/삭제 버튼 -->
        <div id="inquiryOwnerActions" class="mt-6 flex justify-end space-x-2 hidden">
            <button onclick="showEditInquiryModal()" 
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                수정
            </button>
            <button onclick="deleteInquiry()" 
                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                삭제
            </button>
        </div>
    </div>
</div>

<!-- Excel.js 라이브러리 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<!-- JavaScript 코드 시작 -->
<script>
// 전역 스코프에 함수 정의 및 window 객체에 명시적 할당
window.addDirectNoticeListeners = function() {
    // 모든 공지사항 항목에 이벤트 추가 (홈화면 + 대시보드)
    const noticeItems = document.querySelectorAll('.notice-item, [data-notice-id]');
    console.log('공지사항 항목 수:', noticeItems.length);
    
    if (noticeItems.length === 0) {
        console.log('공지사항 항목이 없습니다. 이벤트 리스너를 추가할 수 없습니다.');
        return;
    }
    
    noticeItems.forEach(item => {
        // 기존 이벤트 제거 (이벤트 버블링 방지)
        const newItem = item.cloneNode(true);
        item.parentNode.replaceChild(newItem, item);
        
        // 새 이벤트 추가 - 여기서 handleNoticeClick 함수 사용
        newItem.addEventListener('click', window.handleNoticeClick || function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const noticeId = parseInt(this.getAttribute('data-notice-id'));
            const realNoticeId = parseInt(this.getAttribute('data-notice-real-id'));
            
            console.log('공지사항 클릭:', noticeId, realNoticeId);
            
            if (window.noticesData && noticeId >= 0 && noticeId < window.noticesData.length) {
                const notice = window.noticesData[noticeId];
                
                // ID 저장
                window.currentNoticeId = realNoticeId || notice.id;
                
                // 모달 내용 설정
                const modal = document.getElementById('independentNoticeModal');
                if (modal) {
                    document.getElementById('independentModalTitle').textContent = notice.title;
                    document.getElementById('independentModalContent').textContent = notice.content;
                    document.getElementById('independentModalAuthor').textContent = `작성자: ${notice.author || '관리자'}`;
                    document.getElementById('independentModalDate').textContent = new Date(notice.created_at).toLocaleDateString();
                    
                    // 첨부파일 섹션 처리
                    const attachmentSection = document.getElementById('independentModalAttachment');
                    if (attachmentSection) {
                        if (notice.attachment_url) {
                            document.getElementById('independentModalFileName').textContent = notice.attachment_name || '첨부파일';
                            document.getElementById('independentModalFileLink').href = notice.attachment_url;
                            attachmentSection.style.display = 'block';
                        } else {
                            attachmentSection.style.display = 'none';
                        }
                    }
                    
                    // 관리자 권한 확인 및 버튼 표시
                    const adminActions = document.getElementById('independentModalActions');
                    if (adminActions) {
                        const isAdmin = sessionStorage.getItem('role') === 'admin';
                        adminActions.style.display = isAdmin ? 'flex' : 'none';
                    }
                    
                    // 모달 표시
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }
        });
    });
    
    console.log('공지사항 이벤트 리스너 설정 완료');
};

// 기존 코드를 수정하지 않고 새로운 모달 시스템 추가
function setupIndependentNoticeSystem() {
    console.log('독립적인 공지사항 모달 시스템 설정 시작');
    
    // 1. 기존 모달 제거 (이미 있다면)
    const existingModal = document.getElementById('independentNoticeModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 2. 새 모달 HTML 추가
    const newModalHTML = `
        <div id="independentNoticeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background-color:rgba(0,0,0,0.75); z-index:99999; align-items:center; justify-content:center;">
            <div style="background:white; max-width:800px; width:90%; border-radius:10px; padding:20px; position:relative; max-height:80vh; overflow-y:auto;">
                <button id="independentModalClose" style="position:absolute; top:10px; right:10px; background:none; border:none; 
                font-size:24px; cursor:pointer; width:30px; height:30px; line-height:30px; text-align:center;">×</button>
                <h2 id="independentModalTitle" style="margin-bottom:15px; font-size:22px; font-weight:bold;"></h2>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; color:#666;">
                    <span id="independentModalAuthor"></span>
                    <span id="independentModalDate"></span>
                </div>
                <div style="border-top:1px solid #eee; padding-top:15px;">
                    <p id="independentModalContent" style="white-space:pre-line; line-height:1.5;"></p>
                </div>
                <!-- 첨부파일 섹션 -->
                <div id="independentModalAttachment" style="margin-top:20px; padding-top:15px; border-top:1px solid #eee; display:none;">
                    <h3 style="font-weight:bold; margin-bottom:10px; font-size:16px;">첨부파일</h3>
                    <div id="independentModalFile" style="display:flex; align-items:center;">
                        <a id="independentModalFileLink" href="#" target="_blank" download
                           style="display:inline-flex; align-items:center; padding:8px 12px; background:#f3f4f6; border-radius:4px; text-decoration:none; color:#374151; font-size:14px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" style="margin-right:8px;" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            <span id="independentModalFileName">파일명</span>
                        </a>
                    </div>
                </div>
                <!-- 관리자 액션 버튼 섹션 -->
                <div id="independentModalActions" style="display:none; margin-top:20px; padding-top:15px; border-top:1px solid #eee; justify-content:flex-end;">
                    <button id="editNoticeBtn" style="background:#3B82F6; color:white; padding:8px 16px; border-radius:4px; margin-right:8px; cursor:pointer; border:none;">수정</button>
                    <button id="deleteNoticeBtn" style="background:#EF4444; color:white; padding:8px 16px; border-radius:4px; cursor:pointer; border:none;">삭제</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', newModalHTML);
    
    // 3. 모달 닫기 이벤트 설정
    document.getElementById('independentModalClose').onclick = function() {
        document.getElementById('independentNoticeModal').style.display = 'none';
        document.body.style.overflow = '';
    };
    
    // 4. 모달 외부 클릭 시 닫기
    document.getElementById('independentNoticeModal').onclick = function(e) {
        if (e.target === this) {
            this.style.display = 'none';
            document.body.style.overflow = '';
        }
    };
    
    // 5. ESC 키로 모달 닫기 기능 추가
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('independentNoticeModal');
            if (modal && modal.style.display === 'flex') {
                modal.style.display = 'none';
                document.body.style.overflow = '';
                console.log('ESC 키로 모달 닫힘');
            }
        }
    });
    
    // 6. 관리자 액션 버튼 이벤트 설정
    document.getElementById('editNoticeBtn').addEventListener('click', function() {
        const modal = document.getElementById('independentNoticeModal');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        
        // 수정 함수 호출
        if (typeof editNotice === 'function') {
            editNotice();
        } else {
            console.error('editNotice 함수를 찾을 수 없습니다');
        }
    });
    
    // 삭제 버튼 이벤트 - 완전히 새로 작성
    document.getElementById('deleteNoticeBtn').addEventListener('click', async function() {
        // 현재 표시된 공지사항 ID 확인
        const noticeId = window.currentNoticeId;
        console.log('삭제 시도: 공지사항 ID =', noticeId);
        
        if (!noticeId) {
            showAlert('공지사항 ID를 찾을 수 없습니다.', 'error');
            return;
        }
        
        // 삭제 확인
        if (!confirm('정말 이 공지사항을 삭제하시겠습니까?')) {
            return;
        }
        
        try {
            // 로딩 표시
            document.getElementById('loading').classList.add('show');
            
            // API 요청
            const response = await fetch(`https://sports-box-api.parkkwangmin9209.workers.dev/api/admin/notices/${noticeId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('공지사항이 삭제되었습니다.', 'success');
                // 모달 닫기
                document.getElementById('independentNoticeModal').style.display = 'none';
                document.body.style.overflow = '';
                // 공지사항 목록 새로고침
                loadHomeNotices();
                // 대시보드에 있는 경우 해당 목록도 새로고침
                if (document.getElementById('noticesListSection')) {
                    loadUserNotices();
                }
            } else {
                throw new Error(data.message || '공지사항 삭제에 실패했습니다.');
            }
        } catch (error) {
            console.error('공지사항 삭제 오류:', error);
            showAlert(error.message || '공지사항 삭제 중 오류가 발생했습니다.', 'error');
        } finally {
            document.getElementById('loading').classList.remove('show');
        }
    });
    
    // 7. 공지사항 표시 함수 정의 (ID 저장 포함)
    window.handleNoticeClick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const noticeItem = e.currentTarget;
        const noticeId = parseInt(noticeItem.getAttribute('data-notice-id'));
        
        // 명시적으로 실제 ID 가져오기
        const realNoticeId = parseInt(noticeItem.getAttribute('data-notice-real-id'));
        
        console.log('클릭한 공지사항 - 인덱스:', noticeId, '실제 ID:', realNoticeId);
        
        if (window.noticesData && noticeId >= 0 && noticeId < window.noticesData.length) {
            const notice = window.noticesData[noticeId];
            
            // 중요: ID 저장 방식 개선
            if (realNoticeId) {
                window.currentNoticeId = realNoticeId;
            } else if (notice.id) {
                window.currentNoticeId = notice.id;
            } else {
                console.error('공지사항 ID를 찾을 수 없음:', notice);
                window.currentNoticeId = null;
            }
            
            console.log('저장된 currentNoticeId:', window.currentNoticeId);
            
            // 모달 내용 설정
            document.getElementById('independentModalTitle').textContent = notice.title;
            document.getElementById('independentModalContent').textContent = notice.content;
            document.getElementById('independentModalAuthor').textContent = `작성자: ${notice.author || '관리자'}`;
            document.getElementById('independentModalDate').textContent = new Date(notice.created_at).toLocaleDateString();
            
            // 첨부파일 섹션 처리
            const attachmentSection = document.getElementById('independentModalAttachment');
            if (attachmentSection) {
                if (notice.attachment_url) {
                    document.getElementById('independentModalFileName').textContent = notice.attachment_name || '첨부파일';
                    document.getElementById('independentModalFileLink').href = notice.attachment_url;
                    attachmentSection.style.display = 'block';
                } else {
                    attachmentSection.style.display = 'none';
                }
            }
            
            // 관리자 권한 확인 및 버튼 표시
            const adminActions = document.getElementById('independentModalActions');
            if (adminActions) {
                const isAdmin = sessionStorage.getItem('role') === 'admin';
                adminActions.style.display = isAdmin ? 'flex' : 'none';
                console.log('관리자 권한 확인:', isAdmin ? '관리자 맞음' : '관리자 아님');
            }
            
            // 모달 표시
            const modal = document.getElementById('independentNoticeModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    };
    
    // 8. 공지사항 항목에 직접 이벤트 추가
    function addDirectNoticeListeners() {
    console.log('공지사항 이벤트 리스너 추가 함수 실행');
    
    // 모든 공지사항 항목에 이벤트 추가 (홈화면 + 대시보드)
    const noticeItems = document.querySelectorAll('.notice-item, [data-notice-id]');
    console.log('공지사항 항목 수:', noticeItems.length);
    
    if (noticeItems.length === 0) {
        console.log('공지사항 항목이 없습니다. 이벤트 리스너를 추가할 수 없습니다.');
        
        // 지연 후 다시 시도
        setTimeout(() => {
            const retryItems = document.querySelectorAll('.notice-item, [data-notice-id]');
            console.log('지연 후 재시도 - 공지사항 항목 수:', retryItems.length);
            
            if (retryItems.length > 0) {
                retryItems.forEach(item => {
                    // 기존 이벤트 제거
                    const newItem = item.cloneNode(true);
                    item.parentNode.replaceChild(newItem, item);
                    
                    // 새 이벤트 추가
                    newItem.addEventListener('click', window.handleNoticeClick || function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const noticeId = parseInt(this.getAttribute('data-notice-id'));
                        const realNoticeId = parseInt(this.getAttribute('data-notice-real-id'));
                        
                        console.log('공지사항 클릭 (재시도):', noticeId, realNoticeId);
                        
                        if (window.noticesData && noticeId >= 0 && noticeId < window.noticesData.length) {
                            const notice = window.noticesData[noticeId];
                            
                            // ID 저장
                            window.currentNoticeId = realNoticeId || notice.id;
                            
                            // 모달 내용 설정
                            const modal = document.getElementById('independentNoticeModal');
                            if (modal) {
                                document.getElementById('independentModalTitle').textContent = notice.title;
                                document.getElementById('independentModalContent').textContent = notice.content;
                                document.getElementById('independentModalAuthor').textContent = `작성자: ${notice.author || '관리자'}`;
                                document.getElementById('independentModalDate').textContent = new Date(notice.created_at).toLocaleDateString();
                                
                                // 첨부파일 섹션 처리
                                const attachmentSection = document.getElementById('independentModalAttachment');
                                if (attachmentSection) {
                                    if (notice.attachment_url) {
                                        document.getElementById('independentModalFileName').textContent = notice.attachment_name || '첨부파일';
                                        document.getElementById('independentModalFileLink').href = notice.attachment_url;
                                        attachmentSection.style.display = 'block';
                                    } else {
                                        attachmentSection.style.display = 'none';
                                    }
                                }
                                
                                // 관리자 권한 확인 및 버튼 표시
                                const adminActions = document.getElementById('independentModalActions');
                                if (adminActions) {
                                    const isAdmin = sessionStorage.getItem('role') === 'admin';
                                    adminActions.style.display = isAdmin ? 'flex' : 'none';
                                }
                                
                                // 모달 표시
                                modal.style.display = 'flex';
                                document.body.style.overflow = 'hidden';
                            }
                        }
                    });
                });
                
                console.log('지연 후 공지사항 이벤트 리스너 설정 완료');
            }
        }, 500);
        
        return;
    }
    
    noticeItems.forEach(item => {
        // 기존 이벤트 제거 (이벤트 버블링 방지)
        const newItem = item.cloneNode(true);
        item.parentNode.replaceChild(newItem, item);
        
        // 새 이벤트 추가 - 여기서 handleNoticeClick 함수 사용
        newItem.addEventListener('click', window.handleNoticeClick || function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const noticeId = parseInt(this.getAttribute('data-notice-id'));
            const realNoticeId = parseInt(this.getAttribute('data-notice-real-id'));
            
            console.log('공지사항 클릭:', noticeId, realNoticeId);
            
            if (window.noticesData && noticeId >= 0 && noticeId < window.noticesData.length) {
                const notice = window.noticesData[noticeId];
                
                // ID 저장
                window.currentNoticeId = realNoticeId || notice.id;
                
                // 모달 내용 설정
                const modal = document.getElementById('independentNoticeModal');
                if (modal) {
                    document.getElementById('independentModalTitle').textContent = notice.title;
                    document.getElementById('independentModalContent').textContent = notice.content;
                    document.getElementById('independentModalAuthor').textContent = `작성자: ${notice.author || '관리자'}`;
                    document.getElementById('independentModalDate').textContent = new Date(notice.created_at).toLocaleDateString();
                    
                    // 첨부파일 섹션 처리
                    const attachmentSection = document.getElementById('independentModalAttachment');
                    if (attachmentSection) {
                        if (notice.attachment_url) {
                            document.getElementById('independentModalFileName').textContent = notice.attachment_name || '첨부파일';
                            document.getElementById('independentModalFileLink').href = notice.attachment_url;
                            attachmentSection.style.display = 'block';
                        } else {
                            attachmentSection.style.display = 'none';
                        }
                    }
                    
                    // 관리자 권한 확인 및 버튼 표시
                    const adminActions = document.getElementById('independentModalActions');
                    if (adminActions) {
                        const isAdmin = sessionStorage.getItem('role') === 'admin';
                        adminActions.style.display = isAdmin ? 'flex' : 'none';
                    }
                    
                    // 모달 표시
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }
        });
    });
    
    console.log('공지사항 이벤트 리스너 설정 완료');
}
    
    // 9. 페이지 로드 및 공지사항 로드 후 리스너 추가
    const originalLoadHomeNotices = window.loadHomeNotices;
    if (originalLoadHomeNotices && !window.noticeSystemPatched) {
        window.noticeSystemPatched = true;
        window.loadHomeNotices = async function() {
            await originalLoadHomeNotices.apply(this, arguments);
            setTimeout(addDirectNoticeListeners, 500);
        };
    }
    
    // 10. 사용자 대시보드 공지사항 로드 함수 추가 (중요!)
    window.loadUserNotices = async function() {
        try {
            console.log('사용자 대시보드 공지사항 로드 시작');
            
            // 사용자 지역 정보 가져오기
            const userRegion = sessionStorage.getItem('region');
            console.log('사용자 지역:', userRegion);
            
            // 공지사항 API 호출
            const response = await apiRequest('/api/notices');
            console.log('공지사항 응답:', response);
            
            if (response.success && response.data) {
                // 사용자 지역에 맞는 공지사항 필터링 (전체 공지 + 해당 지역 공지)
                const filteredNotices = response.data.filter(notice => 
                    notice.region === 'all' || notice.region === userRegion
                );
                
                console.log('필터링된 공지사항:', filteredNotices.length);
                
                // 전역 데이터 저장
                window.noticesData = filteredNotices;
                
                // 공지사항 컨테이너 찾기
                const container = document.getElementById('noticesListSection');
                if (!container) {
                    console.error('공지사항 컨테이너를 찾을 수 없습니다: noticesListSection');
                    return;
                }
                
                // 공지사항 렌더링
                renderUserNoticesList(filteredNotices, container);
                
                // 이벤트 리스너 추가
                setTimeout(addDirectNoticeListeners, 200);
            } else {
                throw new Error('공지사항 데이터를 가져오는데 실패했습니다.');
            }
        } catch (error) {
            console.error('사용자 공지사항 로드 오류:', error);
            const container = document.getElementById('noticesListSection');
            if (container) {
                container.innerHTML = '<p class="text-center text-gray-500">공지사항을 불러오는데 실패했습니다.</p>';
            }
        }
    };

// 12. initializeUserDashboard 함수 패치 - 공지사항 로드 추가 (함수 외부로 이동)
const originalInitUserDashboard = window.initializeUserDashboard;
if (originalInitUserDashboard && !window.userDashboardPatched) {
    window.userDashboardPatched = true;
    window.initializeUserDashboard = async function() {
        // 원래 함수 호출
        await originalInitUserDashboard.apply(this, arguments);
        
        // 공지사항 로드 추가
        if (typeof window.loadUserNotices === 'function') {
            console.log('사용자 대시보드 초기화 후 공지사항 로드 호출');
            await window.loadUserNotices();
        }
    };
}
    
    console.log('독립적인 공지사항 모달 시스템 설정 완료');
    return true;
}

// 페이지 로드 후 실행
window.addEventListener('DOMContentLoaded', setupIndependentNoticeSystem);

// 공지사항 시스템 정리 함수
function cleanupNoticeSystem() {
  // 1. 기존 공지사항 관련 함수들 재정의
  window.showNoticeDetail = function(notice) {
    console.log('기존 showNoticeDetail 함수가 호출되었지만 무시됨');
    // 대신 새 시스템으로 리다이렉트
    const modal = document.getElementById('independentNoticeModal');
    if (modal) {
      document.getElementById('independentModalTitle').textContent = notice.title;
      document.getElementById('independentModalContent').textContent = notice.content;
      document.getElementById('independentModalAuthor').textContent = `작성자: ${notice.author || '관리자'}`;
      document.getElementById('independentModalDate').textContent = new Date(notice.created_at).toLocaleDateString();
      
      // 첨부파일 섹션 처리
      const attachmentSection = document.getElementById('independentModalAttachment');
      if (notice.attachment_url) {
        document.getElementById('independentModalFileName').textContent = notice.attachment_name || '첨부파일';
        document.getElementById('independentModalFileLink').href = notice.attachment_url;
        attachmentSection.style.display = 'block';
      } else {
        attachmentSection.style.display = 'none';
      }
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
  };
  
  window.closeNoticeDetail = function() {
    const modal = document.getElementById('independentNoticeModal');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
  };
  
  // 2. 기존 noticeDetailModal 비활성화
  const oldModal = document.getElementById('noticeDetailModal');
  if (oldModal) {
    oldModal.style.display = 'none';
    oldModal.classList.add('hidden');
    // 이벤트 리스너 제거
    oldModal.replaceWith(oldModal.cloneNode(true));
  }
  
  console.log('공지사항 시스템 정리 완료');
}

// 기존 DOMContentLoaded 이벤트 핸들러 백업
const originalDOMContentLoaded = window.addEventListener('DOMContentLoaded', function() {
  // 독립 공지사항 시스템 설정
  setupIndependentNoticeSystem();
  
  // 기존 시스템 정리
  setTimeout(cleanupNoticeSystem, 1500);
});

// 로그인 화면 함수 패치
const originalShowLoginScreen = window.showLoginScreen;
window.showLoginScreen = function() {
  // 모든 공지사항 모달 닫기
  const independentModal = document.getElementById('independentNoticeModal');
  if (independentModal) {
    independentModal.style.display = 'none';
    document.body.style.overflow = '';
  }
  
  const oldModal = document.getElementById('noticeDetailModal');
  if (oldModal) {
    oldModal.style.display = 'none';
    oldModal.classList.add('hidden');
  }
  
  // 원래 함수 호출
  return originalShowLoginScreen.apply(this, arguments);
};

// 기본 설정
const API_BASE_URL = 'https://sports-box-api.parkkwangmin9209.workers.dev';
const DEBUG = true;

// 시군 분류 데이터
const REGION_MAPPING = {
    south: [
        '과천시', '광명시', '광주시', '군포시', '김포시', '부천시', '성남시', 
        '수원시', '시흥시', '안산시', '안성시', '안양시', '양평군', '여주시', '오산시', 
        '용인시', '의왕시', '이천시', '평택시', '하남시', '화성시'
    ],
    north: [
        '고양시', '구리시', '남양주시', '동두천시', '양주시', '의정부시', 
        '파주시', '포천시', '가평군', '연천군'
    ]
};

// 11. 사용자 대시보드 공지사항 렌더링 함수
function renderUserNoticesList(notices, container) {
    try {
        if (!container) {
            console.error('공지사항 컨테이너 요소가 없습니다');
            return;
        }
        
        const sortedNotices = sortNoticesByImportanceAndDate(notices);
        if (!sortedNotices || sortedNotices.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 py-4">등록된 공지사항이 없습니다.</p>';
            return;
        }
        
        window.noticesData = sortedNotices;
        
        container.innerHTML = `
            <div class="overflow-y-auto max-h-[500px] pr-2">
                ${sortedNotices.map((notice, index) => {
                    const isImportant = notice.is_important === 1 || notice.is_important === '1' || notice.is_important === true;
                    const date = new Date(notice.created_at);
                    const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    
                    return `
                        <div class="notice-item ${isImportant ? 'important' : ''} bg-white rounded-lg shadow-md p-6 mb-4 hover:shadow-lg transition-shadow cursor-pointer"
                             data-notice-id="${index}" data-notice-real-id="${notice.id}">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold">
                                    ${isImportant ? '<span class="inline-block mr-2 px-2 py-1 bg-red-500 text-white text-xs font-semibold rounded-full">중요</span>' : ''}
                                    ${notice.title}
                                </h3>
                                <span class="text-sm text-gray-500">${formattedDate}</span>
                            </div>
                            <p class="text-gray-600 text-sm line-clamp-2">${notice.content}</p>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        setTimeout(addDirectNoticeListeners, 200);
    } catch (error) {
        console.error('사용자 대시보드 공지사항 렌더링 오류:', error);
        container.innerHTML = '<p class="text-center text-gray-500">공지사항을 표시하는 중 오류가 발생했습니다.</p>';
    }
}

// 공통 정렬 함수 (utils.js 또는 전역 스코프에 정의)
function sortNoticesByImportanceAndDate(notices) {
    if (!notices || !Array.isArray(notices)) return [];
    
    return [...notices].sort((a, b) => {
        const aImportant = Number(a.is_important || 0); // 기본값 0
        const bImportant = Number(b.is_important || 0);
        
        if (aImportant !== bImportant) return bImportant - aImportant; // 중요 공지 우선
        return new Date(b.created_at) - new Date(a.created_at); // 날짜 내림차순
    });
}

// 모달 상태 진단 함수
function diagnoseModalIssue() {
    const modal = document.getElementById('noticeDetailModal');
    if (!modal) {
        console.error('모달 요소를 찾을 수 없습니다');
        return;
    }
    
    const computedStyle = window.getComputedStyle(modal);
    console.log('모달 진단:', {
        element: modal,
        display: computedStyle.display,
        visibility: computedStyle.visibility,
        opacity: computedStyle.opacity,
        zIndex: computedStyle.zIndex,
        position: computedStyle.position,
        parentElement: modal.parentElement,
        classList: [...modal.classList]
    });
}

// 전역 객체에 디버깅 함수 노출
window.diagnoseModalIssue = diagnoseModalIssue;

// 모달 직접 제어 함수
function openModal(modalId) { 
    const modal = document.getElementById(modalId); 
    if (!modal) { 
        console.error(`Modal with ID ${modalId} not found`); 
        return; 
    }
    console.log(`Opening modal: ${modalId}`);
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // 배경 스크롤 방지

    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
} // openModal 함수 닫기

function closeModal(modalId) { 
    const modal = document.getElementById(modalId); 
    if (!modal) return;
    console.log(`Closing modal: ${modalId}`);
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }, 300);
} // closeModal 함수 닫기

// 홈화면 공지사항 로드
async function loadHomeNotices() {
    try {
        console.log('홈화면 공지사항 로드 시작');
        
        // 공개 API 경로 사용
        const response = await fetch(`${API_BASE_URL}/api/public/notices`);
        
        if (!response.ok) {
            console.warn('공지사항을 불러오는데 실패했습니다:', response.status);
            document.getElementById('homeNoticesList').innerHTML = 
                '<p class="text-center text-gray-500">현재 공지사항을 불러올 수 없습니다.</p>';
            return;
        }
        
        const data = await response.json();
        const noticesList = document.getElementById('homeNoticesList');

        if (data.success && data.data && data.data.length > 0) {
            console.log('원본 공지사항 데이터:', data.data);
            // 공통 정렬 함수 사용
            const sortedNotices = sortNoticesByImportanceAndDate(data.data);
            console.log('정렬된 공지사항 데이터:', sortedNotices);
            
            // 공지사항 데이터를 전역 객체에 저장
            window.noticesData = sortedNotices;
            
            // HTML 생성 - 새로운 디자인 적용
            noticesList.innerHTML = `
                <div class="notice-tabs mb-4 border-b">
                    <div class="flex">
                        <h3 class="text-2xl font-bold mr-4 pb-2 border-b-2 border-blue-500 text-blue-500">소식</h3>
                    </div>
                </div>
                <div class="notice-list space-y-6 overflow-y-auto max-h-[500px] pr-2">
                    ${sortedNotices.map((notice, index) => {
                        // 날짜 형식 변환
                        const date = new Date(notice.created_at);
                        const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        
                        // 내용 요약 (100자 제한)
                        const contentSummary = notice.content.length > 100 
                            ? notice.content.substring(0, 100) + '...' 
                            : notice.content;
                        
                        return `
                            <div class="notice-item border-b pb-6 cursor-pointer" data-notice-id="${index}" data-notice-real-id="${notice.id}">
                                <div class="flex items-start justify-between">
                                    <div class="notice-content flex-1 pr-4">
                                        <h4 class="text-xl font-bold mb-2 text-gray-800 flex items-center justify-between">
                                            <span class="flex items-center">
                                                ${notice.is_important ? 
                                                    '<span class="inline-block mr-2 px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full">중요</span>' : 
                                                    ''}
                                                ${notice.title}
                                            </span>
                                            <span class="text-sm text-gray-500 font-normal">${formattedDate}</span>
                                        </h4>
                                        <p class="text-gray-600 text-sm line-clamp-1">${contentSummary.replace(/\n/g, ' ')}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // 이벤트 리스너 추가는 독립 시스템에 위임
            setTimeout(addDirectNoticeListeners, 100);
            
        } else {
            noticesList.innerHTML = '<p class="text-center text-gray-500">등록된 공지사항이 없습니다.</p>';
        }
        
        checkAdminStatus();
        console.log('홈화면 공지사항 로드 완료');
    } catch (error) {
        console.error('Home notices loading error:', error);
        document.getElementById('homeNoticesList').innerHTML = 
            '<p class="text-center text-gray-500">공지사항을 불러오는 중 오류가 발생했습니다.</p>';
    }
}

// 공지사항 목록 렌더링 함수 수정 (대시보드용)
function renderNoticesList(notices, containerId) {
    try {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error(`컨테이너 요소를 찾을 수 없음: ${containerId}`);
            return;
        }
        
        const sortedNotices = sortNoticesByImportanceAndDate(notices);
        
        if (!sortedNotices || sortedNotices.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 py-4">등록된 공지사항이 없습니다.</p>';
            return;
        }

        console.log(`${containerId}에 ${sortedNotices.length}개 공지사항 렌더링 시작`);

        window.noticesData = sortedNotices;
        
        container.innerHTML = `
            <div class="overflow-y-auto max-h-[500px] pr-2">
                ${sortedNotices.map((notice, index) => {
                    const rawIsImportant = notice.is_important;
                    const isImportant = rawIsImportant === 1 || rawIsImportant === '1' || rawIsImportant === true;
                    
                    console.log(`공지사항 ${notice.title}: rawIsImportant = ${rawIsImportant}, typeof = ${typeof rawIsImportant}, isImportant = ${isImportant}`);
                    
                    const date = new Date(notice.created_at);
                    const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    
                    return `
                        <div class="notice-item bg-white rounded-lg shadow-md p-6 mb-4 hover:shadow-lg transition-shadow cursor-pointer ${isImportant ? 'border-l-4 border-red-500' : ''}"
                             data-notice-id="${index}" data-notice-real-id="${notice.id}">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold flex items-center">
                                    ${isImportant ? 
                                        '<span class="inline-block mr-2 px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full">중요</span>' : 
                                        ''}
                                    ${notice.title}
                                </h3>
                                <span class="text-sm text-gray-500">${formattedDate}</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${notice.content}</p>
                            <div class="flex justify-end">
                                <span class="px-2 py-1 rounded-full text-xs ${
                                    notice.region === 'all' ? 'bg-purple-100 text-purple-800' :
                                    notice.region === 'south' ? 'bg-blue-100 text-blue-800' :
                                    'bg-green-100 text-green-800'
                                }">
                                    ${notice.region === 'all' ? '전체공지' :
                                      notice.region === 'south' ? '남부공지' : '북부공지'}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        console.log(`${containerId}에 공지사항 렌더링 완료`);
        
        setTimeout(() => {
            const noticeItems = document.querySelectorAll('.notice-item');
            console.log(`이벤트 리스너 추가 전 공지사항 항목 수: ${noticeItems.length}`);
            
            noticeItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    const noticeId = parseInt(this.getAttribute('data-notice-id'));
                    const realNoticeId = parseInt(this.getAttribute('data-notice-real-id'));
                    
                    console.log(`공지사항 클릭: ID=${noticeId}, 실제ID=${realNoticeId}`);
                    
                    if (window.noticesData && noticeId >= 0 && noticeId < window.noticesData.length) {
                        const notice = window.noticesData[noticeId];
                        showNoticeDetail(notice);
                    }
                });
            });
            
            console.log(`${noticeItems.length}개 공지사항에 이벤트 리스너 추가 완료`);
        }, 100);
        
    } catch (error) {
        console.error('공지사항 렌더링 오류:', error);
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '<p class="text-center text-gray-500">공지사항을 표시하는 중 오류가 발생했습니다.</p>';
        }
    }
}

// 공지사항 상세 보기 함수
function showNoticeDetail(notice) {
    console.log('모달 표시 함수 호출:', notice);
    
    // 모달 내용 업데이트
    document.getElementById('noticeDetailTitle').textContent = notice.title;
    document.getElementById('noticeDetailContent').textContent = notice.content;
    
    const authorElement = document.getElementById('noticeDetailAuthor');
    if (authorElement) {
        authorElement.textContent = `작성자: ${notice.author || '관리자'}`;
    }
    
    const dateElement = document.getElementById('noticeDetailDate');
    if (dateElement) {
        dateElement.textContent = new Date(notice.created_at).toLocaleDateString();
    }
    
    // 관리자 권한 확인 및 버튼 표시
    const noticeDetailActions = document.getElementById('noticeDetailActions');
    if (noticeDetailActions) {
        const isAdmin = sessionStorage.getItem('role') === 'admin';
        // 관리자인 경우 버튼 표시
        if (isAdmin) {
            noticeDetailActions.classList.remove('hidden');
            // 현재 공지사항 ID 저장 (수정/삭제 시 사용)
            currentNoticeId = notice.id;
        } else {
            noticeDetailActions.classList.add('hidden');
        }
    }
    
    // 모달 표시
    const modal = document.getElementById('noticeDetailModal');
    if (!modal) {
        console.error('모달 요소를 찾을 수 없음');
        return;
    }
    
    // 모달 표시
    modal.classList.remove('hidden');
    modal.classList.add('show');
    modal.style.display = 'flex';
    modal.style.opacity = '1';
    modal.style.visibility = 'visible';
    modal.style.zIndex = '99999'; // 매우 높은 z-index 설정
    
    // 배경 스크롤 방지
    document.body.style.overflow = 'hidden';
    
    console.log('모달 표시 완료');
}

function showNoticeDetailFromElement(element) {
    try {
        console.log('Showing notice from element:', element);
        
        // data-notice 속성에서 공지사항 데이터 가져오기
        const noticeData = element.getAttribute('data-notice');
        if (!noticeData) {
            console.error('No notice data found in element');
            return;
        }
        
        const notice = JSON.parse(noticeData);
        showNoticeDetail(notice);
    } catch (error) {
        console.error('Error showing notice detail from element:', error);
        showAlert('공지사항을 표시하는 중 오류가 발생했습니다.', 'error');
    }
}

// 모달 닫기 함수 (기존 함수 대체)
function closeNoticeDetail() {
    const modal = document.getElementById('noticeDetailModal');
    if (!modal) return;
    
    // 모달 숨기기
    modal.classList.add('hidden');
    modal.classList.remove('show');
    modal.style.display = 'none';
    
    // 배경 스크롤 복원
    document.body.style.overflow = '';
    
    // 현재 공지사항 ID 초기화
    currentNoticeId = null;
    
    console.log('모달 닫힘');
}

// 공지사항 수정 모달 HTML 추가 (body 끝 부분에 추가)
const noticeEditModalHTML = `
<div id="noticeEditModal" class="modal">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-2xl m-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">공지사항 수정</h2>
            <button onclick="closeNoticeEditModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="noticeEditForm" class="space-y-4">
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">제목</label>
                <input type="text" id="editNoticeTitle" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">내용</label>
                <textarea id="editNoticeContent" required rows="6"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">공개 범위</label>
                <select id="editNoticeRegion" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="">선택해주세요</option>
                    <option value="all">전체 공개</option>
                    <option value="south">남부 지역만</option>
                    <option value="north">북부 지역만</option>
                </select>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="editNoticeImportant" class="w-4 h-4 text-blue-600 rounded">
                <label for="editNoticeImportant" class="ml-2 text-gray-700 text-sm font-bold">중요 공지</label>
            </div>
            <button type="submit" 
                class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition duration-200">
                수정하기
            </button>
        </form>
    </div>
</div>`;

// body에 모달 HTML 추가
document.body.insertAdjacentHTML('beforeend', noticeEditModalHTML);

// 수정 버튼 클릭 시 호출되는 함수
function editNotice() {
    console.log('수정 버튼 클릭됨, currentNoticeId:', window.currentNoticeId);
    
    if (!window.currentNoticeId) {
        showAlert('공지사항 ID를 찾을 수 없습니다. 페이지를 새로고침 후 다시 시도해주세요.', 'error');
        return;
    }
    
    // 현재 공지사항 정보 가져오기
    const notice = window.noticesData.find(n => n.id === window.currentNoticeId);
    if (!notice) {
        // ID로 찾지 못한 경우 모든 공지사항 확인
        console.log('ID로 찾지 못함, 전체 데이터:', window.noticesData);
        showAlert('공지사항 정보를 찾을 수 없습니다.', 'error');
        return;
    }
    
    // 수정 모달에 기존 정보 표시
    document.getElementById('editNoticeTitle').value = notice.title;
    document.getElementById('editNoticeContent').value = notice.content;
    document.getElementById('editNoticeRegion').value = notice.region || 'all';
    document.getElementById('editNoticeImportant').checked = notice.is_important === 1;
    
    // 공지사항 상세 모달 닫기
    document.getElementById('independentNoticeModal').style.display = 'none';
    
    // 수정 모달 열기
    openModal('noticeEditModal');
}

// 수정 모달 닫기 함수
function closeNoticeEditModal() {
    closeModal('noticeEditModal');
    document.getElementById('noticeEditForm').reset();
}

function initializeNoticeListeners() {
    const noticesList = document.getElementById('homeNoticesList');
    if (!noticesList) return;
    
    noticesList.addEventListener('click', function(e) {
        const noticeItem = e.target.closest('.notice-item');
        if (noticeItem) {
            // 중요: 이벤트 전파 중지
            e.preventDefault();
            e.stopPropagation();
            
            const noticeId = parseInt(noticeItem.getAttribute('data-notice-id'));
            if (window.noticesData && noticeId >= 0 && noticeId < window.noticesData.length) {
                showNoticeDetail(window.noticesData[noticeId]);
            }
        }
    });
    
    console.log('공지사항 클릭 이벤트 리스너 등록 완료');
}

// 공지사항 삭제
async function deleteNotice() {
    if (!currentNoticeId) {
        showAlert('공지사항 정보를 찾을 수 없습니다.', 'error');
        return;
    }
    
    // 삭제 확인
    if (!confirm('정말 이 공지사항을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        showLoading();
        
        // API 요청
        const response = await fetch(`${API_BASE_URL}/api/admin/notices/${currentNoticeId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || '공지사항 삭제 중 오류가 발생했습니다.');
        }
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('공지사항이 삭제되었습니다.', 'success');
            closeNoticeDetail();
            // 공지사항 목록 새로고침
            await loadHomeNotices();
            // 대시보드에 있는 경우 해당 목록도 새로고침
            if (document.getElementById('noticesListSection')) {
                await loadNotices();
            }
        } else {
            throw new Error(data.message || '공지사항 삭제에 실패했습니다.');
        }
    } catch (error) {
        console.error('Notice deletion error:', error);
        showAlert(error.message || '공지사항 삭제 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
}

// 공지사항 작성 모달 컨트롤
function showNoticeWriteModal() {
    openModal('noticeWriteModal');
}

function closeNoticeWriteModal() {
    closeModal('noticeWriteModal');
    document.getElementById('noticeWriteForm').reset();
}

// 공지사항 폼 제출 함수 추가 (modifyNoticeFormWithGithubConverter 함수 대체)
document.getElementById('noticeWriteForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const attachment = document.getElementById('noticeFile').files[0];
        
        // 첨부파일이 있는 경우 알림 표시
        if (attachment) {
            const fileSize = (attachment.size / 1024 / 1024).toFixed(2);
            showAlert(`${fileSize}MB 파일 업로드 중... 잠시만 기다려주세요.`, 'info', 0); // 자동으로 닫히지 않음
        }
        
        showLoading();
        
        const noticeData = {
            title: document.getElementById('noticeTitle').value,
            content: document.getElementById('noticeContent').value,
            region: document.getElementById('noticeRegion').value,
            is_important: document.getElementById('noticeImportant').checked,
            attachment: attachment
        };
        
        await createNotice(noticeData);
        closeNoticeWriteModal();
        
        // 알림 숨기기
        hideAlert();
        
    } catch (error) {
        console.error('Notice form submission error:', error);
        showAlert(error.message || '공지사항 등록 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
});

// 로그인 상태 체크 및 관리자 기능 표시
function checkAdminStatus() {
    const isAdmin = sessionStorage.getItem('role') === 'admin';
    
    // 홈 화면의 공지사항 섹션에 있는 버튼
    const noticeActions = document.getElementById('noticeActions');
    
    console.log('Admin status check:', {
        role: sessionStorage.getItem('role'),
        isAdmin: isAdmin,
        noticeActionsFound: noticeActions ? true : false
    });
    
    if (noticeActions) {
        if (isAdmin) {
            // 여러 방법으로 확실하게 표시
            noticeActions.classList.remove('hidden');
            noticeActions.style.display = 'block';
            noticeActions.style.visibility = 'visible';
            noticeActions.style.opacity = '1';
            console.log('Admin detected: Showing write button with multiple style overrides');
        } else {
            noticeActions.classList.add('hidden');
            noticeActions.style.display = 'none';
            console.log('Not admin: Hiding write button');
        }
    } else {
        console.warn('Notice actions element not found - trying to find by selector');
        // 선택자로 시도
        const actionsBySelector = document.querySelector('#notices .flex.justify-between div:last-child');
        if (actionsBySelector && isAdmin) {
            actionsBySelector.classList.remove('hidden');
            actionsBySelector.style.display = 'block';
            console.log('Found by selector and showing');
        }
    }
}

// 페이지 로드 시 실행
document.addEventListener('DOMContentLoaded', function() {
    // 공지사항 로드
    loadHomeNotices();
    checkAdminStatus();
    initializeInquirySystem();
    
    document.getElementById('inquiryFile')?.addEventListener('change', function() {
        const fileNameSpan = document.getElementById('inquirySelectedFileName');
        if (this.files.length > 0) {
            const fileName = this.files[0].name;
            const fileSize = (this.files[0].size / 1024 / 1024).toFixed(2); // MB 단위
            fileNameSpan.textContent = `${fileName} (${fileSize}MB)`;
            fileNameSpan.classList.remove('text-gray-600');
            fileNameSpan.classList.add('text-blue-600');
        } else {
            fileNameSpan.textContent = '선택된 파일 없음';
            fileNameSpan.classList.remove('text-blue-600');
            fileNameSpan.classList.add('text-gray-600');
        }
    });
    
    document.getElementById('inquiryAnswerForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!currentInquiryId) {
            showAlert('문의사항 정보를 찾을 수 없습니다.', 'error');
            return;
        }
        
        const answerContent = document.getElementById('adminAnswerContent').value.trim();
        if (!answerContent) {
            showAlert('답변 내용을 입력해주세요.', 'error');
            return;
        }
        
        try {
            showLoading();
            
            const response = await apiRequest(`/api/admin/inquiries/${currentInquiryId}/answer`, {
                method: 'POST',
                body: JSON.stringify({ answer: answerContent })
            });
            
            if (response.success) {
                showAlert('답변이 등록되었습니다.', 'success');
                closeInquiryDetailModal();
                
                // 관리자 대시보드인 경우 목록 새로고침
                if (!document.getElementById('adminDashboard').classList.contains('hidden')) {
                    loadAdminInquiries();
                } else {
                    // 문의사항 페이지인 경우
                    loadInquiries();
                }
            } else {
                throw new Error(response.message || '답변 등록에 실패했습니다.');
            }
        } catch (error) {
            console.error('Inquiry answer error:', error);
            showAlert(error.message || '답변 등록 중 오류가 발생했습니다.', 'error');
        } finally {
            hideLoading();
        }
    });

    // 디버깅 함수 전역으로 노출
    window.diagnoseModalIssue = diagnoseModalIssue;
    
    // 홈으로 돌아갈 때도 공지사항 새로고침
    document.querySelectorAll('button[onclick="showHomeScreen()"]').forEach(button => {
        const originalClick = button.onclick;
        button.onclick = async function() {
            originalClick.call(this);
            await loadHomeNotices();
            checkAdminStatus();
        };
    });
    
    // 공지사항 모달 초기화 및 개선
    initializeNoticeModal();
    
    // 디버깅 함수 추가 - 전역 스코프에 정의
    window.debugNotices = function() {
    console.log('===== 공지사항 디버깅 =====');
    console.log('독립 모달 존재:', !!document.getElementById('independentNoticeModal'));
    console.log('공지사항 데이터:', window.noticesData);
    console.log('공지사항 컨테이너:', document.getElementById('noticesListSection'));
    console.log('loadUserNotices 함수:', typeof window.loadUserNotices);
    console.log('handleNoticeClick 함수:', typeof window.handleNoticeClick);
    console.log('로그인 상태:', !!sessionStorage.getItem('token'));
    console.log('===========================');
    
    // 중요: 로그인 상태일 때만 API 호출
    if (sessionStorage.getItem('token') && 
        document.getElementById('noticesListSection') && 
        typeof window.loadUserNotices === 'function') {
        console.log('공지사항 강제 로드 시도');
        window.loadUserNotices();
    }
};
    
    // 3초 후 디버깅 실행 (페이지 로드 후)
    setTimeout(window.debugNotices, 3000);
    
    // 파일 선택 이벤트 리스너 추가
    setTimeout(() => {
        const fileInput = document.getElementById('noticeFile');
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                const fileNameSpan = document.getElementById('selectedFileName');
                if (this.files.length > 0) {
                    const fileName = this.files[0].name;
                    const fileSize = (this.files[0].size / 1024 / 1024).toFixed(2); // MB 단위
                    fileNameSpan.textContent = `${fileName} (${fileSize}MB)`;
                    fileNameSpan.classList.remove('text-gray-600');
                    fileNameSpan.classList.add('text-blue-600');
                } else {
                    fileNameSpan.textContent = '선택된 파일 없음';
                    fileNameSpan.classList.remove('text-blue-600');
                    fileNameSpan.classList.add('text-gray-600');
                }
            });
        }
    }, 2000);
});

// 첨부파일 다운로드 링크 수정을 위한 주기적 확인
setInterval(function() {
    const fileLinks = document.querySelectorAll('#independentModalFileLink, #noticeDetailModalFileLink');
    fileLinks.forEach(link => {
        if (link && link.href && link.href.includes('r2.dev')) {
            const originalUrl = link.href;
            const downloadUrl = getDownloadUrl(originalUrl);
            link.href = downloadUrl;
            link.setAttribute('download', link.textContent.trim());
        }
    });
}, 1000);

// 수정 폼 제출 이벤트 리스너
document.getElementById('noticeEditForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        // ID 확인
        if (!window.currentNoticeId) {
            throw new Error('공지사항 ID를 찾을 수 없습니다.');
        }
        
        console.log('수정 제출 - 공지사항 ID:', window.currentNoticeId);
        
        showLoading();
        
        // 수정할 데이터 준비
        const formData = {
            title: document.getElementById('editNoticeTitle').value,
            content: document.getElementById('editNoticeContent').value,
            region: document.getElementById('editNoticeRegion').value,
            is_important: document.getElementById('editNoticeImportant').checked ? 1 : 0
        };
        
        console.log('수정 데이터:', formData); // 디버깅 로그 추가
        
        // API 요청
        const response = await fetch(`${API_BASE_URL}/api/admin/notices/${window.currentNoticeId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('token')}`
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || '공지사항 수정 중 오류가 발생했습니다.');
        }
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('공지사항이 수정되었습니다.', 'success');
            closeNoticeEditModal();
            
            // 공지사항 데이터 직접 새로 가져오기
            try {
                console.log('공지사항 데이터 새로고침 시작');
                
                // API에서 최신 데이터 가져오기
                const noticesResponse = await apiRequest('/api/notices');
                if (noticesResponse.success && noticesResponse.data) {
                    console.log(`${noticesResponse.data.length}개 공지사항 데이터 받음`);
                    
                    // 새로 가져온 데이터 정렬 및 저장
                    window.noticesData = sortNoticesByImportanceAndDate(noticesResponse.data);
                    console.log('공지사항 데이터 새로 가져와서 정렬 완료');
                    
                    // 홈화면 공지사항 목록 다시 렌더링
                    if (document.getElementById('homeNoticesList')) {
                        console.log('홈화면 공지사항 목록 렌더링 시작');
                        renderNoticesList(window.noticesData, 'homeNoticesList');
                    }
                    
                    // 대시보드 공지사항 목록 다시 렌더링
                    if (document.getElementById('noticesListSection')) {
                        console.log('대시보드 공지사항 목록 렌더링 시작');
                        // 함수가 정의되어 있는지 확인 후 호출
                        if (typeof renderUserNoticesList === 'function') {
                            renderUserNoticesList(window.noticesData, document.getElementById('noticesListSection'));
                        } else {
                            console.warn('renderUserNoticesList 함수가 정의되지 않았습니다');
                            // 대체 방법으로 일반 renderNoticesList 함수 사용
                            renderNoticesList(window.noticesData, 'noticesListSection');
                        }
                    }
                }
            } catch (fetchError) {
                console.error('공지사항 데이터 새로고침 오류:', fetchError);
                // 기존 방식으로 폴백
                console.log('기존 방식으로 공지사항 새로고침 시도');
                await loadHomeNotices();
                if (document.getElementById('noticesListSection')) {
                    await loadNotices();
                }
            }
            
            // 중요: 이벤트 리스너 다시 추가 (지연 시간 증가)
            setTimeout(addDirectNoticeListeners, 500);
        } else {
            throw new Error(data.message || '공지사항 수정에 실패했습니다.');
        }
    } catch (error) {
        console.error('Notice update error:', error);
        showAlert(error.message || '공지사항 수정 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
});

// 공지사항 모달 초기화 함수 - 페이지 로드 시 즉시 실행
function initializeNoticeModal() {
  console.log('공지사항 모달 초기화 시작');
  
  // 독립 공지사항 모달이 없으면 생성
  if (!document.getElementById('independentNoticeModal')) {
    console.log('독립 공지사항 모달 생성');
    const modalHTML = `
      <div id="independentNoticeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
          background-color:rgba(0,0,0,0.75); z-index:99999; align-items:center; justify-content:center;">
          <div style="background:white; max-width:800px; width:90%; border-radius:10px; padding:20px; position:relative; max-height:80vh; overflow-y:auto;">
              <button id="independentModalClose" style="position:absolute; top:10px; right:10px; background:none; border:none; 
              font-size:24px; cursor:pointer; width:30px; height:30px; line-height:30px; text-align:center;">×</button>
              <h2 id="independentModalTitle" style="margin-bottom:15px; font-size:22px; font-weight:bold;"></h2>
              <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; color:#666;">
                  <span id="independentModalAuthor"></span>
                  <span id="independentModalDate"></span>
              </div>
              <div style="border-top:1px solid #eee; padding-top:15px;">
                  <p id="independentModalContent" style="white-space:pre-line; line-height:1.5;"></p>
              </div>
          </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // 모달 닫기 버튼 이벤트
    document.getElementById('independentModalClose').onclick = function() {
      document.getElementById('independentNoticeModal').style.display = 'none';
      document.body.style.overflow = '';
    };
    
    // 모달 외부 클릭 시 닫기
    document.getElementById('independentNoticeModal').onclick = function(e) {
      if (e.target === this) {
        this.style.display = 'none';
        document.body.style.overflow = '';
      }
    };
  }
  
  // 첨부파일 섹션 추가
  enhanceNoticeDetailModal();
}

// 공지사항 상세 모달 개선 함수
function enhanceNoticeDetailModal() {
  console.log('공지사항 상세 모달 개선 시작');
  
  // 독립 모달에 첨부파일 섹션 추가
  const modal = document.getElementById('independentNoticeModal');
  if (!modal) {
    console.error('independentNoticeModal을 찾을 수 없습니다');
    return;
  }
  
  const modalContent = modal.querySelector('div:first-child');
  if (!modalContent) {
    console.error('모달 컨텐츠 요소를 찾을 수 없습니다');
    return;
  }
  
  // 1. 첨부파일 섹션이 이미 있는지 확인 후 추가
  if (!document.getElementById('independentModalAttachment')) {
    const attachmentSection = document.createElement('div');
    attachmentSection.id = 'independentModalAttachment';
    attachmentSection.style.marginTop = '20px';
    attachmentSection.style.paddingTop = '15px';
    attachmentSection.style.borderTop = '1px solid #eee';
    attachmentSection.style.display = 'none';
    
    attachmentSection.innerHTML = `
      <h3 style="font-weight:bold; margin-bottom:10px; font-size:16px;">첨부파일</h3>
      <div id="independentModalFile" style="display:flex; align-items:center;">
        <a id="independentModalFileLink" href="#" target="_blank" download
           style="display:inline-flex; align-items:center; padding:8px 12px; background:#f3f4f6; border-radius:4px; text-decoration:none; color:#374151; font-size:14px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" style="margin-right:8px;" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
          </svg>
          <span id="independentModalFileName">파일 다운로드</span>
        </a>
      </div>
    `;
    
    modalContent.appendChild(attachmentSection);
    console.log('첨부파일 섹션이 모달에 추가되었습니다');
  }
  
  // 2. 관리자 액션 버튼 추가 (없는 경우에만)
  if (!document.getElementById('independentModalActions')) {
    const adminActions = document.createElement('div');
    adminActions.id = 'independentModalActions';
    adminActions.style.display = 'flex';
    adminActions.style.justifyContent = 'flex-end';
    adminActions.style.marginTop = '20px';
    adminActions.style.paddingTop = '15px';
    adminActions.style.borderTop = '1px solid #eee';
    adminActions.innerHTML = `
      <button id="editNoticeBtn" style="background:#3B82F6; color:white; padding:8px 16px; border-radius:4px; margin-right:8px; cursor:pointer; border:none;">수정</button>
      <button id="deleteNoticeBtn" style="background:#EF4444; color:white; padding:8px 16px; border-radius:4px; cursor:pointer; border:none;">삭제</button>
    `;
    adminActions.style.display = 'none'; // 기본적으로 숨김
    
    modalContent.appendChild(adminActions);
    console.log('관리자 액션 버튼이 모달에 추가되었습니다');
    
    // 버튼 이벤트 리스너 추가
    document.getElementById('editNoticeBtn').addEventListener('click', function() {
      modal.style.display = 'none';
      editNotice(); // 기존 수정 함수 호출
    });
    
    document.getElementById('deleteNoticeBtn').addEventListener('click', function() {
      deleteNotice(); // 기존 삭제 함수 호출
    });
  }
}
  
  // 공지사항 목록 로드 후 이벤트 리스너 재설정
  const originalLoadHomeNotices = window.loadHomeNotices;
  if (originalLoadHomeNotices) {
    window.loadHomeNotices = async function() {
      await originalLoadHomeNotices.apply(this, arguments);
      
      // 공지사항 항목에 이벤트 리스너 다시 추가
      setTimeout(() => {
        const noticeItems = document.querySelectorAll('.notice-item');
        console.log('공지사항 항목 수:', noticeItems.length);
        
        noticeItems.forEach(item => {
          // 기존 이벤트 제거
          const clone = item.cloneNode(true);
          item.parentNode.replaceChild(clone, item);
          
          // 새 이벤트 추가
          clone.addEventListener('click', window.handleNoticeClick);
        });
        
        console.log('공지사항 이벤트 리스너 재설정 완료');
      }, 500);
    };
  }
  
  // 현재 표시된 공지사항에 이벤트 리스너 즉시 추가
  setTimeout(() => {
    const noticeItems = document.querySelectorAll('.notice-item');
    console.log('현재 공지사항 항목 수:', noticeItems.length);
    
    noticeItems.forEach(item => {
      // 기존 이벤트 제거
      const clone = item.cloneNode(true);
      item.parentNode.replaceChild(clone, item);
      
      // 새 이벤트 추가
      clone.addEventListener('click', window.handleNoticeClick);
    });
    
    console.log('현재 공지사항 이벤트 리스너 설정 완료');
  }, 500);

    // 시군 선택 드롭다운 초기화 수정
    function initializeCitySelect() {
    const citySelect = document.getElementById('city');
    citySelect.innerHTML = '<option value="">시/군을 선택하세요</option>';
    
    // 모든 시군을 알파벳 순으로 정렬
    [...REGION_MAPPING.south, ...REGION_MAPPING.north]  // REGION_MAPPING 사용
        .sort()
        .forEach(city => {
            citySelect.innerHTML += `<option value="${city}">${city}</option>`;
        });
}

// 시군 선택에 따른 지역 자동 분류 함수 (에러 처리만 추가)
function determineRegion(city) {
    if (REGION_MAPPING.south.includes(city)) return 'south';
    if (REGION_MAPPING.north.includes(city)) return 'north';
    throw new Error('올바른 시/군을 선택해주세요.');  // null 반환 대신 에러 발생
}

// 전역 상태 관리
let currentUser = null;
let bookingStatus = {};
let isLoading = false;
let currentSelectedDate = null;
let currentNoticeId = null;
let isSubmittingInquiry = false; // 플래그 추가

// 로딩 인디케이터 제어
function showLoading() {
    if (!isLoading) {
        isLoading = true;
        document.getElementById('loading').classList.add('show');
    }
}

function hideLoading() {
    isLoading = false;
    document.getElementById('loading').classList.remove('show');
}

// 디버깅 함수
function debugNotices() {
    console.log('=== 공지사항 디버깅 ===');
    console.log('noticesData:', window.noticesData);
    
    // 홈화면 공지사항
    const homeNotices = document.getElementById('homeNoticesList');
    if (homeNotices) {
        console.log('homeNoticesList 요소:', homeNotices);
        console.log('homeNoticesList 공지사항 항목 수:', homeNotices.querySelectorAll('.notice-item').length);
    } else {
        console.log('homeNoticesList 요소가 없음');
    }
    
    // 대시보드 공지사항
    const dashboardNotices = document.getElementById('noticesListSection');
    if (dashboardNotices) {
        console.log('noticesListSection 요소:', dashboardNotices);
        console.log('noticesListSection 공지사항 항목 수:', dashboardNotices.querySelectorAll('.notice-item').length);
    } else {
        console.log('noticesListSection 요소가 없음');
    }
    
    console.log('======================');
}

// 전역 스코프에 함수 노출
window.debugNotices = debugNotices;

// 알림 메시지 표시
function showAlert(message, type = 'info', duration = 3000) {
    const alert = document.getElementById('alert');
    const alertMessage = document.getElementById('alertMessage');
    const alertIcon = document.getElementById('alertIcon').firstElementChild;

    alertMessage.textContent = message;
    alert.classList.remove('hidden');

    switch(type) {
        case 'success':
            alertIcon.className = 'fas fa-check-circle text-green-500';
            break;
        case 'error':
            alertIcon.className = 'fas fa-exclamation-circle text-red-500';
            break;
        default:
            alertIcon.className = 'fas fa-info-circle text-blue-500';
    }

    if (duration > 0) {
        setTimeout(hideAlert, duration);
    }
}

function hideAlert() {
    document.getElementById('alert').classList.add('hidden');
}

// 첨부파일 URL을 다운로드 URL로 변환하는 함수
function getDownloadUrl(attachmentUrl) {
    if (!attachmentUrl) return '';
    const fileName = attachmentUrl.split('/').pop();
    return `https://sports-box-api.parkkwangmin9209.workers.dev/api/attachments/${fileName}`;
}

// 첨부파일 링크를 강제로 다운로드하게 만드는 함수
function forceFileDownload(url, fileName) {
    // 링크를 새로 생성하여 download 속성 설정
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName || 'download';
    link.target = '_blank';
    
    // 링크를 DOM에 추가하고 클릭 이벤트 발생
    document.body.appendChild(link);
    link.click();
    
    // 링크 제거
    setTimeout(() => {
        document.body.removeChild(link);
    }, 100);
    
    return false; // 기본 동작 방지
}

// DOMContentLoaded 내에 다음 코드 추가
document.addEventListener('DOMContentLoaded', function() {
    // 기존 코드...
    
    // 모든 첨부파일 링크에 클릭 이벤트 추가 (주기적 체크)
    setInterval(function() {
        const fileLinks = document.querySelectorAll('#independentModalFileLink, #noticeDetailModalFileLink');
        fileLinks.forEach(link => {
            // 이미 처리된 링크 건너뛰기
            if (link.getAttribute('data-download-handler')) return;
            
            // 처리 표시 추가
            link.setAttribute('data-download-handler', 'true');
            
            // 기본 href 수정
            if (link.href && link.href.includes('r2.dev')) {
                const originalUrl = link.href;
                const downloadUrl = getDownloadUrl(originalUrl);
                link.href = downloadUrl;
            }
            
            // 클릭 이벤트 추가
            link.addEventListener('click', function(e) {
                e.preventDefault(); // 기본 동작 방지
                e.stopPropagation(); // 이벤트 버블링 방지
                
                const fileName = this.textContent.trim() || 'download';
                forceFileDownload(this.href, fileName);
                
                return false;
            });
        });
    }, 1000);
});

// 이벤트 리스너 정리 함수
function cleanupEventListeners() {
    // 공지사항 목록 이벤트 리스너 제거
    const noticesList = document.getElementById('homeNoticesList');
    if (noticesList) {
        const newElement = noticesList.cloneNode(true);
        noticesList.parentNode.replaceChild(newElement, noticesList);
        console.log('공지사항 이벤트 리스너 정리됨');
    }
}

// 남은 예약 횟수 표시 업데이트 함수
function updateRemainingBookingsDisplay(remainingBookings) {
    const bookingCountElement = document.getElementById('remainingBookings');
    if (bookingCountElement) {
        bookingCountElement.textContent = `이번 달 남은 예약 가능 횟수: ${remainingBookings}회`;
        bookingCountElement.className = remainingBookings > 0 ? 
            'px-4 py-2 bg-green-50 text-green-700 rounded-full text-sm font-medium' : 
            'px-4 py-2 bg-red-50 text-red-700 rounded-full text-sm font-medium';
    }
}

// API 요청 헬퍼 함수
async function apiRequest(endpoint, options = {}) {
    showLoading();
    try {
        const token = sessionStorage.getItem('token');
        if (!token && !endpoint.includes('/login') && !endpoint.includes('/signup') 
            && !endpoint.includes('/public')) {
            throw new Error('인증이 필요합니다.');
        }

        const defaultHeaders = {
            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        };
        if (options.body && !(options.body instanceof FormData)) {
            defaultHeaders['Content-Type'] = 'application/json';
        }

        console.log(`[apiRequest] 요청: ${endpoint}`, {
            method: options.method,
            headers: { ...defaultHeaders, ...options.headers },
            body: options.body instanceof FormData ? '[FormData]' : options.body
        });
        
        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            ...options,
            headers: {
                ...defaultHeaders,
                ...options.headers
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (!endpoint.includes('/login')) {
            console.log(`[apiRequest] 응답:`, data);
        }
        return data;
    } catch (error) {
        console.error(`[apiRequest] 오류: ${endpoint}`, error);
        if (error.message.includes('인증') && !endpoint.includes('/login') && !endpoint.includes('/signup')
            && !endpoint.includes('/public')) {
            logout();
        }
        throw error;
    } finally {
        hideLoading();
    }
}

// 화면 전환 함수들
function showHomeScreen() {
    // 현재 로그인 상태 확인
    const token = sessionStorage.getItem('token');
    const role = sessionStorage.getItem('role');

    // 모든 화면 숨기기
    const homeScreen = document.getElementById('mainContainer')?.querySelector('#homeScreen');
    if (!homeScreen) return; 

    homeScreen.classList.remove('hidden');
    document.getElementById('loginAndReservationSystem')?.classList.add('hidden');
    document.getElementById('loginScreen')?.classList.add('hidden');
    document.getElementById('userDashboard')?.classList.add('hidden');
    document.getElementById('adminDashboard')?.classList.add('hidden');

    // 공지사항 새로고침
    loadHomeNotices();
    
    // 로그인 상태일 경우 네비게이션 바 수정
    if (token && role) {
        const homeNav = homeScreen.querySelector('nav');
        if (!homeNav) return; 

        const navButtons = homeNav.querySelector('.items-center.space-x-8');
        if (!navButtons) return; 

        const username = sessionStorage.getItem('username');
        const region = sessionStorage.getItem('region');

        // 기존 로그인/회원가입 버튼 찾기
        const loginButton = navButtons.querySelector('button');
        if (loginButton) {
            loginButton.style.display = 'none';
        }

        // 이미 추가된 로그인 상태 버튼들이 있다면 제거
        const existingLoginButtons = navButtons.querySelector('.login-state-buttons');
        if (existingLoginButtons) {
            existingLoginButtons.remove();
        }

        // 새로운 버튼들 추가
        const newButtons = document.createElement('div');
        newButtons.className = 'flex items-center space-x-4 login-state-buttons';
        
        // 지역 뱃지 스타일 설정
        let regionBadgeStyle = '';
        if (region === 'south') {
            regionBadgeStyle = 'bg-blue-100 text-blue-800';
        } else if (region === 'north') {
            regionBadgeStyle = 'bg-green-100 text-green-800';
        } else if (region === 'all') {
            regionBadgeStyle = 'bg-purple-100 text-purple-800';
        }

        newButtons.innerHTML = `
            <span class="text-gray-700 font-medium px-3 py-1 bg-gray-100 rounded-full">
                ${username || '사용자'}
            </span>
            <span class="px-3 py-1 rounded-full text-sm font-medium ${regionBadgeStyle}">
                ${region === 'south' ? '남부' : region === 'north' ? '북부' : '전체'}
            </span>
            <button onclick="returnToDashboard()" 
                class="bg-primary text-white px-4 py-2 rounded-button hover:bg-primary/90 transition-all duration-200 flex items-center space-x-2">
                <i class="fas fa-tachometer-alt"></i>
                <span>대시보드</span>
            </button>
            <button onclick="logout()" 
                class="bg-gray-500 text-white px-4 py-2 rounded-button hover:bg-gray-600 transition-all duration-200 flex items-center space-x-2">
                <i class="fas fa-sign-out-alt"></i>
                <span>로그아웃</span>
            </button>
        `;

        navButtons.appendChild(newButtons);
    }
    
    // 중요: 네비게이션 바 수정 후 관리자 상태 확인
    checkAdminStatus();
}

// 대시보드로 돌아가는 함수
function returnToDashboard() {
    const role = sessionStorage.getItem('role');
    if (role) {
        showDashboard(role);
    } else {
        showAlert('세션이 만료되었습니다. 다시 로그인해주세요.', 'error');
        logout();
    }
}

function showLoginScreen() {
    // 공지사항 모달이 열려있다면 닫기
    const noticeModal = document.getElementById('noticeDetailModal');
    if (noticeModal && (noticeModal.classList.contains('show') || noticeModal.style.display === 'flex')) {
        closeNoticeDetail();
    }
    
    // 현재 로그인 상태 확인
    const token = sessionStorage.getItem('token');
    const role = sessionStorage.getItem('role');

    // 이미 로그인된 상태라면 직접 대시보드 초기화
    if (token && role) {
        const region = sessionStorage.getItem('region');
        const username = sessionStorage.getItem('username');
        
        // 기본 화면 전환
        document.getElementById('mainContainer').querySelector('#homeScreen').classList.add('hidden');
        document.getElementById('loginAndReservationSystem').classList.remove('hidden');
        document.getElementById('loginScreen').classList.add('hidden');

        if (role === 'admin') {
            // 관리자 대시보드 표시
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('userDashboard').classList.add('hidden');
            initializeAdminDashboard(region, username);
        } else {
            // 사용자 대시보드 표시
            document.getElementById('userDashboard').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            initializeUserDashboard(region, username);
        }
        return;
    }

    // 로그인되지 않은 상태라면 로그인 화면 표시
    document.getElementById('mainContainer').querySelector('#homeScreen').classList.add('hidden');
    document.getElementById('loginAndReservationSystem').classList.remove('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('userDashboard').classList.add('hidden');
    document.getElementById('adminDashboard').classList.add('hidden');
}

// 대시보드 표시 함수
async function showDashboard(role) {
    try {
        showLoading();

        // 토큰 유효성 확인
        const token = sessionStorage.getItem('token');
        if (!token) {
            throw new Error('인증이 필요합니다.');
        }

        // 기본 화면 전환
        document.getElementById('mainContainer').querySelector('#homeScreen').classList.add('hidden');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('loginAndReservationSystem').classList.remove('hidden');

        const region = sessionStorage.getItem('region');
        const username = sessionStorage.getItem('username');
        const dashboardTitle = region === 'south' ? '남부 스포츠박스' : 
                             region === 'north' ? '북부 스포츠박스' : 
                             '스포츠박스 관리자';

        // 이전 대시보드 상태 초기화
        document.getElementById('adminDashboard').classList.add('hidden');
        document.getElementById('userDashboard').classList.add('hidden');
        
        if (role === 'admin') {
            // 관리자 대시보드 표시
            document.getElementById('adminDashboard').classList.remove('hidden');
            
            // 관리자 타입에 따른 UI 조정
            if (region === 'all') {
                document.querySelector('#adminDashboard .dashboard-title').textContent = '스포츠박스 관리자';
                document.getElementById('regionFilter').classList.remove('hidden');
                document.getElementById('regionFilterContainer').classList.remove('hidden');
            } else {
                document.querySelector('#adminDashboard .dashboard-title').textContent = dashboardTitle;
                document.getElementById('regionFilter').classList.add('hidden');
                document.getElementById('regionFilterContainer').classList.add('hidden');
            }

            // 관리자 대시보드 초기화
            await initializeAdminDashboard(region, username);

        } else {
            // 사용자 대시보드 표시
            document.getElementById('userDashboard').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            
            // 대시보드 제목 설정
            document.querySelector('#userDashboard .dashboard-title').textContent = dashboardTitle;
            
            try {
                // 예약 시스템 상태 확인
                const settings = await apiRequest('/api/booking-settings');
                updateUserDashboardState(settings.data?.is_active);
                
                // 사용자 대시보드 초기화
                await initializeUserDashboard(region, username);
            } catch (error) {
                console.error('User dashboard initialization error:', error);
                if (error.message.includes('인증')) {
                    logout();
                    showAlert('세션이 만료되었습니다. 다시 로그인해주세요.', 'error');
                } else {
                    showAlert('시스템 상태 확인 중 오류가 발생했습니다.', 'error');
                }
            }
        }

    } catch (error) {
        console.error('Dashboard initialization error:', error);
        if (error.message.includes('인증')) {
            logout();
            showAlert('세션이 만료되었습니다. 다시 로그인해주세요.', 'error');
        } else {
            showAlert('대시보드 초기화 중 오류가 발생했습니다.', 'error');
        }
    } finally {
        hideLoading();
    }
}

async function initializeUserDashboard(region, username) {
    document.getElementById('userDashboard').classList.remove('hidden');
    document.getElementById('adminDashboard').classList.add('hidden');

    document.querySelector('#userDashboard .dashboard-title').textContent = region === 'south' ? '남부 스포츠박스' : '북부 스포츠박스';
    document.getElementById('userGroupName').textContent = username;
    
    const regionBadge = document.getElementById('regionBadge');
    regionBadge.textContent = region === 'south' ? '남부' : '북부';
    regionBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${region === 'south' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`;

    try {
        const settings = await apiRequest('/api/booking-settings');
        updateUserDashboardState(settings.data?.is_active);
        
        initializeCalendar();
        initializeTimeSelects();
        await debouncedUpdateCalendarStatus();
        await loadBookings();
        
        // 공지사항 로드 (함수 존재 여부 확인 후 호출)
        if (typeof window.loadUserNotices === 'function') {
            console.log('사용자 대시보드 초기화 중 공지사항 로드 호출');
            await window.loadUserNotices();
        } else {
            console.error('loadUserNotices 함수를 찾을 수 없습니다');
        }

        // 남은 예약 횟수 표시 업데이트
        updateRemainingBookingsDisplay();
    } catch (error) {
        console.error('User dashboard initialization error:', error);
        showAlert('시스템 상태 확인 중 오류가 발생했습니다.', 'error');
        throw error;
    }
}

// 사용자 프로필 관리 관련 함수들
function showUserProfileModal() {
    // 현재 사용자 정보 표시
    document.getElementById('userGroupName').value = sessionStorage.getItem('username');
    document.getElementById('userManager').value = sessionStorage.getItem('manager');
    document.getElementById('userContact').value = sessionStorage.getItem('contact');
    
    // 비밀번호 필드 초기화
    document.getElementById('userCurrentPassword').value = '';
    document.getElementById('userNewPassword').value = '';
    document.getElementById('userConfirmPassword').value = '';
    
    openModal('userProfileModal');
}

function closeUserProfileModal() {
    closeModal('userProfileModal');
    document.getElementById('userProfileForm').reset();
}

// 사용자 프로필 폼 제출
document.getElementById('userProfileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const formData = {
            manager: document.getElementById('userManager').value.trim(),
            contact: document.getElementById('userContact').value.trim()
        };

        // 비밀번호 변경이 포함된 경우
        const currentPassword = document.getElementById('userCurrentPassword').value;
        const newPassword = document.getElementById('userNewPassword').value;
        const confirmPassword = document.getElementById('userConfirmPassword').value;

        if (currentPassword || newPassword || confirmPassword) {
            if (!currentPassword) {
                showAlert('현재 비밀번호를 입력해주세요.', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showAlert('새 비밀번호가 일치하지 않습니다.', 'error');
                return;
            }
            if (newPassword && !/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/.test(newPassword)) {
                showAlert('비밀번호는 영문과 숫자를 포함하여 6자 이상이어야 합니다.', 'error');
                return;
            }
            formData.currentPassword = currentPassword;
            formData.newPassword = newPassword;
        }

        showLoading();
        
        const response = await apiRequest('/api/user/profile', {
            method: 'PUT',
            body: JSON.stringify(formData)
        });

        if (response.success) {
            // 로컬 스토리지 정보 업데이트
            sessionStorage.setItem('manager', formData.manager);
            sessionStorage.setItem('contact', formData.contact);
            
            showAlert('계정 정보가 성공적으로 변경되었습니다.', 'success');
            closeUserProfileModal();
            
            // 네비게이션 바 사용자 정보 업데이트
            document.getElementById('userGroupName').textContent = sessionStorage.getItem('username');
        }
    } catch (error) {
        console.error('Profile update error:', error);
        showAlert(error.message || '계정 정보 변경 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
});

// 모달 닫기 버튼 이벤트
document.getElementById('closeUserProfile').addEventListener('click', closeUserProfileModal);

async function initializeAdminDashboard(region, username) {
    try {
        // 토큰 유효성 먼저 확인
        const token = sessionStorage.getItem('token');
        if (!token) {
            throw new Error('인증이 필요합니다.');
        }

        // 대시보드 표시 설정
        document.getElementById('adminDashboard').classList.remove('hidden');
        document.getElementById('userDashboard').classList.add('hidden');
        document.getElementById('adminName').textContent = username;

        const regionFilterContainer = document.getElementById('regionFilterContainer');
        const regionFilter = document.getElementById('regionFilter');
        const adminRegionBadge = document.getElementById('adminRegionBadge');
        const dashboardTitle = document.querySelector('#adminDashboard .dashboard-title');

        if (region === 'all') {
            // 전체 관리자 설정
            dashboardTitle.textContent = '스포츠박스 관리자';
            regionFilterContainer.classList.remove('hidden');
            adminRegionBadge.textContent = '전체 관리자';
            adminRegionBadge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800';

            // 지역 필터 초기값 설정 및 상태 로드
            const selectedRegion = regionFilter.value;
            const settings = await loadAdminBookingSettings();
            updateBookingStatusUI(settings?.is_active || false);

            // 지역 필터 변경 이벤트 리스너
            regionFilter.removeEventListener('change', refreshAdminDashboard);
            regionFilter.addEventListener('change', async function(e) {
                try {
                    const selectedRegion = e.target.value;
                    
                    // 예약 설정 상태 로드
                    const response = await apiRequest('/api/admin/booking-settings');
                    if (response.success) {
                        const settings = response.data;
                        const regionSettings = settings[selectedRegion];
                        updateBookingStatusUI(regionSettings?.is_active || false);
                    }

                    // 데이터 새로고침
                    await Promise.all([
                        loadRegionStatistics(),
                        debouncedUpdateCalendarStatus(),
                        loadPendingBookings()
                    ]);
                } catch (error) {
                    console.error('Region filter change error:', error);
                    if (error.message.includes('인증')) {
                        logout();
                        showAlert('세션이 만료되었습니다. 다시 로그인해주세요.', 'error');
                    } else {
                        showAlert('지역 설정 로드 중 오류가 발생했습니다.', 'error');
                    }
                }
            });

        } else {
            // 지역 관리자 설정
            const regionText = region === 'south' ? '남부' : '북부';
            dashboardTitle.textContent = `${regionText} 스포츠박스`;
            regionFilterContainer.classList.add('hidden');
            adminRegionBadge.textContent = `${regionText} 관리자`;
            adminRegionBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${
                region === 'south' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
            }`;

            // 지역 관리자용 설정 로드
            const settings = await loadAdminBookingSettings();
            updateBookingStatusUI(settings?.is_active || false);
        }

        // 공통 초기화 작업
        await Promise.all([
            loadRegionStatistics(),
            initializeAdminCalendar(),
            debouncedUpdateCalendarStatus(),
            loadPendingUsers(),
            loadPendingBookings()
        ]);

    } catch (error) {
        console.error('Admin dashboard initialization error:', error);
        if (error.message.includes('인증')) {
            logout();
            showAlert('세션이 만료되었습니다. 다시 로그인해주세요.', 'error');
        } else {
            showAlert('관리자 대시보드 초기화 중 오류가 발생했습니다.', 'error');
        }
    }
}

// 통계 섹션 HTML을 동적으로 처리하는 함수 추가
function updateStatisticsUI(region) {
    const statsContainer = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.gap-8.mb-8');
    if (!statsContainer) return;

    // 전체 관리자인 경우 두 지역 모두 표시
    if (region === 'all') {
        statsContainer.innerHTML = `
            <!-- 남부 통계 -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">남부 지역 현황</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">금일 예약</p>
                        <p id="southTodayBookings" class="text-2xl font-bold text-blue-600">0건</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">이번 달 총 예약</p>
                        <p id="southMonthBookings" class="text-2xl font-bold text-green-600">0건</p>
                    </div>
                </div>
            </div>
            <!-- 북부 통계 -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">북부 지역 현황</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">금일 예약</p>
                        <p id="northTodayBookings" class="text-2xl font-bold text-blue-600">0건</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">이번 달 총 예약</p>
                        <p id="northMonthBookings" class="text-2xl font-bold text-green-600">0건</p>
                    </div>
                </div>
            </div>
        `;
    } else {
        // 지역 관리자인 경우 해당 지역만 표시
        const regionText = region === 'south' ? '남부' : '북부';
        const idPrefix = region === 'south' ? 'south' : 'north';
        
        statsContainer.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg p-6 col-span-2">
                <h3 class="text-xl font-bold text-gray-800 mb-4">${regionText} 지역 현황</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">금일 예약</p>
                        <p id="${idPrefix}TodayBookings" class="text-2xl font-bold text-blue-600">0건</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-sm text-gray-600">이번 달 총 예약</p>
                        <p id="${idPrefix}MonthBookings" class="text-2xl font-bold text-green-600">0건</p>
                    </div>
                </div>
            </div>
        `;
    }
}

// 통계 로드 함수
async function loadRegionStatistics() {
    try {
        // localStorage 대신 sessionStorage 사용
        const adminRegion = sessionStorage.getItem('region');
        updateStatisticsUI(adminRegion);

        const today = new Date().toISOString().split('T')[0];
        const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1)
            .toISOString().split('T')[0];
        const lastDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0)
            .toISOString().split('T')[0];

        // 디버깅 정보 추가
        console.log('Admin region:', adminRegion);

        if (adminRegion === 'all' || adminRegion === 'south') {
            // 남부 통계
            const southStats = await apiRequest('/api/admin/statistics', {
                method: 'POST',
                body: JSON.stringify({
                    region: 'south',
                    today,
                    startDate: firstDayOfMonth,
                    endDate: lastDayOfMonth
                })
            });

            if (southStats.success) {
                document.getElementById('southTodayBookings').textContent = 
                    `${southStats.todayBookings}건`;
                document.getElementById('southMonthBookings').textContent = 
                    `${southStats.monthBookings}건`;
            }
        }

        if (adminRegion === 'all' || adminRegion === 'north') {
            // 북부 통계
            const northStats = await apiRequest('/api/admin/statistics', {
                method: 'POST',
                body: JSON.stringify({
                    region: 'north',
                    today,
                    startDate: firstDayOfMonth,
                    endDate: lastDayOfMonth
                })
            });

            if (northStats.success) {
                document.getElementById('northTodayBookings').textContent = 
                    `${northStats.todayBookings}건`;
                document.getElementById('northMonthBookings').textContent = 
                    `${northStats.monthBookings}건`;
            }
        }

    } catch (error) {
        console.error('Statistics loading error:', error);
        showAlert('통계 로딩 중 오류가 발생했습니다.', 'error');
    }
}

// 관리자 대시보드 새로고침
async function refreshAdminDashboard() {
    try {
        showLoading();
        await Promise.all([
            loadPendingUsers(),
            loadPendingBookings(),
            debouncedUpdateCalendarStatus(),
            loadRegionStatistics()
        ]);
    } catch (error) {
        console.error('Dashboard refresh error:', error);
        showAlert('대시보드 새로고침 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
}

function logout() {
    // sessionStorage 클리어
    sessionStorage.clear();
    
    // 로그인 화면 표시
    document.getElementById('mainContainer').querySelector('#homeScreen').classList.add('hidden');
    document.getElementById('loginAndReservationSystem').classList.remove('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    
    // 폼 초기화
    document.getElementById('loginForm').reset();
    
    // 관리자 상태 확인 (공지사항 글쓰기 버튼 숨김)
    checkAdminStatus();
    
    showAlert('로그아웃되었습니다.', 'info', 3000);
}

// 일반 사용자용 UI 업데이트
function updateUserDashboardState(isActive) {
    const calendar = document.getElementById('calendar');
    const bookingForm = document.getElementById('bookingForm');
    const bookingFormSection = bookingForm.closest('.bg-white.rounded-2xl.shadow-xl.p-8');

    if (!isActive) {
        // 달력 비활성화
        const calendarDays = calendar.querySelectorAll('.calendar-day:not(.past)');
        calendarDays.forEach(day => {
            day.style.pointerEvents = 'none';
            day.style.opacity = '0.7';
            day.classList.remove('cursor-pointer');
            day.classList.add('cursor-not-allowed');
        });
        
        // 예약 폼 비활성화
        bookingForm.style.opacity = '0.5';
        bookingForm.style.pointerEvents = 'none';
        
        // 예약 중지 메시지 표시
        let message = bookingFormSection.querySelector('.booking-disabled-message');
        if (!message) {
            message = document.createElement('div');
            message.className = 'booking-disabled-message bg-red-100 text-red-700 p-4 rounded-lg mb-4';
            message.textContent = '현재 예약이 중지된 상태입니다.';
            bookingFormSection.insertBefore(message, bookingForm);
        }
    } else {
        // 달력 활성화
        const calendarDays = calendar.querySelectorAll('.calendar-day:not(.past)');
        calendarDays.forEach(day => {
            day.style.pointerEvents = 'auto';
            day.style.opacity = '1';
            day.classList.remove('cursor-not-allowed');
            if (!day.classList.contains('blocked') && !day.classList.contains('full')) {
                day.classList.add('cursor-pointer');
            }
        });
        
        // 예약 폼 활성화
        bookingForm.style.opacity = '1';
        bookingForm.style.pointerEvents = 'auto';
        
        // 예약 중지 메시지 제거
        const message = bookingFormSection.querySelector('.booking-disabled-message');
        if (message) {
            message.remove();
        }
    }
}

async function validateStoredToken() {
    const token = sessionStorage.getItem('token');
    if (!token) return false;

    try {
        const response = await apiRequest('/api/validate-token');
        return response.success;
    } catch (error) {
        console.error('Token validation error:', error);
        logout();
        return false;
    }
}

async function signup(formData) {
    try {
        // API 요청 전 로그 추가 (새로 추가)
        console.log('회원가입 요청 데이터:', {
            ...formData,
            password: '****'  // 비밀번호는 로그에 표시하지 않음
        });

        // 기존 검증 로직 유지
        if (!formData.groupName || !formData.password || !formData.manager || 
            !formData.contact || !formData.city) {
            throw new Error('모든 필드를 입력해주세요.');
        }

        // 기존 determineRegion 함수 사용
        const region = determineRegion(formData.city);
        if (!region) {
            throw new Error('올바른 시/군을 선택해주세요.');
        }

        // API 요청 데이터 구성 (기존 유지)
        const signupData = {
            group_name: formData.groupName,
            password: formData.password,
            manager: formData.manager,
            contact: formData.contact,
            city: formData.city,
            region: region
        };

        const response = await apiRequest('/api/signup', {
            method: 'POST',
            body: JSON.stringify(signupData)
        });

        // 응답 로그 추가 (새로 추가)
        console.log('회원가입 응답:', response);

        if (response.success) {
            showAlert('회원가입 신청이 완료되었습니다. 관리자 승인을 기다려주세요.', 'success');
            document.getElementById('signupModal').classList.remove('show');
            document.getElementById('signupForm').reset();
            return response;
        } else {
            throw new Error(response.message || '회원가입 처리 중 오류가 발생했습니다.');
        }
    } catch (error) {
        // 에러 로깅 개선 (메시지 수정)
        console.error('회원가입 오류:', error);
        showAlert(error.message || '회원가입 처리 중 오류가 발생했습니다.', 'error');
        
        // 에러 발생 시 모달 표시 유지 (새로 추가)
        const modal = document.getElementById('signupModal');
        if (modal) modal.classList.add('show');
        
        throw error;
    }
}

// 예약 생성 함수
async function createBooking(bookingData) {
    try {
        // 날짜 상태 확인
        const dateStatus = bookingStatus[bookingData.date];
        if (dateStatus?.isFullyBlocked) {
            showAlert('해당 날짜는 전체 마감되었습니다.', 'error', 3000);
            return;
        }
        if (dateStatus?.isPartiallyBlocked && dateStatus.bookingCount >= 1) {
            showAlert('해당 날짜는 부분 마감되어 더 이상 예약할 수 없습니다.', 'error', 3000);
            return;
        }

        const response = await apiRequest('/api/bookings', {
            method: 'POST',
            body: JSON.stringify(bookingData)
        });

        if (response.success) {
            showAlert('예약이 신청되었습니다. 관리자 승인을 기다려주세요.', 'success', 3000);
            document.getElementById('bookingForm').reset();
            await loadBookings();
            debouncedUpdateCalendarStatus();
        }
    } catch (error) {
        console.error('Booking creation error:', error);
        showAlert(error.message || '예약 생성 중 오류가 발생했습니다.', 'error', 3000);
    }
}

// 예약 목록 로드 함수
async function loadBookings() {
    try {
        const data = await apiRequest('/api/bookings');
        const tbody = document.getElementById('bookingsList');
        
        if (data.success && data.data) {
            tbody.innerHTML = data.data
                .filter(booking => booking.status !== 'cancelled')
                .map(booking => {
                    const bookingDate = new Date(booking.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const canCancel = bookingDate >= today && 
                        booking.status !== 'cancelled' && 
                        booking.status !== 'rejected';

                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${formatDate(booking.date)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.start_time} - ${booking.end_time}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.place}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.people}명</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    ${getStatusClass(booking.status)}">
                                    ${getStatusText(booking.status)}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${canCancel ? `
                                    <button onclick="cancelBooking(${booking.id})" 
                                        class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">
                                        취소
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="6" class="px-6 py-4 text-center">예약 내역이 없습니다.</td></tr>';
        }
    } catch (error) {
        console.error('Error loading bookings:', error);
        showAlert('예약 목록을 불러오는데 실패했습니다.', 'error', 3000);
    }
}

// 공지사항 작성
async function createNotice(noticeData) {
    try {
        showLoading();
        // 진행 표시기 추가
        const loadingEl = document.getElementById('loading');
        const spinner = loadingEl.querySelector('.spinner');
        if (spinner) {
            // 진행 텍스트 추가
            const progressText = document.createElement('div');
            progressText.className = 'text-white mt-3 font-medium';
            progressText.textContent = '파일 업로드 중...';
            loadingEl.appendChild(progressText);
        }

        const formData = new FormData();
        formData.append('title', noticeData.title);
        formData.append('content', noticeData.content);
        formData.append('region', noticeData.region);
        formData.append('is_important', noticeData.is_important ? '1' : '0');
        
        // 첨부파일이 있는 경우에만 추가
        if (noticeData.attachment) {
            const fileSize = (noticeData.attachment.size / 1024 / 1024).toFixed(2); // MB
            console.log(`첨부파일 업로드 시작: ${noticeData.attachment.name} (${fileSize}MB)`);
            formData.append('attachment', noticeData.attachment);
        }

        const response = await apiRequest('/api/admin/notices', {
            method: 'POST',
            body: formData,
        });

        console.log('공지사항 생성 응답:', response.data);
        
        if (response.success) {
            showAlert('공지사항이 등록되었습니다.', 'success');
            document.getElementById('noticeWriteForm').reset();
            await loadHomeNotices();
            if (document.getElementById('noticesListSection')) {
                await loadUserNotices();
            }
            return response;
        } else {
            throw new Error(response.message || '공지사항 등록에 실패했습니다.');
        }
    } catch (error) {
        console.error('공지사항 생성 오류:', error);
        showAlert(error.message || '공지사항 등록 중 오류가 발생했습니다.', 'error');
        throw error;
    } finally {
        // 진행 표시기 제거
        const loadingEl = document.getElementById('loading');
        const progressText = loadingEl.querySelector('.text-white.mt-3');
        if (progressText) {
            loadingEl.removeChild(progressText);
        }
        hideLoading();
    }
}

// 공지사항 목록 로드
async function loadNotices() {
    try {
        const response = await apiRequest('/api/notices');
        if (response.success && response.data) {
            renderNoticesList(response.data, 'noticesList');
        }
    } catch (error) {
        console.error('Notices loading error:', error);
        showAlert('공지사항을 불러오는데 실패했습니다.', 'error');
    }
}

async function loadAdminBookings() {
    try {
        const region = localStorage.getItem('region');
        let endpoint = '/api/admin/bookings/';
        
        if (region === 'all') {
            endpoint += 'all';
        } else {
            endpoint += region;
        }

        const response = await apiRequest(endpoint);
        if (response.success) {
            const tbody = document.getElementById('adminBookingsList');
            
            if (tbody) {
                tbody.innerHTML = response.data
                    .map(booking => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${booking.group_name}
                                <span class="ml-2 px-2 py-1 text-xs rounded-full 
                                    ${booking.region === 'south' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                                    ${booking.region === 'south' ? '남부' : '북부'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.city}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${formatDate(booking.date)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.start_time} - ${booking.end_time}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.place}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${booking.people}명</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    ${getStatusClass(booking.status)}">
                                    ${getStatusText(booking.status)}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${booking.status === 'pending' ? `
                                    <button onclick="approveBooking(${booking.id})" 
                                        class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm mr-2">
                                        승인
                                    </button>
                                    <button onclick="rejectBooking(${booking.id})"
                                        class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">
                                        거부
                                    </button>
                                ` : booking.status === 'approved' ? `
                                    <button onclick="forceCancel(${booking.id})"
                                        class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">
                                        강제취소
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('') || '<tr><td colspan="8" class="px-6 py-4 text-center">예약 내역이 없습니다.</td></tr>';
            }
        }
    } catch (error) {
        console.error('Error loading admin bookings:', error);
        showAlert(error.message || '예약 목록을 불러오는데 실패했습니다.', 'error', 3000);
    }
}

// 날짜 포맷 함수
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
}

// 예약 취소 함수
async function cancelBooking(bookingId) {
    try {
        if (!confirm('예약을 취소하시겠습니까?')) {
            return;
        }

        showLoading();

        // 예약 상태 확인
        const bookingResponse = await apiRequest(`/api/bookings/${bookingId}`);
        if (!bookingResponse.success) {
            throw new Error(bookingResponse.message);
        }

        const booking = bookingResponse.data;
        let cancelResponse;

        if (booking.status === 'pending') {
            // 승인대기 상태일 경우 즉시 취소
            cancelResponse = await apiRequest(`/api/bookings/${bookingId}/cancel-pending`, {
                method: 'PUT'
            });
        } else if (booking.status === 'approved') {
            // 승인완료 상태일 경우 취소 요청
            cancelResponse = await apiRequest(`/api/bookings/${bookingId}/cancel`, {
                method: 'PUT'
            });
        } else {
            throw new Error('취소할 수 없는 예약 상태입니다.');
        }

        if (cancelResponse.success) {
            showAlert(
                booking.status === 'pending' ? 
                    '예약이 취소되었습니다.' : 
                    '예약 취소가 요청되었습니다. 관리자 승인을 기다려주세요.', 
                'success'
            );
            await loadBookings();
            await debouncedUpdateCalendarStatus();
        }
    } catch (error) {
        console.error('Booking cancellation error:', error);
        showAlert(error.message || '예약 취소 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
}

// 상태 관련 유틸리티 함수들
function getStatusClass(status) {
    const statusClasses = {
        approved: 'bg-green-100 text-green-800',
        pending: 'bg-yellow-100 text-yellow-800',
        rejected: 'bg-red-100 text-red-800',
        cancelled: 'bg-gray-100 text-gray-800',
        cancel_pending: 'bg-orange-100 text-orange-800'
    };
    return statusClasses[status] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const statusTexts = {
        approved: '승인완료',
        pending: '승인대기',
        rejected: '거부됨',
        cancelled: '취소완료',
        cancel_pending: '취소대기'
    };
    return statusTexts[status] || '알 수 없음';
}

// 승인 대기 회원 목록 로드
async function loadPendingUsers() {
    try {
        const data = await apiRequest('/api/admin/pending-users');
        const tbody = document.getElementById('pendingUsersList');
        
        if (data.success && data.data) {
            tbody.innerHTML = data.data.map(user => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">${user.group_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.manager}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.contact}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex space-x-2">
                            <button onclick="approveUser(${user.id})" 
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm">
                                승인
                            </button>
                            <button onclick="rejectUser(${user.id})"
                                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm">
                                거부
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="px-6 py-4 text-center">대기 중인 회원이 없습니다.</td></tr>';
        }
    } catch (error) {
        console.error('Error loading pending users:', error);
        showAlert('승인 대기 목록을 불러오는데 실패했습니다.', 'error');
    }
}

// 전체 회원 목록 로드
async function loadAllUsers() {
    try {
        const data = await apiRequest('/api/admin/users');
        const tbody = document.getElementById('allUsersList');
        
        if (data.success && data.data) {
            tbody.innerHTML = data.data.map(user => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">${user.group_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.manager}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.contact}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${
                            user.region === 'south' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
                        }">
                            ${user.region === 'south' ? '남부' : '북부'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${
                            user.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                            user.status === 'approved' ? 'bg-green-100 text-green-800' : 
                            'bg-red-100 text-red-800'
                        }">
                            ${
                                user.status === 'pending' ? '대기중' : 
                                user.status === 'approved' ? '승인됨' : 
                                '거부됨'
                            }
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${user.status === 'approved' ? `
                            <button onclick="resetUserPassword(${user.id}, '${user.group_name}')"
                                class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 text-sm">
                                비밀번호 초기화
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="px-6 py-4 text-center">등록된 회원이 없습니다.</td></tr>';
        }
    } catch (error) {
        console.error('Error loading all users:', error);
        showAlert('회원 목록을 불러오는데 실패했습니다.', 'error');
    }
}

// 비밀번호 초기화 함수 추가
async function resetUserPassword(userId, groupName) {
    try {
        if (!confirm(`${groupName} 사용자의 비밀번호를 초기화하시겠습니까?\n초기화 후 비밀번호는 'sportsbox00' 입니다.`)) {
            return;
        }

        showLoading();
        
        const response = await apiRequest(`/api/admin/users/${userId}/reset-password`, {
            method: 'PUT'
        });

        if (response.success) {
            showAlert(`${groupName} 사용자의 비밀번호가 초기화되었습니다.`, 'success');
        }
    } catch (error) {
        console.error('Password reset error:', error);
        showAlert(error.message || '비밀번호 초기화 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
}

async function approveUser(userId) {
    try {
        showLoading();  // 로딩 표시 추가
        const response = await apiRequest(`/api/admin/users/${userId}/approve`, {
            method: 'PUT'
        });
        
        if (response.success) {
            showAlert('사용자가 승인되었습니다.', 'success', 3000);
            await loadPendingUsers();  // await 추가하여 목록 새로고침 보장
        }
    } catch (error) {
        console.error('User approval error:', error);
        showAlert(error.message || '사용자 승인 처리 중 오류가 발생했습니다.', 'error', 3000);
    } finally {
        hideLoading();  // 로딩 표시 제거 보장
    }
}

async function rejectUser(userId) {
    try {
        // 확인 대화상자 추가
        if (!confirm('정말 이 사용자의 가입을 거부하시겠습니까?')) {
            return;
        }

        showLoading();  // 로딩 표시 추가
        const response = await apiRequest(`/api/admin/users/${userId}/reject`, {
            method: 'PUT'
        });
        
        if (response.success) {
            showAlert('사용자가 거부되었습니다.', 'success', 3000);
            await loadPendingUsers();  // await 추가하여 목록 새로고침 보장
        }
    } catch (error) {
        console.error('User rejection error:', error);
        showAlert(error.message || '사용자 거부 처리 중 오류가 발생했습니다.', 'error', 3000);
    } finally {
        hideLoading();  // 로딩 표시 제거 보장
    }
}

// 비밀번호 초기화 함수 추가
async function resetUserPassword(userId, groupName) {
    try {
        if (!confirm(`${groupName} 사용자의 비밀번호를 초기화하시겠습니까?\n초기화 후 비밀번호는 'sportsbox00' 입니다.`)) {
            return;
        }

        showLoading();
        
        const response = await apiRequest(`/api/admin/users/${userId}/reset-password`, {
            method: 'PUT'
        });

        if (response.success) {
            showAlert(`${groupName} 사용자의 비밀번호가 초기화되었습니다.`, 'success');
        }
    } catch (error) {
        console.error('Password reset error:', error);
        showAlert(error.message || '비밀번호 초기화 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
}

// 관리자: 예약 관리 함수들
async function loadPendingBookings() {
    try {
        const data = await apiRequest('/api/admin/pending-bookings');
        const tbody = document.getElementById('pendingBookingsList');
        
        if (data.success && data.data) {
            tbody.innerHTML = data.data.map(booking => {
                const statusText = booking.status === 'cancel_pending' ? '취소 요청' : '승인 대기';
                const statusClass = booking.status === 'cancel_pending' ? 
                    'bg-orange-100 text-orange-800' : 
                    'bg-yellow-100 text-yellow-800';
                
                const createdAt = new Date(booking.created_at);
                const formattedCreatedAt = `${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')} ${String(createdAt.getHours()).padStart(2, '0')}:${String(createdAt.getMinutes()).padStart(2, '0')}`;
                
                const actionButtons = booking.status === 'cancel_pending' 
                    ? `
                        <button onclick="approveBookingCancel(${booking.id})"
                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">
                            취소승인
                        </button>
                        <button onclick="rejectBookingCancel(${booking.id})"
                            class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            취소거부
                        </button>
                    `
                    : `
                        <button onclick="approveBooking(${booking.id})"
                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">
                            승인
                        </button>
                        <button onclick="rejectBooking(${booking.id})"
                            class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            거부
                        </button>
                    `;

                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.group_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatDate(booking.date)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-col">
                                <span>${booking.start_time} - ${booking.end_time}</span>
                                <span class="text-xs text-gray-500 mt-1">신청: ${formattedCreatedAt}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full mb-2 ${statusClass}">
                                ${statusText}
                            </span>
                            <div class="flex flex-col space-y-2">
                                ${actionButtons}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="4" class="px-6 py-4 text-center">대기 중인 예약이 없습니다.</td></tr>';
        }
    } catch (error) {
        console.error('Error loading pending bookings:', error);
        showAlert('예약 승인 대기 목록을 불러오는데 실패했습니다.', 'error', 3000);
    }
}

async function approveBooking(bookingId) {
    try {
        const response = await apiRequest(`/api/admin/bookings/${bookingId}/approve`, {
            method: 'PUT'
        });
        if (response.success) {
            showAlert('예약이 승인되었습니다.', 'success', 3000);
            loadPendingBookings();
            debouncedUpdateCalendarStatus();
        }
    } catch (error) {
        console.error('Booking approval error:', error);
        showAlert('예약 승인 처리 중 오류가 발생했습니다.', 'error', 3000);
    }
}

async function rejectBooking(bookingId) {
    try {
        const response = await apiRequest(`/api/admin/bookings/${bookingId}/reject`, {
            method: 'PUT'
        });
        if (response.success) {
            showAlert('예약이 거부되었습니다.', 'success', 3000);
            loadPendingBookings();
            debouncedUpdateCalendarStatus();
        }
    } catch (error) {
        console.error('Booking rejection error:', error);
        showAlert('예약 거부 처리 중 오류가 발생했습니다.', 'error', 3000);
    }
}

// 예약 취소 관리 함수들
async function approveBookingCancel(bookingId) {
    try {
        const response = await apiRequest(`/api/admin/bookings/${bookingId}/approve-cancel`, {
            method: 'PUT'
        });
        if (response.success) {
            showAlert('예약 취소가 승인되었습니다.', 'success', 3000);
            loadPendingBookings();
            debouncedUpdateCalendarStatus();
        }
    } catch (error) {
        console.error('Cancel approval error:', error);
        showAlert('예약 취소 승인 처리 중 오류가 발생했습니다.', 'error', 3000);
    }
}

// 예약 취소 거부 함수
async function rejectBookingCancel(bookingId) {
    try {
        if (!confirm('이 예약의 취소 요청을 거부하시겠습니까?')) {
            return;
        }

        showLoading();

        const response = await apiRequest(`/api/admin/bookings/${bookingId}/reject-cancel`, {
            method: 'PUT'
        });

        if (response.success) {
            showAlert('예약 취소가 거부되었습니다.', 'success');
            await loadPendingBookings();  // 대기 목록 새로고침
            await debouncedUpdateCalendarStatus();  // 캘린더 상태 업데이트
        }
    } catch (error) {
        console.error('Cancel rejection error:', error);
        showAlert(error.message || '예약 취소 거부 처리 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
}

async function forceCancel(bookingId, dateString) {
    try {
        if (!dateString) {
            showAlert('날짜 정보가 없습니다.', 'error');
            return;
        }

        if (!confirm('이 예약을 강제로 취소하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
            return;
        }

        showLoading();

        const response = await apiRequest(`/api/admin/bookings/${bookingId}/force-cancel`, {
            method: 'PUT'
        });

        if (response.success) {
            showAlert('예약이 강제 취소되었습니다.', 'success');
            await loadDateBookings(dateString);  // 날짜별 예약 목록 새로고침
            await debouncedUpdateCalendarStatus();  // 캘린더 상태 업데이트
        }
    } catch (error) {
        console.error('Force cancel error:', error);
        showAlert(error.message || '예약 강제 취소 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
}

// 날짜 마감 관리 함수들
// 1. 날짜 마감 함수 수정 - 직접 API 호출 후 캘린더 갱신
async function blockDate(date, blockType) {
    try {
        // 관리자 정보 확인
        const adminRegion = sessionStorage.getItem('region');
        
        // 지역 선택 확인 (명시적으로 DOM에서 가져오기)
        const regionFilter = document.getElementById('regionFilter');
        let targetRegion = adminRegion;
        
        // 전체 관리자인 경우 선택된 지역 사용
        if (adminRegion === 'all' && regionFilter) {
            targetRegion = regionFilter.value;
        }
        
        console.log(`[blockDate] 날짜: ${date}, 유형: ${blockType}, 지역: ${targetRegion}`);
        
        // API 요청
        const response = await apiRequest('/api/admin/dates/block', {
            method: 'POST',
            body: JSON.stringify({
                date: date,
                region: targetRegion,
                blockType: blockType
            })
        });

        if (response.success) {
            showAlert(
                blockType === 'full' ? '날짜가 전체 마감되었습니다.' : '날짜가 부분 마감되었습니다.', 
                'success'
            );
            
            // 캘린더 상태 즉시 새로고침 (중요!)
            await refreshCalendarStatus(targetRegion);
            
            // 모달 닫기
            closeDateBookingsModal();
        }
    } catch (error) {
        console.error('Date blocking error:', error);
        showAlert(error.message || '날짜 마감 처리 중 오류가 발생했습니다.', 'error');
    }
}

// 2. 새로운 함수: 특정 지역의 캘린더 상태를 즉시 새로고침
async function refreshCalendarStatus(region) {
    try {
        console.log(`[refreshCalendarStatus] 지역: ${region} 상태 새로고침 중`);
        
        // 지역 정보를 쿼리 파라미터로 명시적 전달
        const url = `/api/bookings/status?region=${region}`;
        
        const data = await apiRequest(url);
        console.log('[refreshCalendarStatus] 받은 데이터:', data);
        
        // 전역 상태 업데이트
        bookingStatus = data.data;
        
        // 관리자 캘린더 다시 렌더링
        renderAdminCalendar(adminCurrentDate);
        
        console.log('[refreshCalendarStatus] 캘린더 상태 업데이트 완료');
        return true;
    } catch (error) {
        console.error('[refreshCalendarStatus] 오류:', error);
        return false;
    }
}

async function unblockDate(date) {
    try {
        // sessionStorage에서 관리자 지역 정보 가져오기
        const adminRegion = sessionStorage.getItem('region');
        
        // 지역 필터 요소에서 선택된 값 가져오기
        const regionFilterElement = document.getElementById('regionFilter');
        const selectedRegion = regionFilterElement ? regionFilterElement.value : null;
        
        // 최종 대상 지역 결정
        const targetRegion = adminRegion === 'all' ? selectedRegion : adminRegion;
        
        console.log('Target region for unblock:', targetRegion);

        // 지역 값 검증
        if (!targetRegion || !['south', 'north'].includes(targetRegion)) {
            throw new Error('유효한 지역을 선택해주세요.');
        }

        const response = await apiRequest('/api/admin/dates/unblock', {
            method: 'POST',
            body: JSON.stringify({ 
                date,
                region: targetRegion
            })
        });

        if (response.success) {
            showAlert('날짜 마감이 해제되었습니다.', 'success');
            
            // 달력 상태 업데이트
            await updateCalendarStatus();
            
            // 날짜별 예약 목록 새로고침
            if (currentSelectedDate) {
                await loadDateBookings(currentSelectedDate);
            }
        }
    } catch (error) {
        console.error('Date unblocking error:', error);
        showAlert(error.message || '날짜 마감 해제 중 오류가 발생했습니다.', 'error');
    }
}

// 직접 호출하는 updateCalendarStatus 함수 추가 (디바운스 없이)
async function updateCalendarStatus() {
    try {
        console.log('[updateCalendarStatus] Updating calendar status immediately...');
        
        // 1. 관리자 정보와 선택된 지역 확인
        const role = sessionStorage.getItem('role');
        const adminRegion = sessionStorage.getItem('region');
        let targetRegion = adminRegion;
        
        // 2. 전체 관리자인 경우 선택된 지역 필터 사용
        if (role === 'admin' && adminRegion === 'all') {
            const regionFilter = document.getElementById('regionFilter');
            if (regionFilter) {
                targetRegion = regionFilter.value;
            }
        }
        
        console.log('[updateCalendarStatus] Target region:', targetRegion);
        
        // 3. 중요: 지역 정보를 쿼리 파라미터로 명시적 전달
        const url = `/api/bookings/status?region=${targetRegion}`;
        console.log('[updateCalendarStatus] Requesting URL:', url);
        
        const data = await apiRequest(url);
        console.log('[updateCalendarStatus] Received data:', data);
        
        // 4. 받아온 데이터 저장
        bookingStatus = data.data;
        
        // 5. 관리자/사용자에 따라 다른 캘린더 업데이트
        if (role === 'admin') {
            renderAdminCalendar(adminCurrentDate);
        } else {
            renderCalendar(currentDate);
        }
        
        // 6. 남은 예약 횟수 업데이트 (필요한 경우)
        if (data.remainingBookings !== undefined) {
            updateRemainingBookingsDisplay(data.remainingBookings);
        }
        
        console.log('[updateCalendarStatus] Calendar status updated successfully');
    } catch (error) {
        console.error('[updateCalendarStatus] Error:', error);
    }
}

// 날짜별 예약 조회 함수
async function loadDateBookings(dateString) {
    try {
        if (!dateString) {
            console.error('No date selected');
            showAlert('날짜 정보가 없습니다.', 'error', 3000);
            return;
        }

        console.log('Loading bookings for date:', dateString);
        const data = await apiRequest(`/api/admin/bookings/date/${dateString}`);
        console.log('Received booking data:', data);

        const tbody = document.getElementById('dateBookingsList');
        const modalDate = document.getElementById('modalDate');
        const partialBlockDateBtn = document.getElementById('partialBlockDateBtn');
        const fullBlockDateBtn = document.getElementById('fullBlockDateBtn');
        const unblockDateBtn = document.getElementById('unblockDateBtn');
        
        modalDate.textContent = formatDate(dateString);
        currentSelectedDate = dateString;

        const dateStatus = bookingStatus[dateString];
        if (dateStatus?.isFullyBlocked || dateStatus?.isPartiallyBlocked) {
            partialBlockDateBtn.classList.add('hidden');
            fullBlockDateBtn.classList.add('hidden');
            unblockDateBtn.classList.remove('hidden');
        } else {
            partialBlockDateBtn.classList.remove('hidden');
            fullBlockDateBtn.classList.remove('hidden');
            unblockDateBtn.classList.add('hidden');
        }

        if (data.success && data.data) {
            const activeBookings = data.data.filter(booking => 
                booking.status !== 'cancelled' && 
                booking.status !== 'rejected' &&
                booking.status !== 'cancel_pending'
            );

            tbody.innerHTML = activeBookings.length > 0 
                ? activeBookings.map(booking => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.group_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.start_time} - ${booking.end_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.place}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.people}명</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${getStatusClass(booking.status)}">
                                ${getStatusText(booking.status)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${booking.status === 'approved' ? `
                                <button onclick="forceCancel(${booking.id}, '${dateString}')" 
                                    class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition-colors">
                                    강제취소
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('')
                : '<tr><td colspan="6" class="px-6 py-4 text-center">현재 유효한 예약이 없습니다.</td></tr>';
        }
    } catch (error) {
        console.error('Error loading date bookings:', error);
        showAlert('예약 내역을 불러오는데 실패했습니다.', 'error', 3000);
    }
}

// 관리자용 예약 설정 로드
async function loadAdminBookingSettings() {
    try {
        const response = await apiRequest('/api/admin/booking-settings');
        if (response.success) {
            const settings = response.data;
            const region = sessionStorage.getItem('region');
            const regionSettings = region === 'all' ? settings : settings[region];
            
            updateBookingStatusUI(regionSettings?.is_active || false);
            return regionSettings;
        }
    } catch (error) {
        console.error('Error loading booking settings:', error);
        updateBookingStatusUI(false);
        throw error;
    }
}

// 일반 사용자용 예약 설정 로드
async function loadUserBookingSettings() {
    try {
        const response = await apiRequest('/api/booking-settings');
        if (response.success) {
            updateUserDashboardState(response.data?.is_active || false);
            return response.data;
        }
    } catch (error) {
        console.error('Error loading booking settings:', error);
        updateUserDashboardState(false);
        showAlert('예약 설정을 불러오는데 실패했습니다.', 'error');
    }
}

async function toggleBookingStatus() {
    try {
        const region = sessionStorage.getItem('region');
        // 전체 관리자의 경우 선택된 지역 값 사용
        const targetRegion = region === 'all' ? 
            document.getElementById('regionFilter').value : region;

        if (!targetRegion) {
            showAlert('지역을 선택해주세요.', 'error');
            return;
        }

        const toggleButton = document.getElementById('toggleBookingStatus');
        const isCurrentlyActive = toggleButton.textContent.includes('중지');

        const response = await apiRequest('/api/admin/booking-settings', {
            method: 'POST',
            body: JSON.stringify({
                region: targetRegion,
                is_active: !isCurrentlyActive
            })
        });

        if (response.success) {
            showAlert(
                isCurrentlyActive ? '예약이 중지되었습니다.' : '예약이 시작되었습니다.',
                'success'
            );
            updateBookingStatusUI(!isCurrentlyActive);
            await debouncedUpdateCalendarStatus();

            // 통계 및 예약 목록 새로고침
            await Promise.all([
                loadRegionStatistics(),
                loadPendingBookings()
            ]);
        }
    } catch (error) {
        console.error('Toggle booking status error:', error);
        showAlert(error.message || '설정 변경 중 오류가 발생했습니다.', 'error');
    }
}

// 관리자용 UI 업데이트
function updateBookingStatusUI(isActive) {
    const toggleButton = document.getElementById('toggleBookingStatus');
    const statusText = document.getElementById('bookingStatusText');
    const region = sessionStorage.getItem('region');
    const selectedRegion = region === 'all' ? 
        document.getElementById('regionFilter').value : region;
    const regionText = selectedRegion === 'south' ? '남부' : '북부';
    
    if (isActive) {
        toggleButton.textContent = `${regionText} 예약 중지하기`;
        toggleButton.className = 'px-6 py-3 rounded-xl font-medium bg-red-500 text-white hover:bg-red-600 transition-all duration-200';
        statusText.textContent = `현재 ${regionText} 지역 예약을 받고 있습니다`;
        statusText.className = 'text-sm text-green-600';
    } else {
        toggleButton.textContent = `${regionText} 예약 시작하기`;
        toggleButton.className = 'px-6 py-3 rounded-xl font-medium bg-green-500 text-white hover:bg-green-600 transition-all duration-200';
        statusText.textContent = `현재 ${regionText} 지역 예약을 받고 있지 않습니다`;
        statusText.className = 'text-sm text-red-600';
    }
}



// 디바운스 함수
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// 엑셀 다운로드 관련 함수들
async function generateExcelData(year, month) {
    try {
        const response = await apiRequest(`/api/admin/bookings/month/${year}/${month}`);
        if (!response.success) {
            throw new Error('데이터 조회 실패');
        }

        const bookings = response.data;
        const ws = XLSX.utils.aoa_to_sheet([
            ['날짜', '단체명', '시간', '장소', '인원', '상태'] // 헤더 행
        ]);

        const data = Object.entries(bookings).flatMap(([date, dayBookings]) =>
            dayBookings.map(booking => [
                formatDate(date),
                booking.group_name,
                `${booking.start_time} - ${booking.end_time}`,
                booking.place,
                booking.people,
                getStatusText(booking.status)
            ])
        );

        XLSX.utils.sheet_add_aoa(ws, data, { origin: -1 });
        
        // 열 너비 자동 조정
        const wscols = [
            { wch: 15 }, // 날짜
            { wch: 20 }, // 단체명
            { wch: 15 }, // 시간
            { wch: 20 }, // 장소
            { wch: 10 }, // 인원
            { wch: 12 }  // 상태
        ];
        ws['!cols'] = wscols;

        return ws;
    } catch (error) {
        console.error('Excel data generation error:', error);
        throw error;
    }
}

    // 엑셀 다운로드 버튼 이벤트 리스너
    document.getElementById('downloadExcel')?.addEventListener('click', async function() {
        const year = adminCurrentDate.getFullYear();
        const month = adminCurrentDate.getMonth() + 1;
        
        try {
            showLoading();
            const ws = await generateExcelData(year, month);
            if (!ws) {
                throw new Error('엑셀 데이터 생성 실패');
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '예약현황');
            
            const fileName = `스포츠박스_예약현황_${year}년${month}월.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showAlert('엑셀 파일이 다운로드되었습니다.', 'success', 3000);
        } catch (error) {
            console.error('Excel download error:', error);
            showAlert('엑셀 파일 다운로드 중 오류가 발생했습니다.', 'error', 3000);
        } finally {
            hideLoading();
        }
    });

// 모달 컨트롤 함수들
function showDateBookingsModal() {
    const calendarContainer = document.getElementById('adminCalendar').parentElement;
    calendarContainer.classList.add('modal-open');
    openModal('dateBookingsModal');
}

function closeDateBookingsModal() {
    const calendarContainer = document.getElementById('adminCalendar').parentElement;
    calendarContainer.classList.remove('modal-open');
    closeModal('dateBookingsModal');
}

// 캘린더 관련 변수와 함수들
let currentDate = new Date();
let adminCurrentDate = new Date();

// 캘린더 상태 업데이트
const debouncedUpdateCalendarStatus = debounce(async () => {
    try {
        console.log('Updating calendar status...');
        
        // 1. 관리자 정보와 선택된 지역 확인
        const role = sessionStorage.getItem('role');
        const adminRegion = sessionStorage.getItem('region');
        let targetRegion = adminRegion;
        
        // 2. 전체 관리자인 경우 선택된 지역 필터 사용
        if (role === 'admin' && adminRegion === 'all') {
            const regionFilter = document.getElementById('regionFilter');
            if (regionFilter) {
                targetRegion = regionFilter.value;
            }
        }
        
        console.log('Calendar update for region:', targetRegion);
        
        // 3. API 요청
        const data = await apiRequest('/api/bookings/status');
        console.log('Received calendar status:', data);
        
        // 4. 받아온 데이터 저장
        bookingStatus = data.data;
        
        // 5. 관리자/사용자에 따라 다른 캘린더 업데이트
        if (role === 'admin') {
            renderAdminCalendar(adminCurrentDate);
            
            // 6. 지역별 통계 새로고침 (필요한 경우)
            if (typeof loadRegionStatistics === 'function') {
                await loadRegionStatistics();
            }
        } else {
            renderCalendar(currentDate);
        }
        
        // 7. 남은 예약 횟수 업데이트
        if (data.remainingBookings !== undefined) {
            updateRemainingBookingsDisplay(data.remainingBookings);
        }
        
        console.log('Calendar status updated successfully');
    } catch (error) {
        console.error('Calendar status update error:', error);
    }
}, 500);

// 로그인 함수도 수정
async function login(username, password) {
    try {
        showLoading();
        const response = await apiRequest('/api/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                group_name: username,
                password: password
            })
        });

        if (response.success) {
            // sessionStorage 사용으로 통일
            sessionStorage.setItem('token', response.token);
            sessionStorage.setItem('role', response.user.role);
            sessionStorage.setItem('username', response.user.group_name);
            sessionStorage.setItem('region', response.user.region);
            sessionStorage.setItem('city', response.user.city);
            sessionStorage.setItem('manager', response.user.manager);
            sessionStorage.setItem('contact', response.user.contact);

            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('userDashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');

            // 관리자 상태 확인 (공지사항 글쓰기 버튼 표시 여부)
            checkAdminStatus();

            await showDashboard(response.user.role);
            showAlert('로그인되었습니다.', 'success', 2000);
        }
    } catch (error) {
        console.error('Login error:', error);
        showAlert(error.message || '로그인에 실패했습니다.', 'error');
    } finally {
        hideLoading();
    }
}

// 회원가입 폼 제출 이벤트 리스너
document.getElementById('signupForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // 모든 필수 필드 값 가져오기
    const groupName = document.getElementById('groupName').value.trim();
    const password = document.getElementById('signupPassword').value;
    const manager = document.getElementById('manager').value.trim();
    const city = document.getElementById('city').value;
    const contact = document.getElementById('contact').value.trim();
    const region = determineRegion(city);

    // 단체명 유효성 검사
    if (!groupName) {
        showAlert('단체명을 입력해주세요.', 'error', 3000);
        document.getElementById('groupName').focus();
        return;
    }
    
    if (groupName.length < 2) {
        showAlert('단체명은 2자 이상이어야 합니다.', 'error', 3000);
        document.getElementById('groupName').focus();
        return;
    }

    // 비밀번호 유효성 검사 강화
    if (!password) {
        showAlert('비밀번호를 입력해주세요.', 'error', 3000);
        document.getElementById('signupPassword').focus();
        return;
    }

    if (password.length < 6) {
        showAlert('비밀번호는 6자 이상이어야 합니다.', 'error', 3000);
        document.getElementById('signupPassword').focus();
        return;
    }

    // 특수문자, 숫자 포함 검사 추가
    if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/.test(password)) {
        showAlert('비밀번호는 영문과 숫자를 포함해야 합니다.', 'error', 3000);
        document.getElementById('signupPassword').focus();
        return;
    }

    // 담당자명 유효성 검사
    if (!manager) {
        showAlert('담당자명을 입력해주세요.', 'error', 3000);
        document.getElementById('manager').focus();
        return;
    }

    if (manager.length < 2) {
        showAlert('담당자명은 2자 이상이어야 합니다.', 'error', 3000);
        document.getElementById('manager').focus();
        return;
    }

    // 시/군 선택 검사
    if (!city) {
        showAlert('시/군을 선택해주세요.', 'error', 3000);
        document.getElementById('city').focus();
        return;
    }

    if (!region) {
        showAlert('올바른 시/군을 선택해주세요.', 'error', 3000);
        document.getElementById('city').focus();
        return;
    }

    // 연락처 유효성 검사 강화
    if (!contact) {
        showAlert('연락처를 입력해주세요.', 'error', 3000);
        document.getElementById('contact').focus();
        return;
    }

    // 연락처 형식 검사 (지역번호 또는 휴대폰 번호)
    const contactRegex = /^(0[2-6][1-5]|02|010)-[0-9]{3,4}-[0-9]{4}$/;
    if (!contactRegex.test(contact)) {
        showAlert('올바른 연락처 형식이 아닙니다. (예: 010-1234-5678 또는 031-123-4567)', 'error', 3000);
        document.getElementById('contact').focus();
        return;
    }

    // 폼 제출 전 확인
    try {
        // 로딩 표시
        showLoading();

        const formData = {
            groupName: groupName,
            password: password,
            manager: manager,
            contact: contact,
            city: city,
            region: region
        };

        // 회원가입 처리
        signup(formData)
            .catch(error => {
                console.error('Signup error:', error);
                showAlert(error.message || '회원가입 처리 중 오류가 발생했습니다.', 'error', 3000);
            })
            .finally(() => {
                hideLoading();
            });

    } catch (error) {
        hideLoading();
        console.error('Form submission error:', error);
        showAlert('회원가입 처리 중 오류가 발생했습니다.', 'error', 3000);
    }
});

// 지역 정보 표시 업데이트
function updateRegionDisplay() {
    const region = sessionStorage.getItem('region');
    const regionBadge = document.getElementById('regionBadge');
    
    if (regionBadge) {
        regionBadge.textContent = region === 'south' ? '남부' : 
                                 region === 'north' ? '북부' : 
                                 region === 'all' ? '전체' : '';
        
        regionBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${
            region === 'south' ? 'bg-blue-100 text-blue-800' :
            region === 'north' ? 'bg-green-100 text-green-800' :
            region === 'all' ? 'bg-purple-100 text-purple-800' :
            'bg-gray-100 text-gray-800'
        }`;
    }
}

function initializeCalendar() {
    const calendar = document.getElementById('calendar');
    const currentMonthElement = document.getElementById('currentMonth');

    // 현재 날짜 상태 초기화
    if (!currentDate) {
        currentDate = new Date();
    }

    document.getElementById('prevMonth').addEventListener('click', function() {
        // 이전 달로 이동 (한 달씩)
        currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
        renderCalendar(currentDate);
        debouncedUpdateCalendarStatus();  // 상태 업데이트 추가
    });

    document.getElementById('nextMonth').addEventListener('click', function() {
        // 다음 달로 이동 (한 달씩)
        currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
        renderCalendar(currentDate);
        debouncedUpdateCalendarStatus();  // 상태 업데이트 추가
    });

    renderCalendar(currentDate);
}

function initializeAdminCalendar() {
    const adminCalendar = document.getElementById('adminCalendar');
    const adminCurrentMonthElement = document.getElementById('adminCurrentMonth');

    // 현재 날짜 상태 초기화
    if (!adminCurrentDate) {
        adminCurrentDate = new Date();
    }

    document.getElementById('adminPrevMonth').addEventListener('click', function() {
        adminCurrentDate = new Date(adminCurrentDate.getFullYear(), 
                                  adminCurrentDate.getMonth() - 1, 1);
        renderAdminCalendar(adminCurrentDate);
    });

    document.getElementById('adminNextMonth').addEventListener('click', function() {
        adminCurrentDate = new Date(adminCurrentDate.getFullYear(), 
                                  adminCurrentDate.getMonth() + 1, 1);
        renderAdminCalendar(adminCurrentDate);
    });

    // 초기 달력 렌더링
    renderAdminCalendar(adminCurrentDate);
}

// 일반 사용자용 날짜 클릭 핸들러
function addDateClickHandler(element, year, month, day) {
    element.addEventListener('click', function() {
        const selected = document.querySelector('.selected');
        if (selected) {
            selected.classList.remove('selected');
        }
        element.classList.add('selected');
        document.getElementById('selectedDate').value = `${year}년 ${month + 1}월 ${day}일`;
    });
}

// 관리자용 날짜 클릭 핸들러
function addAdminDateClickHandler(element, dateString, targetRegion) {
    element.addEventListener('click', async () => {
        if (!dateString || !dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
            console.error('Invalid date format:', dateString);
            showAlert('올바르지 않은 날짜 형식입니다.', 'error');
            return;
        }
        
        // 선택된 지역 정보 저장 (필요한 경우)
        if (targetRegion) {
            sessionStorage.setItem('selectedTargetRegion', targetRegion);
        }
        
        console.log(`Loading bookings for date: ${dateString}, region: ${targetRegion}`);
        
        currentSelectedDate = dateString;
        await loadDateBookings(dateString);
        showDateBookingsModal();
        setupModalButtons(dateString);
    });
}

// 일반 사용자용 캘린더 렌더링
function renderCalendar(date) {
    const calendar = document.getElementById('calendar');
    const currentMonthElement = document.getElementById('currentMonth');
    
    const year = date.getFullYear();
    const month = date.getMonth();

    currentMonthElement.textContent = `${year}년 ${month + 1}월`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    calendar.innerHTML = '';

    // 첫째 날의 요일만큼 빈 칸 추가
    for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'h-12 rounded-lg';
        calendar.appendChild(emptyDay);
    }

    // 날짜 채우기
    for (let currentDay = 1; currentDay <= lastDay.getDate(); currentDay++) {
        const dayElement = document.createElement('div');
        const selectedDateObj = new Date(year, month, currentDay);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
        const dateStatus = bookingStatus[dateString];

        if (selectedDateObj < today) {
            dayElement.className = 'calendar-day past h-12 flex items-center justify-center';
            dayElement.title = '지난 날짜';
        } else if (dateStatus?.isFullyBlocked) {
            dayElement.className = 'calendar-day blocked h-12 flex items-center justify-center';
            dayElement.title = '전체 마감';
        } else if (dateStatus?.isFull || (dateStatus?.isPartiallyBlocked && dateStatus?.bookingCount >= 1)) {
            dayElement.className = 'calendar-day full h-12 flex items-center justify-center';
            dayElement.title = '예약 마감';
        } else if (dateStatus?.hasBooking) {
            dayElement.className = 'calendar-day booked h-12 flex items-center justify-center cursor-pointer';
            dayElement.title = `${dateStatus.bookingCount}개 예약됨`;
            addDateClickHandler(dayElement, year, month, currentDay);
        } else {
            dayElement.className = 'calendar-day h-12 flex items-center justify-center cursor-pointer rounded-lg hover:bg-blue-100 transition-colors text-gray-700';
            dayElement.title = '예약 가능';
            addDateClickHandler(dayElement, year, month, currentDay);
        }

        dayElement.textContent = currentDay;

        if (
            !dateStatus?.isFullyBlocked && 
            currentDay === today.getDate() &&
            date.getMonth() === today.getMonth() &&
            date.getFullYear() === today.getFullYear()
        ) {
            dayElement.classList.add('font-bold');
        }

        calendar.appendChild(dayElement);
    }
}

// 관리자용 캘린더 렌더링
function renderAdminCalendar(date) {
    // 입력값 검증
    if (!date || !(date instanceof Date)) {
        console.error('유효하지 않은 날짜입니다');
        return;
    }

    const adminCalendar = document.getElementById('adminCalendar');
    const adminCurrentMonthElement = document.getElementById('adminCurrentMonth');
    
    // 1. 중요: 관리자 유형과 선택된 지역 확인 - 명확하게 로깅
    const adminRegion = sessionStorage.getItem('region');
    let targetRegion = adminRegion;
    
    if (adminRegion === 'all') {
        const regionFilter = document.getElementById('regionFilter');
        if (regionFilter) {
            targetRegion = regionFilter.value;
        }
    }
    
    console.log('[renderAdminCalendar] Rendering for region:', targetRegion);
    console.log('[renderAdminCalendar] Admin type:', adminRegion === 'all' ? '전체관리자' : '지역관리자');
    console.log('[renderAdminCalendar] Current booking status:', bookingStatus);

    const year = date.getFullYear();
    const month = date.getMonth();
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    adminCurrentMonthElement.textContent = `${year}년 ${month + 1}월`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    adminCalendar.innerHTML = '';

    // 빈 날짜 칸 추가
    for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'h-12 rounded-lg';
        adminCalendar.appendChild(emptyDay);
    }

    // 날짜 칸 추가
    for (let currentDay = 1; currentDay <= lastDay.getDate(); currentDay++) {
        const dayElement = document.createElement('div');
        const selectedDateObj = new Date(year, month, currentDay);
        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
        
        // 중요: 날짜 상태 로깅
        console.log(`[renderAdminCalendar] Date ${dateString} status:`, bookingStatus[dateString]);
        
        const dateStatus = bookingStatus[dateString];
        const baseClass = 'calendar-day h-12 flex items-center justify-center relative';

        // 날짜 상태에 따른 클래스 설정
        if (selectedDateObj < today) {
            dayElement.className = `${baseClass} past`;
            dayElement.title = '지난 날짜';
        } else if (dateStatus?.isFullyBlocked) {
            dayElement.className = `${baseClass} blocked cursor-pointer`;
            dayElement.title = '전체 마감 (클릭하여 해제)';
        } else if (dateStatus?.isPartiallyBlocked) {
            // 부분 마감인 경우
            dayElement.className = `${baseClass} partially-blocked cursor-pointer`;
            dayElement.title = '부분 마감 (1개 예약만 가능)';
            dayElement.style.backgroundColor = '#F97316';
        } else if (dateStatus?.isFull) {
            dayElement.className = `${baseClass} full cursor-pointer`;
            dayElement.title = '예약 마감';
        } else if (dateStatus?.hasBooking) {
            dayElement.className = `${baseClass} booked cursor-pointer`;
            dayElement.title = `${dateStatus.bookingCount}개 예약됨`;
        } else {
            dayElement.className = `${baseClass} cursor-pointer rounded-lg hover:bg-blue-100 transition-colors text-gray-700`;
            dayElement.title = '클릭하여 마감 설정';
        }

        // 날짜 클릭 이벤트 추가
        if (selectedDateObj >= today) {
            // 중요: 날짜 클릭시 targetRegion 정보 전달
            dayElement.addEventListener('click', async () => {
                console.log(`[dateClick] Clicked date: ${dateString}, region: ${targetRegion}`);
                currentSelectedDate = dateString;
                // 선택된 지역 정보를 세션에 저장
                sessionStorage.setItem('selectedTargetRegion', targetRegion);
                await loadDateBookings(dateString);
                showDateBookingsModal();
                setupModalButtons(dateString);
            });
        }

        // 예약 수 배지 추가
        if (dateStatus?.bookingCount > 0) {
            const countBadge = document.createElement('div');
            countBadge.className = 'absolute top-1 right-1 px-1.5 py-0.5 rounded-full text-xs font-semibold bg-white shadow-sm';
            
            if (dateStatus.isPartiallyBlocked) {
                countBadge.textContent = `${dateStatus.bookingCount}/1`;
                countBadge.style.backgroundColor = '#FEF3C7';
            } else {
                countBadge.textContent = `${dateStatus.bookingCount}`;
            }
            
            dayElement.appendChild(countBadge);
        }

        // 날짜 텍스트 추가
        const dateText = document.createElement('span');
        dateText.textContent = currentDay;
        dateText.className = 'z-10';
        dayElement.insertBefore(dateText, dayElement.firstChild);

        // 오늘 날짜 강조
        if (
            currentDay === today.getDate() &&
            month === today.getMonth() &&
            year === today.getFullYear()
        ) {
            dayElement.classList.add('font-bold');
        }

        adminCalendar.appendChild(dayElement);
    }
}

// 날짜 상태에 따른 설정 반환
function getDayConfiguration(dateObj, dateStatus, baseClass) {
    if (dateObj < new Date().setHours(0, 0, 0, 0)) {
        return {
            className: `${baseClass} past`,
            title: '지난 날짜'
        };
    }

    if (dateStatus?.isFullyBlocked) {
        return {
            className: `${baseClass} blocked cursor-pointer`,
            title: '전체 마감 (클릭하여 해제)'
        };
    }

    if (dateStatus?.isPartiallyBlocked) {
        // 부분 마감인 경우
        if (dateStatus.bookingCount >= 1) {
            return {
                className: `${baseClass} full cursor-pointer`,
                title: '예약 마감'
            };
        } else {
            return {
                className: `${baseClass} partially-blocked cursor-pointer`,
                title: '부분 마감 (1개 예약만 가능)',
                backgroundColor: '#F97316'
            };
        }
    }

    if (dateStatus?.isFull) {
        return {
            className: `${baseClass} full cursor-pointer`,
            title: '예약 마감'
        };
    }

    if (dateStatus?.hasBooking) {
        return {
            className: `${baseClass} booked cursor-pointer`,
            title: `${dateStatus.bookingCount}개 예약됨`
        };
    }

    return {
        className: `${baseClass} cursor-pointer rounded-lg hover:bg-blue-100 transition-colors text-gray-700`,
        title: '클릭하여 마감 설정'
    };
}

// 모달 버튼 설정
function setupModalButtons(dateString) {
    // 전체 관리자가 선택한 지역 정보 가져오기
    const adminRegion = sessionStorage.getItem('region');
    let targetRegion = adminRegion;
    
    if (adminRegion === 'all') {
        const regionFilter = document.getElementById('regionFilter');
        if (regionFilter) {
            targetRegion = regionFilter.value;
        }
    }
    
    console.log(`Setting up modal buttons for date: ${dateString}, region: ${targetRegion}`);

    document.getElementById('partialBlockDateBtn').onclick = async () => {
        if (confirm('이 날짜를 부분 마감 처리하시겠습니까? (1개 예약만 가능)')) {
            await blockDate(dateString, 'partial');
            closeDateBookingsModal();
        }
    };

    document.getElementById('fullBlockDateBtn').onclick = async () => {
        if (confirm('이 날짜를 전체 마감 처리하시겠습니까?')) {
            await blockDate(dateString, 'full');
            closeDateBookingsModal();
        }
    };

    document.getElementById('unblockDateBtn').onclick = async () => {
        if (confirm('마감을 해제하시겠습니까?')) {
            await unblockDate(dateString);
            closeDateBookingsModal();
        }
    };
}

// 예약 수 배지 추가
function addBookingCountBadge(dayElement, dateStatus) {
    const countBadge = document.createElement('div');
    countBadge.className = 'absolute top-1 right-1 px-1.5 py-0.5 rounded-full text-xs font-semibold bg-white shadow-sm';
    
    if (dateStatus.isPartiallyBlocked) {
        countBadge.textContent = `${dateStatus.bookingCount}/1`;
        countBadge.style.backgroundColor = '#FEF3C7';
    } else {
        countBadge.textContent = `${dateStatus.bookingCount}`;
    }
    
    dayElement.appendChild(countBadge);
}

// 오늘 날짜 확인
function isToday(currentDay, date, today) {
    return (
        currentDay === today.getDate() &&
        date.getMonth() === today.getMonth() &&
        date.getFullYear() === today.getFullYear()
    );
}

// 날짜별 예약 조회 함수
async function loadDateBookings(dateString) {
    try {
        if (!dateString) {
            console.error('No date selected');
            showAlert('날짜 정보가 없습니다.', 'error', 3000);
            return;
        }

        console.log('Loading bookings for date:', dateString);
        const data = await apiRequest(`/api/admin/bookings/date/${dateString}`);
        console.log('Received booking data:', data);

        const tbody = document.getElementById('dateBookingsList');
        const modalDate = document.getElementById('modalDate');
        const partialBlockDateBtn = document.getElementById('partialBlockDateBtn');
        const fullBlockDateBtn = document.getElementById('fullBlockDateBtn');
        const unblockDateBtn = document.getElementById('unblockDateBtn');
        
        modalDate.textContent = formatDate(dateString);
        currentSelectedDate = dateString;  // 현재 선택된 날짜 저장

        const dateStatus = bookingStatus[dateString];
        if (dateStatus?.isFullyBlocked || dateStatus?.isPartiallyBlocked) {
            partialBlockDateBtn.classList.add('hidden');
            fullBlockDateBtn.classList.add('hidden');
            unblockDateBtn.classList.remove('hidden');
        } else {
            partialBlockDateBtn.classList.remove('hidden');
            fullBlockDateBtn.classList.remove('hidden');
            unblockDateBtn.classList.add('hidden');
        }

        if (data.success && data.data) {
            // 유효한 예약만 필터링 (취소되지 않은 예약)
            const activeBookings = data.data.filter(booking => 
                booking.status !== 'cancelled' && 
                booking.status !== 'rejected' &&
                booking.status !== 'cancel_pending'
            );

            tbody.innerHTML = activeBookings.length > 0 
                ? activeBookings.map(booking => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.group_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.start_time} - ${booking.end_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.place}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.people}명</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${getStatusClass(booking.status)}">
                                ${getStatusText(booking.status)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${booking.status === 'approved' ? `
                                <button onclick="forceCancel(${booking.id}, '${dateString}')" 
                                    class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition-colors">
                                    강제취소
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('')
                : '<tr><td colspan="6" class="px-6 py-4 text-center">현재 유효한 예약이 없습니다.</td></tr>';
        }
    } catch (error) {
        console.error('Error loading date bookings:', error);
        showAlert('예약 내역을 불러오는데 실패했습니다.', 'error', 3000);
    }
}

// 시간 선택 초기화
function initializeTimeSelects() {
    const startTimeSelect = document.getElementById('startTime');
    const endTimeSelect = document.getElementById('endTime');
    
    function generateTimeOptions() {
        const times = [];
        for (let hour = 9; hour < 18; hour++) {
            for (let minute = 0; minute < 60; minute += 10) {
                const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                times.push(timeString);
            }
        }
        return times;
    }

    const timeOptions = generateTimeOptions();
    
    startTimeSelect.innerHTML = '<option value="">선택해주세요</option>' + 
        timeOptions.map(time => `<option value="${time}">${time}</option>`).join('');

    startTimeSelect.addEventListener('change', function() {
        const selectedIndex = timeOptions.indexOf(this.value);
        endTimeSelect.innerHTML = '<option value="">선택해주세요</option>' + 
            timeOptions.slice(selectedIndex + 1).map(time => `<option value="${time}">${time}</option>`).join('');
    });
}

// 관리자 대시보드 초기화 함수
async function initializeAdminDashboard(region, username) {
    try {
        // 예약 설정 로드
        await loadAdminBookingSettings();
        
        // 관리자 캘린더 초기화
        initializeAdminCalendar();
        
        // 예약 상태 업데이트
        await debouncedUpdateCalendarStatus();  

        // 통계 로드
        await loadRegionStatistics();
        
        // 사용자 목록 로드 (두 목록 모두 병렬로 로드)
        await Promise.all([
            loadPendingUsers(),  // 승인 대기 목록
            loadAllUsers(),      // 전체 회원 목록
        ]);
        
        // 예약 승인 대기 목록 로드
        await loadPendingBookings();

        // 예약 상태 토글 버튼 이벤트 리스너 추가
        const toggleButton = document.getElementById('toggleBookingStatus');
        if (toggleButton) {
            toggleButton.removeEventListener('click', toggleBookingStatus);
            toggleButton.addEventListener('click', toggleBookingStatus);
        }

        // 비밀번호 변경 모달 이벤트 리스너 설정
        document.getElementById('closeChangePassword').addEventListener('click', closeChangePasswordModal);
        
    } catch (error) {
        console.error('Admin dashboard initialization error:', error);
        showAlert('대시보드 초기화 중 오류가 발생했습니다.', 'error');
    }
}

// 비밀번호 변경 관련 함수들
function showChangePasswordModal() {
    openModal('changePasswordModal');
}

function closeChangePasswordModal() {
    closeModal('changePasswordModal');
    document.getElementById('changePasswordForm').reset();
}

// 비밀번호 변경 폼 제출
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // 새 비밀번호 일치 확인
        if (newPassword !== confirmPassword) {
            showAlert('새 비밀번호가 일치하지 않습니다.', 'error');
            return;
        }

        // 비밀번호 복잡도 검증
        if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/.test(newPassword)) {
            showAlert('비밀번호는 영문과 숫자를 포함하여 6자 이상이어야 합니다.', 'error');
            return;
        }

        showLoading();
        
        const response = await apiRequest('/api/admin/change-password', {
            method: 'PUT',
            body: JSON.stringify({
                currentPassword,
                newPassword
            })
        });

        if (response.success) {
            showAlert('비밀번호가 성공적으로 변경되었습니다.', 'success');
            closeChangePasswordModal();
        }
    } catch (error) {
        console.error('Password change error:', error);
        showAlert(error.message || '비밀번호 변경 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
});

// 날짜 포맷 함수
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
}

// 엑셀 데이터 생성 함수
async function generateExcelData(year, month) {
    try {
        const response = await apiRequest(`/api/admin/bookings/month/${year}/${month}`);
        if (!response.success) {
            throw new Error('데이터 조회 실패');
        }

        const bookings = response.data;
        const ws = XLSX.utils.aoa_to_sheet([
            ['날짜', '단체명', '시간', '장소'] // 헤더 행
        ]);

        const data = Object.entries(bookings).flatMap(([date, dayBookings]) =>
            dayBookings.map(booking => [
                formatDate(date),
                booking.group_name,
                `${booking.start_time} - ${booking.end_time}`,
                booking.place
            ])
        );

        XLSX.utils.sheet_add_aoa(ws, data, { origin: -1 });
        
        // 열 너비 자동 조정
        const wscols = [
            { wch: 15 }, // 날짜
            { wch: 20 }, // 단체명
            { wch: 15 }, // 시간
            { wch: 20 }  // 장소
        ];
        ws['!cols'] = wscols;

        return ws;
    } catch (error) {
        console.error('Excel data generation error:', error);
        throw error;
    }
}

function showDateBookingsModal() {
    const modal = document.getElementById('dateBookingsModal');
    const calendarContainer = document.getElementById('adminCalendar').parentElement;
    modal.classList.add('show');
    calendarContainer.classList.add('modal-open');
}

function closeDateBookingsModal() {
    const calendarContainer = document.getElementById('adminCalendar').parentElement;
    calendarContainer.classList.remove('modal-open');
    closeModal('dateBookingsModal');
}

// 여기에 downloadApplication 함수 추가
function downloadApplication() {
    const fileUrl = 'https://raw.githubusercontent.com/sportsbox031/sports/main/스포츠박스%20수요처등록%20신청서.hwp';
    
    window.open(fileUrl, '_blank');
    showAlert('다운로드가 시작됩니다. 파일이 자동으로 열리지 않으면 다시 시도해주세요.', 'info');
}

// 이벤트 리스너 설정
document.addEventListener('DOMContentLoaded', async function() {
    // 시군 분류 데이터
    const REGION_MAPPING = {
        south: [
            '과천시', '광명시', '광주시', '군포시', '김포시', '부천시', '성남시', 
            '수원시', '시흥시', '안산시', '안성시', '안양시', '양평군', '여주시', '오산시', 
            '용인시', '의왕시', '이천시', '평택시', '하남시', '화성시'
        ],
        north: [
            '고양시', '구리시', '남양주시', '동두천시', '양주시', '의정부시', 
            '파주시', '포천시', '가평군', '연천군'
        ]
    };

    // 공지사항 로드
    loadHomeNotices();
    checkAdminStatus();

// 모달 외부 클릭 시 닫기
document.getElementById('noticeDetailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeNoticeDetail();
    }
});

// ESC 키로 모달 닫기
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('noticeDetailModal').classList.contains('hidden')) {
        closeNoticeDetail();
    }
});

    // 모달 관련 이벤트 리스너 설정
const modals = document.querySelectorAll('.modal');
modals.forEach(modal => {
    // 모달 내부 클릭 시 이벤트 전파 방지
    const modalContent = modal.querySelector('.bg-white');
    if (modalContent) {
        modalContent.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
    
    // 모달 바깥 영역 클릭 시 닫기
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            // 모달 ID에 따라 적절한 닫기 함수 호출
            if (this.id === 'noticeDetailModal') {
                closeNoticeDetail();
            } else if (this.id === 'signupModal') {
                document.getElementById('closeSignup').click();
            } else if (this.id === 'noticeWriteModal') {
                closeNoticeWriteModal();
            } else if (this.id === 'userProfileModal') {
                closeUserProfileModal();
            } else if (this.id === 'changePasswordModal') {
                closeChangePasswordModal();
            } else if (this.id === 'dateBookingsModal') {
                closeDateBookingsModal();
            } else {
                // 일반적인 모달 닫기
                this.classList.remove('show');
                setTimeout(() => {
                    this.style.display = 'none';
                    document.body.style.overflow = '';
                }, 300);
            }
        }
    });
});

// ESC 키로 모달 닫기
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const visibleModal = document.querySelector('.modal.show');
        if (visibleModal) {
            if (visibleModal.id === 'noticeDetailModal') {
                closeNoticeDetail();
            } else if (visibleModal.id === 'signupModal') {
                document.getElementById('closeSignup').click();
            } else if (visibleModal.id === 'noticeWriteModal') {
                closeNoticeWriteModal();
            } else if (visibleModal.id === 'userProfileModal') {
                closeUserProfileModal();
            } else if (visibleModal.id === 'changePasswordModal') {
                closeChangePasswordModal();
            } else if (visibleModal.id === 'dateBookingsModal') {
                closeDateBookingsModal();
            } else {
                // 일반적인 모달 닫기
                visibleModal.classList.remove('show');
                setTimeout(() => {
                    visibleModal.style.display = 'none';
                    document.body.style.overflow = '';
                }, 300);
            }
        }
    }
});

// 로그인 버튼과 예약 버튼에 명시적인 이벤트 중지 추가
document.querySelectorAll('button[onclick="showLoginScreen()"]').forEach(button => {
    const originalOnclick = button.onclick;
    button.onclick = function(e) {
        e.stopPropagation(); // 이벤트 전파 중지
        if (originalOnclick) originalOnclick.call(this, e);
    };
});

    // 여기에 지역 필터 변경 이벤트 리스너 추가
    document.getElementById('regionFilter')?.addEventListener('change', async function(e) {
    try {
        const selectedRegion = e.target.value;
        console.log(`[regionFilter] 지역 변경됨: ${selectedRegion}`);
        
        // 예약 설정 상태 로드
        const response = await apiRequest('/api/admin/booking-settings');
        if (response.success) {
            const settings = response.data;
            const regionSettings = settings[selectedRegion];
            updateBookingStatusUI(regionSettings?.is_active || false);
        }
        
        // 선택된 지역에 대한 캘린더 상태 즉시 새로고침
        await refreshCalendarStatus(selectedRegion);
        
        // 다른 데이터 새로고침
        await Promise.all([
            loadRegionStatistics(),
            loadPendingBookings()
        ]);
    } catch (error) {
        console.error('Region filter change error:', error);
        showAlert('지역 설정 로드 중 오류가 발생했습니다.', 'error');
    }
});

    // 시군 선택에 따른 지역 자동 분류 함수
    function determineRegion(city) {
        if (REGION_MAPPING.south.includes(city)) return 'south';
        if (REGION_MAPPING.north.includes(city)) return 'north';
        return null;
    }

    // 홈화면 스크롤 이벤트
    document.querySelectorAll('nav a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                const headerOffset = 80;
                const elementPosition = targetElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }
        });
    });

    // 로그인 폼 제출
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    try {
        showLoading();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        await login(username, password);
    } catch (error) {
        console.error('Login submission error:', error);
        showAlert('로그인 처리 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
});

    // 회원가입 모달 컨트롤
    document.getElementById('showSignup').addEventListener('click', function() {
    document.getElementById('signupModal').classList.add('show');
    initializeCitySelect(); // 함수 호출 추가
}); // 닫는 괄호 추가

    document.getElementById('closeSignup').addEventListener('click', function() {
        document.getElementById('signupModal').classList.remove('show');
        document.getElementById('signupForm').reset();
        document.getElementById('regionInfo').textContent = '';
    });

    // 시군 선택 이벤트
    document.getElementById('city')?.addEventListener('change', function() {
    const city = this.value;
    const regionInfo = document.getElementById('regionInfo');
    
    // REGION_MAPPING 정의 (백엔드와 동일하게)
    const REGION_MAPPING = {
        south: [
            '과천시', '광명시', '광주시', '군포시', '김포시', '부천시', '성남시', 
            '수원시', '시흥시', '안산시', '안성시', '안양시', '양평군', '여주시', '오산시', 
            '용인시', '의왕시', '이천시', '평택시', '하남시', '화성시'
        ],
        north: [
            '고양시', '구리시', '남양주시', '동두천시', '양주시', '의정부시', 
            '파주시', '포천시', '가평군', '연천군'
        ]
    };
    
    // 지역 결정 함수
    function determineRegion(city) {
        if (REGION_MAPPING.south.includes(city)) return 'south';
        if (REGION_MAPPING.north.includes(city)) return 'north';
        return null;
    }
    
    const region = determineRegion(city);
    
    if (region) {
        regionInfo.textContent = `${region === 'south' ? '남부' : '북부'} 지역`;
        regionInfo.className = `text-sm font-medium mt-1 ${
            region === 'south' ? 'text-blue-600' : 'text-green-600'
        }`;
    } else {
        regionInfo.textContent = '';
    }
});

    // 회원가입 폼 제출
    const signupForm = document.getElementById('signupForm');
if (signupForm) {
  console.log('회원가입 폼 이벤트 핸들러 초기화');
  
  // 기존 이벤트 핸들러 제거를 위해 폼 복제
  const newForm = signupForm.cloneNode(true);
  signupForm.parentNode.replaceChild(newForm, signupForm);
  
  // 폼 제출 진행 중인지 추적하는 플래그
  let isSubmitting = false;
  
  // 새 이벤트 핸들러 등록
  newForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // 중복 제출 방지
    if (isSubmitting) {
      console.log('이미 폼 제출이 진행 중입니다');
      return;
    }
    
    // 모든 필수 필드 값 가져오기
    const groupName = document.getElementById('groupName').value.trim();
    const password = document.getElementById('signupPassword').value;
    const manager = document.getElementById('manager').value.trim();
    const city = document.getElementById('city').value;
    const contact = document.getElementById('contact').value.trim();
    const region = determineRegion(city);

    console.log('회원가입 폼 데이터 검증 시작');
    
    // 단체명 유효성 검사
    if (!groupName) {
        showAlert('단체명을 입력해주세요.', 'error', 3000);
        document.getElementById('groupName').focus();
        return;
    }
    
    if (groupName.length < 2) {
        showAlert('단체명은 2자 이상이어야 합니다.', 'error', 3000);
        document.getElementById('groupName').focus();
        return;
    }

    // 비밀번호 유효성 검사 강화
    if (!password) {
        showAlert('비밀번호를 입력해주세요.', 'error', 3000);
        document.getElementById('signupPassword').focus();
        return;
    }

    if (password.length < 6) {
        showAlert('비밀번호는 6자 이상이어야 합니다.', 'error', 3000);
        document.getElementById('signupPassword').focus();
        return;
    }

    // 특수문자, 숫자 포함 검사 추가
    if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/.test(password)) {
        showAlert('비밀번호는 영문과 숫자를 포함해야 합니다.', 'error', 3000);
        document.getElementById('signupPassword').focus();
        return;
    }

    // 담당자명 유효성 검사
    if (!manager) {
        showAlert('담당자명을 입력해주세요.', 'error', 3000);
        document.getElementById('manager').focus();
        return;
    }

    if (manager.length < 2) {
        showAlert('담당자명은 2자 이상이어야 합니다.', 'error', 3000);
        document.getElementById('manager').focus();
        return;
    }

    // 시/군 선택 검사
    if (!city) {
        showAlert('시/군을 선택해주세요.', 'error', 3000);
        document.getElementById('city').focus();
        return;
    }

    if (!region) {
        showAlert('올바른 시/군을 선택해주세요.', 'error', 3000);
        document.getElementById('city').focus();
        return;
    }

    // 연락처 유효성 검사 강화
    if (!contact) {
        showAlert('연락처를 입력해주세요.', 'error', 3000);
        document.getElementById('contact').focus();
        return;
    }

    // 연락처 형식 검사 (지역번호 또는 휴대폰 번호)
    const contactRegex = /^(0[2-6][1-5]|02|010)-[0-9]{3,4}-[0-9]{4}$/;
    if (!contactRegex.test(contact)) {
        showAlert('올바른 연락처 형식이 아닙니다. (예: 010-1234-5678 또는 031-123-4567)', 'error', 3000);
        document.getElementById('contact').focus();
        return;
    }

    console.log('회원가입 폼 데이터 검증 완료');
    
    try {
        // 제출 시작 플래그 설정
        isSubmitting = true;
        
        // 폼 버튼 비활성화
        const submitButton = this.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.textContent = '처리 중...';
        }
        
        // 로딩 표시
        showLoading();

        const formData = {
            groupName: groupName,
            password: password,
            manager: manager,
            contact: contact,
            city: city,
            region: region
        };

        console.log('회원가입 API 요청 시작:', {
            ...formData,
            password: '********' // 비밀번호는 로그에 표시하지 않음
        });

        // 직접 API 호출 (signup 함수 대신 apiRequest 직접 사용)
        const response = await apiRequest('/api/signup', {
            method: 'POST',
            body: JSON.stringify({
                group_name: formData.groupName,
                password: formData.password,
                manager: formData.manager,
                contact: formData.contact,
                city: formData.city
            })
        });
        
        console.log('회원가입 API 응답:', response);

        if (response.success) {
            showAlert('회원가입 신청이 완료되었습니다. 관리자 승인을 기다려주세요.', 'success');
            document.getElementById('signupModal').classList.remove('show');
            newForm.reset();
        } else {
            throw new Error(response.message || '회원가입 처리 중 오류가 발생했습니다.');
        }
    } catch (error) {
        console.error('회원가입 처리 오류:', error);
        showAlert(error.message || '회원가입 처리 중 오류가 발생했습니다.', 'error', 3000);
    } finally {
        // 로딩 숨기기
        hideLoading();
        
        // 제출 완료 플래그 설정
        isSubmitting = false;
        
        // 버튼 재활성화
        const submitButton = this.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = '가입하기';
        }
    }
  });
  
  console.log('회원가입 폼 이벤트 핸들러 설정 완료');
}


    // 예약 폼 제출
    document.getElementById('bookingForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const selectedDateText = document.getElementById('selectedDate').value;
        const dateParts = selectedDateText.match(/(\d+)년 (\d+)월 (\d+)일/);
        
        if (!dateParts) {
            showAlert('날짜를 선택해주세요.', 'error', 3000);
            return;
        }

        const bookingData = {
            date: `${dateParts[1]}-${String(dateParts[2]).padStart(2, '0')}-${String(dateParts[3]).padStart(2, '0')}`,
            startTime: document.getElementById('startTime').value,
            endTime: document.getElementById('endTime').value,
            people: document.getElementById('people').value,
            place: document.getElementById('place').value,
            region: sessionStorage.getItem('region') // 사용자의 지역 정보 추가
        };

        createBooking(bookingData);
    });

    // 로그아웃 버튼
    document.getElementById('logoutBtn')?.addEventListener('click', logout);
    document.getElementById('adminLogoutBtn')?.addEventListener('click', logout);

    // 날짜별 예약 모달 컨트롤
    document.getElementById('closeDateBookingsModal')?.addEventListener('click', closeDateBookingsModal);
    
    document.getElementById('dateBookingsModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeDateBookingsModal();
        }
    });

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDateBookingsModal();
            document.getElementById('signupModal').classList.remove('show');
            document.getElementById('contactModal').classList.remove('show');
        }
    });

    // 프로필 모달 이벤트 리스너 초기화
    document.getElementById('closeUserProfile').addEventListener('click', closeUserProfileModal);

    // 시간 선택 초기화
    initializeTimeSelects();

    // 자동 로그인 체크
    const token = sessionStorage.getItem('token');
    const role = sessionStorage.getItem('role');
    
    if (token && role) {
        try {
            const isValid = await validateStoredToken();
            if (isValid) {
                showDashboard(role);
            } else {
                logout();
                showAlert('세션이 만료되었습니다. 다시 로그인해주세요.', 'info', 3000);
            }
        } catch (error) {
            logout();
            console.error('Auto login error:', error);
        }
    }
});

// 디버그 모드 설정
if (DEBUG) {
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nError object: ' + JSON.stringify(error));
        return false;
    };

    // 개발 도구를 위한 전역 변수 노출
    window.debug = {
        showHomeScreen,
        showLoginScreen,
        showDashboard,
        bookingStatus,
        currentUser,
        resetState: () => {
            sessionStorage.clear();
            location.reload();
        }
    };
}

// 페이지 새로고침 시 상태 복원
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        // 뒤로가기로 페이지 복원 시
        const token = sessionStorage.getItem('token');
        const role = sessionStorage.getItem('role');
        
        if (token && role) {
            validateStoredToken().then(isValid => {
                if (isValid) {
                    showDashboard(role);
                } else {
                    logout();
                }
            });
        } else {
            showHomeScreen();
        }
    }
});

// 브라우저 닫기 전 정리
window.addEventListener('beforeunload', function() {
    if (DEBUG) {
        console.log('Page unloading, cleaning up...');
    }
});

// 문의사항 관련 전역 변수
let currentInquiryId = null;
let inquiryData = [];
let userInquiries = [];
let adminInquiries = [];
let inquiryPage = 1;
let inquiryLimit = 10;

// 문의사항 페이지 표시 함수
function showInquiryPage() {
    console.log('문의사항 페이지 열기 시작');
    try {
        // 페이지 표시
        document.getElementById('mainContainer').querySelector('#homeScreen').classList.add('hidden');
        document.getElementById('inquiryPage').classList.remove('hidden');
        document.getElementById('loginAndReservationSystem').classList.add('hidden');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('userDashboard').classList.add('hidden');
        document.getElementById('adminDashboard').classList.add('hidden');
        
        console.log('문의사항 페이지 요소 표시 완료');
        
        // 로그인 상태 확인
        const token = sessionStorage.getItem('token');
        const username = sessionStorage.getItem('username');
        
        console.log('로그인 상태:', !!token);
        
        if (token && username) {
            // 로그인 상태일 때
            document.getElementById('inquiryLoginButton').classList.add('hidden');
            document.getElementById('inquiryLoggedInNav').classList.remove('hidden');
            document.getElementById('inquiryLoggedInNav').innerHTML = `
                <span class="text-gray-700 font-medium">${username}</span>
                <button onclick="showDashboard('${sessionStorage.getItem('role')}')" 
                    class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg">
                    대시보드
                </button>
                <button onclick="logout()" 
                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg">
                    로그아웃
                </button>
            `;
            document.getElementById('inquiryWriteButtonContainer').classList.remove('hidden');
        } else {
            // 비로그인 상태일 때
            document.getElementById('inquiryLoginButton').classList.remove('hidden');
            document.getElementById('inquiryLoggedInNav').classList.add('hidden');
            document.getElementById('inquiryWriteButtonContainer').classList.add('hidden');
        }
        
        // 문의사항 목록 로드
        console.log('문의사항 목록 로드 시작');
        loadInquiries();
        
    } catch (error) {
        console.error('문의사항 페이지 표시 오류:', error);
        alert('문의사항 페이지를 불러오는데 실패했습니다.');
        
        // 오류 시 홈화면으로 복귀
        showHomeScreen();
    }
}

// 문의사항 목록 로드
async function loadInquiries() {
    try {
        showLoading();
        
        // 로그인 상태에 따라 API 엔드포인트 결정
        const token = sessionStorage.getItem('token');
        let endpoint = '/api/public/inquiries';
        
        const response = await fetch(`${API_BASE_URL}${endpoint}`);
        const data = await response.json();
        
        if (data.success) {
            inquiryData = data.data || [];
            renderInquiryList();
        } else {
            // 오류 메시지 표시, 빈 화면이 아닌 메시지
            document.getElementById('inquiryList').innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-10 text-center">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg font-medium text-red-500">문의사항을 불러오는데 실패했습니다</p>
                            <p class="text-gray-500 mt-2">${data.message || '서버 오류가 발생했습니다'}</p>
                            <button onclick="loadInquiries()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                다시 시도
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Inquiries loading error:', error);
        // 오류 메시지 표시, 빈 화면이 아닌 메시지
        document.getElementById('inquiryList').innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-10 text-center">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                        <p class="text-lg font-medium text-red-500">문의사항을 불러오는데 실패했습니다</p>
                        <p class="text-gray-500 mt-2">${error.message || '네트워크 오류가 발생했습니다'}</p>
                        <button onclick="loadInquiries()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            다시 시도
                        </button>
                    </div>
                </td>
            </tr>
        `;
    } finally {
        hideLoading();
    }
}

// 문의사항 목록 렌더링
function renderInquiryList() {
    const tbody = document.getElementById('inquiryList');
    if (!tbody) return;
    
    if (!inquiryData || inquiryData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                    문의사항이 없습니다.
                </td>
            </tr>
        `;
        return;
    }
    
    // 현재 로그인한 사용자 ID
    const userId = parseInt(sessionStorage.getItem('userId')) || 0;
    const isAdmin = sessionStorage.getItem('role') === 'admin';
    
    tbody.innerHTML = inquiryData.map((inquiry, index) => {
        // 비밀글 접근 권한 확인
        const canAccess = !inquiry.is_private || inquiry.user_id === userId || isAdmin;
        
        return `
            <tr class="${canAccess ? 'cursor-pointer hover:bg-gray-50' : ''}" 
                ${canAccess ? `onclick="viewInquiry(${inquiry.id})"` : ''}>
                <td class="px-6 py-4 whitespace-nowrap">${inquiry.id}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                        ${getCategoryClass(inquiry.category)}">
                        ${getCategoryText(inquiry.category)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${inquiry.is_private ? 
                        '<span class="w-2 h-2 bg-red-500 rounded-full inline-block mr-1"></span>' : 
                        ''}
                    ${canAccess ? 
                        inquiry.title : 
                        '<span class="text-gray-400">비밀글입니다</span>'}
                    ${inquiry.has_answer ? 
                        '<span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">답변완료</span>' : 
                        ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">${inquiry.author || '익명'}</td>
                <td class="px-6 py-4 whitespace-nowrap">${formatDate(inquiry.created_at)}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                        ${inquiry.has_answer ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                        ${inquiry.has_answer ? '답변완료' : '답변대기'}
                    </span>
                </td>
            </tr>
        `;
    }).join('');
}

// 문의사항 상세 보기
async function viewInquiry(inquiryId) {
    try {
        showLoading();
        
        // 문의사항 상세 정보 가져오기
        const response = await apiRequest(`/api/inquiries/${inquiryId}`);
        
        if (response.success) {
            const inquiry = response.data;
            currentInquiryId = inquiry.id;
            
            // 모달에 데이터 채우기
            document.getElementById('detailInquiryTitle').textContent = inquiry.title;
            document.getElementById('detailInquiryCategory').textContent = getCategoryText(inquiry.category);
            document.getElementById('detailInquiryCategory').className = `px-2 py-1 rounded-full text-xs font-medium ${getCategoryClass(inquiry.category, true)}`;
            document.getElementById('detailInquiryAuthor').textContent = inquiry.author || '익명';
            document.getElementById('detailInquiryDate').textContent = formatDate(inquiry.created_at);
            document.getElementById('detailInquiryContent').textContent = inquiry.content;
            
            // 첨부파일 표시
            const attachmentSection = document.getElementById('detailInquiryAttachment');
            if (inquiry.attachment_url) {
                document.getElementById('detailInquiryFileName').textContent = inquiry.attachment_name || '첨부파일';
                document.getElementById('detailInquiryFileLink').href = inquiry.attachment_url;
                attachmentSection.classList.remove('hidden');
            } else {
                attachmentSection.classList.add('hidden');
            }
            
            // 답변 표시
            if (inquiry.answer) {
                document.getElementById('inquiryNoAnswer').classList.add('hidden');
                document.getElementById('inquiryAnswerContent').classList.remove('hidden');
                document.getElementById('answerAuthor').textContent = inquiry.answer_author || '관리자';
                document.getElementById('answerDate').textContent = formatDate(inquiry.answer_date);
                document.getElementById('answerContent').textContent = inquiry.answer;
            } else {
                document.getElementById('inquiryNoAnswer').classList.remove('hidden');
                document.getElementById('inquiryAnswerContent').classList.add('hidden');
            }
            
            // 관리자인 경우 답변 입력 영역 표시
            const isAdmin = sessionStorage.getItem('role') === 'admin';
            document.getElementById('adminAnswerSection').classList.toggle('hidden', !isAdmin || inquiry.has_answer);
            
            // 작성자인 경우 수정/삭제 버튼 표시
            const userId = parseInt(sessionStorage.getItem('userId')) || 0;
            const isOwner = inquiry.user_id === userId;
            document.getElementById('inquiryOwnerActions').classList.toggle('hidden', !isOwner);
            
            // 모달 표시
            openModal('inquiryDetailModal');
        } else {
            showAlert('문의사항을 불러오는데 실패했습니다.', 'error');
        }
    } catch (error) {
        console.error('Inquiry detail loading error:', error);
        showAlert('문의사항을 불러오는데 실패했습니다.', 'error');
    } finally {
        hideLoading();
    }
}

// 카테고리 클래스 및 텍스트
function getCategoryClass(category, isDetail = false) {
    const baseClass = isDetail ? '' : 'bg-opacity-50 ';
    switch (category) {
        case 'program':
            return baseClass + 'bg-blue-100 text-blue-800';
        case 'reservation':
            return baseClass + 'bg-green-100 text-green-800';
        case 'other':
            return baseClass + 'bg-purple-100 text-purple-800';
        default:
            return baseClass + 'bg-gray-100 text-gray-800';
    }
}

function getCategoryText(category) {
    switch (category) {
        case 'program':
            return '프로그램 문의';
        case 'reservation':
            return '예약 문의';
        case 'other':
            return '기타 문의';
        default:
            return '기타';
    }
}

// 문의사항 작성 모달 표시
function showInquiryWriteModal() {
    // 로그인 확인
    if (!sessionStorage.getItem('token')) {
        showAlert('문의사항 작성은 로그인 후 이용 가능합니다.', 'error');
        return;
    }
    
    // 폼 초기화
    document.getElementById('inquiryWriteForm').reset();
    document.getElementById('inquirySelectedFileName').textContent = '선택된 파일 없음';
    document.getElementById('inquirySelectedFileName').className = 'text-sm text-gray-600';
    
    // 모달 표시
    openModal('inquiryWriteModal');
}

// 문의사항 작성 모달 닫기
function closeInquiryWriteModal() {
    console.log('문의사항 작성 모달 닫기');
    
    // 폼 초기화
    document.getElementById('inquiryWriteForm').reset();
    document.getElementById('inquirySelectedFileName').textContent = '선택된 파일 없음';
    document.getElementById('inquirySelectedFileName').className = 'text-sm text-gray-600';
    
    // 제출 플래그 초기화 (중요!)
    isSubmittingInquiry = false;
    
    // 모달 닫기
    closeModal('inquiryWriteModal');
}

// 문의사항 상세 모달 닫기
function closeInquiryDetailModal() {
    closeModal('inquiryDetailModal');
}

// 문의사항 작성 폼 제출
function initializeInquirySystem() {
    console.log('문의사항 시스템 초기화');
    
    // 기존 이벤트 핸들러 제거를 위해 폼 복제
    const inquiryForm = document.getElementById('inquiryWriteForm');
    if (inquiryForm) {
        const newForm = inquiryForm.cloneNode(true);
        inquiryForm.parentNode.replaceChild(newForm, inquiryForm);
        
        // 새 이벤트 핸들러 등록
        newForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation(); // 이벤트 버블링 방지
            
            console.log('문의사항 폼 제출 시작');
            
            // 이중 제출 방지
            if (isSubmittingInquiry) {
                console.log('이미 제출 중입니다');
                return;
            }
            isSubmittingInquiry = true;
            
            // 폼 버튼 비활성화
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = '처리 중...';
            }
            
            try {
                showLoading();
                
                const formData = new FormData();
                formData.append('category', document.getElementById('writeInquiryCategory').value);
                formData.append('title', document.getElementById('inquiryTitle').value);
                formData.append('content', document.getElementById('inquiryContent').value);
                formData.append('is_private', document.getElementById('inquiryIsPrivate').checked ? '1' : '0');
                
                // 첨부파일이 있는 경우 추가
                const fileInput = document.getElementById('inquiryFile');
                if (fileInput.files.length > 0) {
                    formData.append('attachment', fileInput.files[0]);
                }
                
                console.log('API 요청 전송');
                
                // API 요청
                const response = await fetch(`${API_BASE_URL}/api/inquiries`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                    },
                    body: formData
                });
                
                console.log('API 응답 수신');
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('문의사항이 등록되었습니다.', 'success');
                    closeInquiryWriteModal();
                    
                    // 현재 페이지에 따라 새로고침
                    if (document.getElementById('inquiryPage').classList.contains('hidden')) {
                        // 대시보드에서 작성한 경우
                        console.log('사용자 대시보드 문의사항 새로고침');
                        loadUserInquiries();
                    } else {
                        // 문의사항 페이지에서 작성한 경우
                        console.log('문의사항 페이지 목록 새로고침');
                        loadInquiries();
                    }
                } else {
                    throw new Error(data.message || '문의사항 등록에 실패했습니다.');
                }
            } catch (error) {
                console.error('Inquiry creation error:', error);
                showAlert(error.message || '문의사항 등록 중 오류가 발생했습니다.', 'error');
            } finally {
                hideLoading();
                isSubmittingInquiry = false; // 플래그 초기화
                
                // 버튼 상태 복원
                const submitButton = this.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = '문의하기';
                }
                
                console.log('문의사항 폼 제출 완료');
            }
        });
        
        console.log('문의사항 폼 이벤트 핸들러 재설정 완료');
    }
}

// 파일 선택 시 파일명 표시
document.getElementById('inquiryFile').addEventListener('change', function() {
    const fileNameSpan = document.getElementById('inquirySelectedFileName');
    if (this.files.length > 0) {
        const fileName = this.files[0].name;
        const fileSize = (this.files[0].size / 1024 / 1024).toFixed(2); // MB 단위
        fileNameSpan.textContent = `${fileName} (${fileSize}MB)`;
        fileNameSpan.classList.remove('text-gray-600');
        fileNameSpan.classList.add('text-blue-600');
    } else {
        fileNameSpan.textContent = '선택된 파일 없음';
        fileNameSpan.classList.remove('text-blue-600');
        fileNameSpan.classList.add('text-gray-600');
    }
});

// 관리자 답변 폼 제출
document.getElementById('inquiryAnswerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentInquiryId) {
        showAlert('문의사항 정보를 찾을 수 없습니다.', 'error');
        return;
    }
    
    const answerContent = document.getElementById('adminAnswerContent').value.trim();
    if (!answerContent) {
        showAlert('답변 내용을 입력해주세요.', 'error');
        return;
    }
    
    try {
        showLoading();
        
        const response = await apiRequest(`/api/admin/inquiries/${currentInquiryId}/answer`, {
            method: 'POST',
            body: JSON.stringify({ answer: answerContent })
        });
        
        if (response.success) {
            showAlert('답변이 등록되었습니다.', 'success');
            closeInquiryDetailModal();
            
            // 관리자 대시보드인 경우 목록 새로고침
            if (!document.getElementById('adminDashboard').classList.contains('hidden')) {
                loadAdminInquiries();
            } else {
                // 문의사항 페이지인 경우
                loadInquiries();
            }
        } else {
            throw new Error(response.message || '답변 등록에 실패했습니다.');
        }
    } catch (error) {
        console.error('Inquiry answer error:', error);
        showAlert(error.message || '답변 등록 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
});

// 문의사항 삭제
async function deleteInquiry() {
    if (!currentInquiryId) {
        showAlert('문의사항 정보를 찾을 수 없습니다.', 'error');
        return;
    }
    
    try {
        showLoading();
        
        const response = await apiRequest(`/api/inquiries/${currentInquiryId}`, {
            method: 'DELETE'
        });
        
        if (response.success) {
            showAlert('문의사항이 삭제되었습니다.', 'success');
            closeInquiryDetailModal();
            
            // 현재 페이지에 따라 새로고침
            if (!document.getElementById('userDashboard').classList.contains('hidden')) {
                // 사용자 대시보드인 경우
                loadUserInquiries();
            } else if (!document.getElementById('adminDashboard').classList.contains('hidden')) {
                // 관리자 대시보드인 경우
                loadAdminInquiries();
            } else {
                // 문의사항 페이지인 경우
                loadInquiries();
            }
        } else {
            throw new Error(response.message || '문의사항 삭제에 실패했습니다.');
        }
    } catch (error) {
        console.error('Inquiry deletion error:', error);
        showAlert(error.message || '문의사항 삭제 중 오류가 발생했습니다.', 'error');
    } finally {
        hideLoading();
    }
}

function deleteUserInquiry(inquiryId) {
    if (confirm('정말 이 문의사항을 삭제하시겠습니까?')) {
        currentInquiryId = inquiryId; // 현재 선택된 ID를 설정
        deleteInquiry(); // 기존의 deleteInquiry 함수 호출
    }
}

// 관리자 문의사항 삭제 함수
function deleteAdminInquiry(inquiryId) {
    if (confirm('정말 이 문의사항을 삭제하시겠습니까?')) {
        currentInquiryId = inquiryId; // 현재 선택된 ID를 설정
        deleteInquiry(); // 기존의 deleteInquiry 함수 호출
    }
}

// 사용자 대시보드: 내 문의사항 목록 로드
async function loadUserInquiries() {
    try {
        const response = await apiRequest('/api/user/inquiries');
        
        if (response.success) {
            userInquiries = response.data || [];
            
            const tbody = document.getElementById('userInquiriesList');
            if (!tbody) return;
            
            if (userInquiries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                            작성한 문의사항이 없습니다.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = userInquiries.map(inquiry => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            ${getCategoryClass(inquiry.category)}">
                            ${getCategoryText(inquiry.category)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${inquiry.is_private ? 
                            '<span class="w-2 h-2 bg-red-500 rounded-full inline-block mr-1"></span>' : 
                            ''}
                        <a href="javascript:viewInquiry(${inquiry.id})" class="text-indigo-600 hover:text-indigo-900">
                            ${inquiry.title}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(inquiry.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            ${inquiry.has_answer ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${inquiry.has_answer ? '답변완료' : '답변대기'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="viewInquiry(${inquiry.id})" 
                            class="text-indigo-600 hover:text-indigo-900 mr-3">
                            보기
                        </button>
                        <button onclick="deleteUserInquiry(${inquiry.id})" 
                            class="text-red-600 hover:text-red-900">
                            삭제
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            showAlert('문의사항을 불러오는데 실패했습니다.', 'error');
        }
    } catch (error) {
        console.error('User inquiries loading error:', error);
        document.getElementById('userInquiriesList').innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                    문의사항을 불러오는데 실패했습니다.
                </td>
            </tr>
        `;
    }
}

// 관리자 대시보드: 모든 문의사항 목록 로드
async function loadAdminInquiries() {
    try {
        // 필터 값 가져오기
        const statusFilter = document.getElementById('adminInquiryStatusFilter').value || 'all';
        const categoryFilter = document.getElementById('adminInquiryCategoryFilter').value || 'all';
        const searchTerm = document.getElementById('adminInquirySearch').value || '';
        
        const response = await apiRequest('/api/admin/inquiries', {
            method: 'POST',
            body: JSON.stringify({
                status: statusFilter,
                category: categoryFilter,
                search: searchTerm
            })
        });
        
        if (response.success) {
            adminInquiries = response.data || [];
            
            const tbody = document.getElementById('adminInquiriesList');
            if (!tbody) return;
            
            if (adminInquiries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-10 text-center text-gray-500">
                            등록된 문의사항이 없습니다.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = adminInquiries.map(inquiry => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">${inquiry.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            ${getCategoryClass(inquiry.category)}">
                            ${getCategoryText(inquiry.category)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${inquiry.is_private ? 
                            '<span class="w-2 h-2 bg-red-500 rounded-full inline-block mr-1"></span>' : 
                            ''}
                        <a href="javascript:viewInquiry(${inquiry.id})" class="text-indigo-600 hover:text-indigo-900">
                            ${inquiry.title}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${inquiry.author || '익명'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatDate(inquiry.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            ${inquiry.has_answer ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${inquiry.has_answer ? '답변완료' : '답변대기'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="viewInquiry(${inquiry.id})" 
                            class="text-indigo-600 hover:text-indigo-900 mr-3">
                            ${inquiry.has_answer ? '상세보기' : '답변하기'}
                        </button>
                        <button onclick="deleteAdminInquiry(${inquiry.id})" 
                            class="text-red-600 hover:text-red-900">
                            삭제
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            showAlert('문의사항을 불러오는데 실패했습니다.', 'error');
        }
    } catch (error) {
        console.error('Admin inquiries loading error:', error);
        document.getElementById('adminInquiriesList').innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-10 text-center text-gray-500">
                    문의사항을 불러오는데 실패했습니다.
                </td>
            </tr>
        `;
    }
}

// 사용자 & 관리자 대시보드 초기화 함수에 문의사항 로드 추가
const originalInitUserDashboard = window.initializeUserDashboard;
window.initializeUserDashboard = async function() {
    await originalInitUserDashboard.apply(this, arguments);
    // 사용자 문의사항 로드
    await loadUserInquiries();
};

const originalInitAdminDashboard = window.initializeAdminDashboard;
window.initializeAdminDashboard = async function() {
    await originalInitAdminDashboard.apply(this, arguments);
    // 관리자 문의사항 로드
    await loadAdminInquiries();
};

</script>
</body>
</html>
